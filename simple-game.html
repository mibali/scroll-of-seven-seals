<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Scroll of Seven Seals - Simple Version</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Uncial+Antiqua&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #2c1810, #4a3425, #6b4d37);
            color: #f4f1e8;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #d4af37;
        }
        
        .title {
            font-family: 'Uncial Antiqua', cursive;
            font-size: 2.5em;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
        }
        
        .game-mode {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .mode-card {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #8b7355;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .mode-card:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .mode-card h3 {
            color: #d4af37;
            margin-bottom: 10px;
        }
        
        .team-setup {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #8b7355;
            margin-bottom: 20px;
            display: none;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #d4af37;
            font-weight: 600;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #8b7355;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.3);
            color: #f4f1e8;
            font-family: 'Cinzel', serif;
        }
        
        .btn {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #2c1810;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background: linear-gradient(145deg, #e6c757, #d4af37);
            transform: translateY(-1px);
        }
        
        .game-info {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .timer {
            font-family: monospace;
            font-size: 1.5em;
            color: #d4af37;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #d4af37;
        }
        
        .progress {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid #8b7355;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #e6c757);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .seals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .seal {
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4));
            border: 2px solid #8b7355;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .seal:hover {
            border-color: #d4af37;
            transform: translateY(-2px);
        }
        
        .seal.completed {
            border-color: #228b22;
            background: linear-gradient(145deg, rgba(34, 139, 34, 0.3), rgba(34, 139, 34, 0.1));
        }
        
        .seal.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .seal-number {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: #d4af37;
            color: #2c1810;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .seal-title {
            font-size: 1.3em;
            color: #d4af37;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #2c1810, #4a3425);
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #d4af37;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            color: #d4af37;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .puzzle-area {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid #8b7355;
        }
        
        .draggable {
            background: #6b4d37;
            border: 1px solid #8b7355;
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            cursor: grab;
            display: inline-block;
        }
        
        .drop-zone {
            min-height: 100px;
            border: 2px dashed #8b7355;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .leaderboard {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #8b7355;
            margin-bottom: 20px;
            display: none;
        }
        
        .leaderboard h3 {
            color: #d4af37;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .team-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 3px solid #8b7355;
        }
        
        .team-entry.first { border-left-color: #ffd700; }
        .team-entry.second { border-left-color: #c0c0c0; }
        .team-entry.third { border-left-color: #cd7f32; }
        
        .final-challenge {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
            display: none;
        }
        
        .hidden {
            display: none;
        }
        
        .lobby-team {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #8b7355;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .lobby-team.host {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .team-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .team-status.ready {
            background: rgba(34, 139, 34, 0.3);
            color: #90ee90;
        }
        
        @media (max-width: 768px) {
            .game-mode {
                grid-template-columns: 1fr;
            }
            
            .game-info {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .title {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">üîÆ The Scroll of Seven Seals</h1>
            <p>A Bible Mystery Adventure Game</p>
        </div>

        <!-- Game Mode Selection -->
        <div id="modeSelection" class="game-mode">
            <div class="mode-card" onclick="selectMode('single')">
                <h3>üè† Single Group</h3>
                <p>Play as one team and beat your best time</p>
            </div>
            <div class="mode-card" onclick="selectMode('multi')">
                <h3>ü§ñ vs Computer Teams</h3>
                <p>Compete against AI opponents</p>
            </div>
            <div class="mode-card" onclick="selectMode('room')">
                <h3>üåê Create/Join Room</h3>
                <p>Real multiplayer with other teams</p>
            </div>
        </div>

        <!-- Team Setup -->
        <div id="teamSetup" class="team-setup">
            <h3 id="setupTitle">Team Setup</h3>
            <div class="input-group">
                <label for="teamName">Team Name:</label>
                <input type="text" id="teamName" placeholder="Enter your team name">
            </div>
            <div id="multiSetup" class="hidden">
                <div class="input-group">
                    <label for="numTeams">Number of Teams:</label>
                    <select id="numTeams">
                        <option value="2">2 teams</option>
                        <option value="3">3 teams</option>
                        <option value="4">4 teams</option>
                        <option value="5">5 teams</option>
                        <option value="6">6 teams</option>
                    </select>
                </div>
            </div>
            <div id="roomSetup" class="hidden">
                <div class="input-group">
                    <label>Choose an option:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 10px 0;">
                        <button class="btn" onclick="createRoom()">üèóÔ∏è Create Room</button>
                        <button class="btn" onclick="showJoinRoom()">üö™ Join Room</button>
                    </div>
                </div>
                <div id="joinRoomDiv" class="hidden">
                    <div class="input-group">
                        <label for="roomCode">Room Code:</label>
                        <input type="text" id="roomCode" placeholder="Enter 6-digit code" maxlength="6" style="text-transform: uppercase;">
                    </div>
                    <button class="btn" onclick="joinRoom()">Join Room</button>
                </div>
            </div>
            <button class="btn" onclick="startGame()">Start Adventure</button>
            <button class="btn" onclick="goBack()" style="background: #8b7355;">‚Üê Back</button>
        </div>

        <!-- Room Lobby -->
        <div id="roomLobby" class="hidden">
            <div class="header">
                <h2 id="lobbyTitle">Game Room</h2>
                <div id="roomInfo" style="margin-top: 15px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid #d4af37;">
                        <strong>Room Code: <span id="displayRoomCode" style="font-family: monospace; font-size: 1.2em; color: #d4af37;"></span></strong>
                        <button class="btn" onclick="copyRoomCode()" style="margin-left: 10px; padding: 5px 10px;">üìã Copy</button>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; border: 1px solid #8b7355;">
                <h3 style="color: #d4af37; text-align: center; margin-bottom: 20px;">
                    Teams in Lobby (<span id="teamCount">0</span>/6)
                </h3>
                <div id="lobbyTeams" style="display: grid; gap: 10px; margin-bottom: 20px;"></div>
                
                <div style="text-align: center; padding-top: 15px; border-top: 1px solid #8b7355;">
                    <div id="hostControls" class="hidden">
                        <button class="btn" id="startRoomGame" onclick="startRoomGame()" disabled>üöÄ Start Game</button>
                        <p style="margin: 10px 0; font-size: 0.9em; opacity: 0.8;">Need at least 2 teams to start</p>
                    </div>
                    <button class="btn" onclick="leaveRoom()" style="background: #dc3545;">üö™ Leave Room</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <!-- Game Info Bar -->
            <div class="game-info">
                <div>
                    <strong id="currentTeam">Team Name</strong>
                    <div id="gameMode">Single Group Mode</div>
                </div>
                <div class="timer" id="timer">00:00</div>
                <button class="btn" onclick="resetGame()" style="background: #dc3545;">Reset Game</button>
            </div>

            <!-- Leaderboard (Multi-team mode) -->
            <div id="leaderboard" class="leaderboard">
                <h3>üèÜ Live Leaderboard</h3>
                <div id="leaderboardContent"></div>
            </div>

            <!-- Progress Bar -->
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div style="text-align: center; margin: 10px 0;">
                <span id="progressText">0/7 Seals Broken</span>
            </div>

            <!-- Seals Grid -->
            <div class="seals-grid" id="sealsGrid"></div>

            <!-- Final Challenge -->
            <div id="finalChallenge" class="final-challenge">
                <h2>üéâ Final Challenge Complete!</h2>
                <div id="victoryMessage"></div>
                <button class="btn" onclick="resetGame()">Play Again</button>
            </div>
        </div>

        <!-- Puzzle Modal -->
        <div id="puzzleModal" class="modal">
            <div class="modal-content">
                <button class="close" onclick="closePuzzle()">&times;</button>
                <h2 id="puzzleTitle"></h2>
                <div id="puzzleContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" id="solvePuzzle" onclick="solvePuzzle()">Solve Puzzle</button>
                    <button class="btn" onclick="closePuzzle()" style="background: #8b7355;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            mode: '',
            currentTeam: '',
            teams: [],
            completedSeals: [],
            startTime: null,
            currentPuzzle: null,
            isGameActive: false,
            roomCode: '',
            isHost: false,
            roomUpdateInterval: null
        };

        // Seal Data
        const seals = [
            { id: 1, title: "The Garden Cipher", description: "Arrange Genesis creation events in order", unlock: [] },
            { id: 2, title: "The Blood Trail", description: "Answer questions about biblical sacrifices", unlock: [1] },
            { id: 3, title: "The Prophecy Scroll", description: "Match prophecies with fulfillments", unlock: [2] },
            { id: 4, title: "The Parable Labyrinth", description: "Navigate Jesus' teachings", unlock: [3] },
            { id: 5, title: "The Upper Room", description: "Solve the Last Supper mystery", unlock: [4] },
            { id: 6, title: "The Church Underground", description: "Decode apostolic messages", unlock: [5] },
            { id: 7, title: "The Apocalypse Map", description: "Interpret Revelation symbols", unlock: [6] }
        ];

        // Puzzles (simplified)
        const puzzles = {
            1: {
                type: "order",
                question: "Arrange these Genesis creation events in order:",
                items: ["God created light", "God separated waters", "God created land", "God created sun and moon", "God created sea creatures", "God created land animals", "God created humans"],
                answer: [0, 1, 2, 3, 4, 5, 6]
            },
            2: {
                type: "quiz",
                question: "What offering pleased God more than Cain's?",
                options: ["Abel's lamb", "Grain offering", "Burnt offering", "Peace offering"],
                answer: 0
            },
            3: {
                type: "quiz",
                question: "Where was the Messiah prophesied to be born?",
                options: ["Jerusalem", "Nazareth", "Bethlehem", "Capernaum"],
                answer: 2
            },
            4: {
                type: "quiz",
                question: "In the Parable of the Sower, what represents the Word of God?",
                options: ["The soil", "The seed", "The sower", "The birds"],
                answer: 1
            },
            5: {
                type: "quiz",
                question: "How many disciples were at the Last Supper?",
                options: ["11", "12", "13", "10"],
                answer: 1
            },
            6: {
                type: "quiz",
                question: "Which apostle wrote the most letters in the New Testament?",
                options: ["Peter", "John", "Paul", "James"],
                answer: 2
            },
            7: {
                type: "quiz",
                question: "How many churches received letters in Revelation?",
                options: ["5", "6", "7", "8"],
                answer: 2
            }
        };

        // Select game mode
        function selectMode(mode) {
            gameState.mode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('teamSetup').style.display = 'block';
            
            // Hide all setup sections first
            document.getElementById('multiSetup').classList.add('hidden');
            document.getElementById('roomSetup').classList.add('hidden');
            
            if (mode === 'single') {
                document.getElementById('setupTitle').textContent = 'Single Group Setup';
            } else if (mode === 'multi') {
                document.getElementById('setupTitle').textContent = 'vs Computer Teams Setup';
                document.getElementById('multiSetup').classList.remove('hidden');
            } else if (mode === 'room') {
                document.getElementById('setupTitle').textContent = 'Real Multiplayer Setup';
                document.getElementById('roomSetup').classList.remove('hidden');
            }
        }

        // Room functions
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function createRoom() {
            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Please enter a team name first');
                return;
            }

            const roomCode = generateRoomCode();
            gameState.roomCode = roomCode;
            gameState.isHost = true;
            gameState.currentTeam = teamName;

            // Create room in localStorage
            const roomData = {
                code: roomCode,
                host: teamName,
                teams: [{ name: teamName, isHost: true, joinTime: Date.now(), seals: 0, finished: false }],
                status: 'waiting', // waiting, playing, finished
                gameStarted: false,
                createdAt: Date.now()
            };

            localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
            
            showLobby();
        }

        function showJoinRoom() {
            document.getElementById('joinRoomDiv').classList.remove('hidden');
        }

        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            const teamName = document.getElementById('teamName').value.trim();
            
            if (!roomCode || !teamName) {
                alert('Please enter both room code and team name');
                return;
            }

            // Check if room exists
            const roomData = JSON.parse(localStorage.getItem(`room_${roomCode}`));
            if (!roomData) {
                alert('Room not found. Please check the room code.');
                return;
            }

            if (roomData.status !== 'waiting') {
                alert('This game has already started or finished.');
                return;
            }

            if (roomData.teams.length >= 6) {
                alert('This room is full (maximum 6 teams).');
                return;
            }

            // Check if team name already exists
            if (roomData.teams.some(team => team.name === teamName)) {
                alert('A team with this name already exists in the room.');
                return;
            }

            // Join the room
            gameState.roomCode = roomCode;
            gameState.isHost = false;
            gameState.currentTeam = teamName;

            roomData.teams.push({ 
                name: teamName, 
                isHost: false, 
                joinTime: Date.now(), 
                seals: 0, 
                finished: false 
            });

            localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
            
            showLobby();
        }

        function showLobby() {
            document.getElementById('teamSetup').style.display = 'none';
            document.getElementById('roomLobby').classList.remove('hidden');
            document.getElementById('displayRoomCode').textContent = gameState.roomCode;
            
            if (gameState.isHost) {
                document.getElementById('lobbyTitle').textContent = 'Game Room (Host)';
                document.getElementById('hostControls').classList.remove('hidden');
            } else {
                document.getElementById('lobbyTitle').textContent = 'Game Room';
                document.getElementById('hostControls').classList.add('hidden');
            }

            // Start monitoring room updates
            updateLobby();
            gameState.roomUpdateInterval = setInterval(updateLobby, 2000);
        }

        function updateLobby() {
            const roomData = JSON.parse(localStorage.getItem(`room_${gameState.roomCode}`));
            if (!roomData) {
                alert('Room no longer exists');
                leaveRoom();
                return;
            }

            // Check if game started
            if (roomData.gameStarted && !gameState.isGameActive) {
                startRoomGameplay();
                return;
            }

            // Update team count
            document.getElementById('teamCount').textContent = roomData.teams.length;

            // Update teams list
            let teamsHtml = '';
            roomData.teams.forEach(team => {
                const hostBadge = team.isHost ? ' üëë' : '';
                teamsHtml += `
                    <div class="lobby-team ${team.isHost ? 'host' : ''}">
                        <div>
                            <strong>${team.name}${hostBadge}</strong>
                            <div style="font-size: 0.9em; opacity: 0.7;">Joined ${new Date(team.joinTime).toLocaleTimeString()}</div>
                        </div>
                        <div class="team-status ready">Ready</div>
                    </div>
                `;
            });

            document.getElementById('lobbyTeams').innerHTML = teamsHtml;

            // Update start button for host
            if (gameState.isHost) {
                const startBtn = document.getElementById('startRoomGame');
                const canStart = roomData.teams.length >= 2;
                startBtn.disabled = !canStart;
                startBtn.textContent = canStart ? 'üöÄ Start Game' : 'üöÄ Start Game (Need 2+ teams)';
            }
        }

        function startRoomGame() {
            if (!gameState.isHost) return;

            const roomData = JSON.parse(localStorage.getItem(`room_${gameState.roomCode}`));
            roomData.gameStarted = true;
            roomData.status = 'playing';
            roomData.startTime = Date.now();
            
            localStorage.setItem(`room_${gameState.roomCode}`, JSON.stringify(roomData));
            
            startRoomGameplay();
        }

        function startRoomGameplay() {
            if (gameState.roomUpdateInterval) {
                clearInterval(gameState.roomUpdateInterval);
            }

            gameState.startTime = Date.now();
            gameState.isGameActive = true;
            gameState.mode = 'room';
            gameState.completedSeals = [];

            // Show game screen
            document.getElementById('roomLobby').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('currentTeam').textContent = gameState.currentTeam;
            document.getElementById('gameMode').textContent = 'Real Multiplayer Competition';
            document.getElementById('leaderboard').style.display = 'block';

            renderSeals();
            startTimer();
            
            // Start room game monitoring
            gameState.roomUpdateInterval = setInterval(updateRoomGame, 3000);
        }

        function updateRoomGame() {
            const roomData = JSON.parse(localStorage.getItem(`room_${gameState.roomCode}`));
            if (!roomData) return;

            // Update current team's progress
            const currentTeam = roomData.teams.find(team => team.name === gameState.currentTeam);
            if (currentTeam) {
                currentTeam.seals = gameState.completedSeals.length;
                currentTeam.time = Date.now() - gameState.startTime;
                currentTeam.finished = gameState.completedSeals.length === 7;
            }

            localStorage.setItem(`room_${gameState.roomCode}`, JSON.stringify(roomData));

            // Update leaderboard with real teams
            updateRoomLeaderboard(roomData.teams);
        }

        function updateRoomLeaderboard(teams) {
            // Sort teams by progress and time
            const sortedTeams = [...teams].sort((a, b) => {
                if (a.finished && !b.finished) return -1;
                if (!a.finished && b.finished) return 1;
                if (a.finished && b.finished) return a.time - b.time;
                return b.seals - a.seals || a.time - b.time;
            });

            let html = '';
            sortedTeams.forEach((team, index) => {
                const rank = index + 1;
                const timeStr = formatTime(team.time || 0);
                const statusClass = rank === 1 ? 'first' : rank === 2 ? 'second' : rank === 3 ? 'third' : '';
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                const status = team.finished ? '‚úÖ Finished' : `${team.seals}/7 seals`;
                const isCurrentTeam = team.name === gameState.currentTeam;
                
                html += `
                    <div class="team-entry ${statusClass}" style="${isCurrentTeam ? 'border: 2px solid #d4af37;' : ''}">
                        <div>
                            <strong>${medal} ${team.name}${isCurrentTeam ? ' (You)' : ''}</strong>
                            <div style="font-size: 0.9em; opacity: 0.8;">${status}</div>
                        </div>
                        <div style="text-align: right;">
                            <strong>${timeStr}</strong>
                        </div>
                    </div>
                `;
            });

            document.getElementById('leaderboardContent').innerHTML = html;
        }

        function leaveRoom() {
            if (gameState.roomUpdateInterval) {
                clearInterval(gameState.roomUpdateInterval);
            }

            // Remove team from room
            const roomData = JSON.parse(localStorage.getItem(`room_${gameState.roomCode}`));
            if (roomData) {
                roomData.teams = roomData.teams.filter(team => team.name !== gameState.currentTeam);
                
                if (roomData.teams.length === 0 || gameState.isHost) {
                    // Delete room if empty or host leaves
                    localStorage.removeItem(`room_${gameState.roomCode}`);
                } else {
                    // Make first remaining team the new host
                    roomData.teams[0].isHost = true;
                    roomData.host = roomData.teams[0].name;
                    localStorage.setItem(`room_${gameState.roomCode}`, JSON.stringify(roomData));
                }
            }

            // Reset to main menu
            document.getElementById('roomLobby').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('modeSelection').style.display = 'grid';
            document.getElementById('teamName').value = '';
            document.getElementById('roomCode').value = '';
            document.getElementById('joinRoomDiv').classList.add('hidden');
            
            gameState = { 
                mode: '', 
                currentTeam: '', 
                teams: [], 
                completedSeals: [], 
                startTime: null, 
                currentPuzzle: null, 
                isGameActive: false,
                roomCode: '',
                isHost: false,
                roomUpdateInterval: null
            };
        }

        function copyRoomCode() {
            const roomCode = gameState.roomCode;
            navigator.clipboard.writeText(roomCode).then(() => {
                alert(`Room code ${roomCode} copied to clipboard!`);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = roomCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`Room code ${roomCode} copied to clipboard!`);
            });
        }

        // Go back to mode selection
        function goBack() {
            document.getElementById('modeSelection').style.display = 'grid';
            document.getElementById('teamSetup').style.display = 'none';
            document.getElementById('joinRoomDiv').classList.add('hidden');
            gameState = { 
                mode: '', 
                currentTeam: '', 
                teams: [], 
                completedSeals: [], 
                startTime: null, 
                currentPuzzle: null, 
                isGameActive: false,
                roomCode: '',
                isHost: false,
                roomUpdateInterval: null
            };
        }

        // Start the game
        function startGame() {
            if (gameState.mode === 'room') {
                alert('Please use Create Room or Join Room for multiplayer games');
                return;
            }

            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Please enter a team name');
                return;
            }

            gameState.currentTeam = teamName;
            gameState.startTime = Date.now();
            gameState.isGameActive = true;
            gameState.completedSeals = [];

            if (gameState.mode === 'multi') {
                const numTeams = parseInt(document.getElementById('numTeams').value);
                gameState.teams = [{ name: teamName, seals: 0, time: 0, finished: false }];
                
                // Add other teams (simulated)
                for (let i = 2; i <= numTeams; i++) {
                    gameState.teams.push({
                        name: `Team ${i}`,
                        seals: 0,
                        time: 0,
                        finished: false
                    });
                }
                
                // Start AI teams (simulated progress)
                startAITeams();
            }

            // Show game screen
            document.getElementById('teamSetup').style.display = 'none';
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('currentTeam').textContent = teamName;
            document.getElementById('gameMode').textContent = gameState.mode === 'single' ? 'Single Group Mode' : 'vs Computer Teams';
            
            if (gameState.mode === 'multi') {
                document.getElementById('leaderboard').style.display = 'block';
                updateLeaderboard();
            }

            renderSeals();
            startTimer();
        }

        // Start AI teams (simulated)
        function startAITeams() {
            if (gameState.mode !== 'multi') return;
            
            gameState.teams.slice(1).forEach((team, index) => {
                // Random progress for other teams
                const delay = Math.random() * 30000 + 15000; // 15-45 seconds per seal
                
                function simulateProgress() {
                    if (!gameState.isGameActive || team.finished) return;
                    
                    if (team.seals < 7) {
                        team.seals++;
                        team.time = Date.now() - gameState.startTime;
                        
                        if (team.seals === 7) {
                            team.finished = true;
                            team.time += Math.random() * 60000; // Random final challenge time
                        }
                        
                        updateLeaderboard();
                        
                        if (team.seals < 7) {
                            setTimeout(simulateProgress, delay + Math.random() * 20000);
                        }
                    }
                }
                
                setTimeout(simulateProgress, delay + index * 5000);
            });
        }

        // Update leaderboard
        function updateLeaderboard() {
            if (gameState.mode === 'room') {
                // Room mode uses updateRoomGame instead
                return;
            }
            
            if (gameState.mode !== 'multi') return;

            // Update current team
            const currentTeam = gameState.teams[0];
            currentTeam.seals = gameState.completedSeals.length;
            currentTeam.time = Date.now() - gameState.startTime;
            currentTeam.finished = gameState.completedSeals.length === 7;

            // Sort teams
            const sortedTeams = [...gameState.teams].sort((a, b) => {
                if (a.finished && !b.finished) return -1;
                if (!a.finished && b.finished) return 1;
                if (a.finished && b.finished) return a.time - b.time;
                return b.seals - a.seals || a.time - b.time;
            });

            let html = '';
            sortedTeams.forEach((team, index) => {
                const rank = index + 1;
                const timeStr = formatTime(team.time);
                const statusClass = rank === 1 ? 'first' : rank === 2 ? 'second' : rank === 3 ? 'third' : '';
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                const status = team.finished ? '‚úÖ Finished' : `${team.seals}/7 seals`;
                
                html += `
                    <div class="team-entry ${statusClass}">
                        <div>
                            <strong>${medal} ${team.name}</strong>
                            <div style="font-size: 0.9em; opacity: 0.8;">${status}</div>
                        </div>
                        <div style="text-align: right;">
                            <strong>${timeStr}</strong>
                        </div>
                    </div>
                `;
            });

            document.getElementById('leaderboardContent').innerHTML = html;
        }

        // Render seals
        function renderSeals() {
            let html = '';
            
            seals.forEach(seal => {
                const completed = gameState.completedSeals.includes(seal.id);
                const canOpen = seal.unlock.every(req => gameState.completedSeals.includes(req));
                const locked = !canOpen && !completed;
                
                let statusClass = '';
                if (completed) statusClass = 'completed';
                else if (locked) statusClass = 'locked';
                
                html += `
                    <div class="seal ${statusClass}" onclick="${locked ? '' : `openPuzzle(${seal.id})`}">
                        <div class="seal-number">${seal.id}</div>
                        <div class="seal-title">${seal.title}</div>
                        <p>${seal.description}</p>
                        ${completed ? '<div style="color: #228b22; margin-top: 10px;">‚úÖ Completed</div>' : ''}
                        ${locked ? '<div style="color: #dc3545; margin-top: 10px;">üîí Locked</div>' : ''}
                    </div>
                `;
            });
            
            document.getElementById('sealsGrid').innerHTML = html;
            updateProgress();
        }

        // Open puzzle
        function openPuzzle(sealId) {
            gameState.currentPuzzle = sealId;
            const puzzle = puzzles[sealId];
            const seal = seals.find(s => s.id === sealId);
            
            document.getElementById('puzzleTitle').textContent = `Seal ${sealId}: ${seal.title}`;
            
            let content = `<div class="puzzle-area">`;
            content += `<p><strong>${puzzle.question}</strong></p>`;
            
            if (puzzle.type === 'order') {
                content += `<p>Drag items to reorder them:</p>`;
                content += `<div class="drop-zone" id="dropZone">Drop items here in correct order</div>`;
                content += `<div>`;
                puzzle.items.forEach((item, index) => {
                    content += `<div class="draggable" draggable="true" data-index="${index}">${item}</div>`;
                });
                content += `</div>`;
            } else if (puzzle.type === 'quiz') {
                puzzle.options.forEach((option, index) => {
                    content += `<div style="margin: 10px 0;"><label><input type="radio" name="answer" value="${index}"> ${option}</label></div>`;
                });
            }
            
            content += `</div>`;
            document.getElementById('puzzleContent').innerHTML = content;
            document.getElementById('puzzleModal').style.display = 'block';
            
            // Add drag and drop for ordering puzzles
            if (puzzle.type === 'order') {
                setupDragAndDrop();
            }
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const draggables = document.querySelectorAll('.draggable');
            const dropZone = document.getElementById('dropZone');
            let draggedElement = null;

            draggables.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedElement = e.target;
                    e.target.style.opacity = '0.5';
                });

                item.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '1';
                });
            });

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedElement) {
                    dropZone.appendChild(draggedElement);
                    draggedElement = null;
                }
            });
        }

        // Solve puzzle
        function solvePuzzle() {
            const puzzle = puzzles[gameState.currentPuzzle];
            let correct = false;

            if (puzzle.type === 'quiz') {
                const selected = document.querySelector('input[name="answer"]:checked');
                if (selected && parseInt(selected.value) === puzzle.answer) {
                    correct = true;
                }
            } else if (puzzle.type === 'order') {
                const dropZone = document.getElementById('dropZone');
                const items = Array.from(dropZone.children);
                if (items.length === puzzle.items.length) {
                    const order = items.map(item => parseInt(item.dataset.index));
                    correct = JSON.stringify(order) === JSON.stringify(puzzle.answer);
                }
            }

            if (correct) {
                gameState.completedSeals.push(gameState.currentPuzzle);
                alert(`üéâ Seal ${gameState.currentPuzzle} completed!`);
                closePuzzle();
                renderSeals();
                
                if (gameState.mode === 'multi') {
                    updateLeaderboard();
                } else if (gameState.mode === 'room') {
                    updateRoomGame();
                }
                
                // Check if all seals completed
                if (gameState.completedSeals.length === 7) {
                    finishGame();
                }
            } else {
                alert('‚ùå Not quite right. Try again!');
            }
        }

        // Close puzzle
        function closePuzzle() {
            document.getElementById('puzzleModal').style.display = 'none';
            gameState.currentPuzzle = null;
        }

        // Finish game
        function finishGame() {
            gameState.isGameActive = false;
            const completionTime = Date.now() - gameState.startTime;
            const timeStr = formatTime(completionTime);
            
            let message = `<h3>üèÜ Congratulations!</h3>`;
            message += `<p><strong>Completion Time: ${timeStr}</strong></p>`;
            
            if (gameState.mode === 'multi') {
                const currentTeam = gameState.teams[0];
                currentTeam.finished = true;
                currentTeam.time = completionTime;
                updateLeaderboard();
                
                const rank = gameState.teams.filter(t => t.finished && t.time < completionTime).length + 1;
                const medal = rank === 1 ? 'ü•á First Place!' : rank === 2 ? 'ü•à Second Place!' : rank === 3 ? 'ü•â Third Place!' : `#${rank} Place`;
                message += `<p><strong>${medal}</strong></p>`;
            } else if (gameState.mode === 'room') {
                // Get final ranking from room data
                const roomData = JSON.parse(localStorage.getItem(`room_${gameState.roomCode}`));
                if (roomData) {
                    const finishedTeams = roomData.teams.filter(t => t.finished);
                    const rank = finishedTeams.filter(t => t.time < completionTime).length + 1;
                    const medal = rank === 1 ? 'ü•á First Place!' : rank === 2 ? 'ü•à Second Place!' : rank === 3 ? 'ü•â Third Place!' : `#${rank} Place`;
                    message += `<p><strong>${medal}</strong></p>`;
                    message += `<p>Out of ${roomData.teams.length} teams</p>`;
                }
            }
            
            document.getElementById('victoryMessage').innerHTML = message;
            document.getElementById('finalChallenge').style.display = 'block';
        }

        // Update progress bar
        function updateProgress() {
            const progress = (gameState.completedSeals.length / 7) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${gameState.completedSeals.length}/7 Seals Broken`;
        }

        // Timer functions
        function startTimer() {
            const timerElement = document.getElementById('timer');
            
            function updateTimer() {
                if (!gameState.isGameActive) return;
                
                const elapsed = Date.now() - gameState.startTime;
                timerElement.textContent = formatTime(elapsed);
                
                if (gameState.mode === 'multi') {
                    updateLeaderboard();
                }
                
                setTimeout(updateTimer, 1000);
            }
            
            updateTimer();
        }

        // Format time
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Reset game
        function resetGame() {
            if (confirm('Are you sure you want to reset the game?')) {
                // Clean up room if in room mode
                if (gameState.mode === 'room') {
                    leaveRoom();
                } else {
                    // Clean up intervals
                    if (gameState.roomUpdateInterval) {
                        clearInterval(gameState.roomUpdateInterval);
                    }
                    
                    document.getElementById('gameScreen').classList.add('hidden');
                    document.getElementById('finalChallenge').style.display = 'none';
                    document.getElementById('modeSelection').style.display = 'grid';
                    document.getElementById('teamName').value = '';
                    gameState = { 
                        mode: '', 
                        currentTeam: '', 
                        teams: [], 
                        completedSeals: [], 
                        startTime: null, 
                        currentPuzzle: null, 
                        isGameActive: false,
                        roomCode: '',
                        isHost: false,
                        roomUpdateInterval: null
                    };
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('puzzleModal');
            if (event.target === modal) {
                closePuzzle();
            }
        }
    </script>
</body>
</html>

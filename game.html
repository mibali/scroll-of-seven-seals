<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Scroll of Seven Seals - ULTIMATE FIXED v1.6.0</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <!-- CORE GAME SYSTEM -->
    <script src="js/game-data.js"></script>
    <script src="js/puzzles.js"></script>
    <script src="js/game.js"></script>
    <script src="js/multiplayer.js"></script>
    <script src="js/leaderboard.js"></script>
    
    <!-- ENHANCED GAME SYSTEM - Unique Content & Age Adaptation -->
    <script src="js/security-utils.js"></script>
    <script src="js/dynamic-engine.js"></script>
    <script src="js/unique-content-engine.js"></script>
    <script src="js/enhanced-puzzle-manager.js"></script>
    <script src="js/flexible-answer-engine.js"></script>
    <script src="js/learning-journey-manager.js"></script>
    <script src="js/immersion-engine.js"></script>
    <script src="js/worship-audio.js"></script>
    <script src="js/game-integration.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="enhanced-styles.css">
    <link rel="stylesheet" href="age-adaptive-styles.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cinzel': ['Cinzel', 'serif'],
                        'uncial': ['Uncial Antiqua', 'cursive'],
                        'inter': ['Inter', 'sans-serif']
                    },
                    colors: {
                        'midnight': {
                            50: '#fffef7',
                            100: '#fefcf0',
                            200: '#fef7de',
                            300: '#fdf0c4',
                            400: '#fce7a6',
                            500: '#fad97e',
                            600: '#f7c455',
                            700: '#efaa44',
                            800: '#d4884a',
                            900: '#b8692e',
                            950: '#7a3f1a'
                        },
                        'cosmic': {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                            950: '#451a03'
                        },
                        'mystic-gold': {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                            950: '#451a03'
                        }
                    },
                    backgroundImage: {
                        'cosmic-void': 'linear-gradient(135deg, #451a03 0%, #78350f 25%, #92400e 50%, #b45309 75%, #451a03 100%)',
                        'stellar-field': 'radial-gradient(circle at 25% 25%, rgba(251, 191, 36, 0.15) 0%, transparent 50%), radial-gradient(circle at 75% 75%, rgba(245, 158, 11, 0.1) 0%, transparent 50%)',
                        'gold-mystique': 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 25%, #d97706 50%, #b45309 75%, #92400e 100%)',
                        'glass-morphism': 'linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%)',
                        'card-glow': 'linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%)'
                    },
                    boxShadow: {
                        'golden-glow': '0 0 20px rgba(251, 191, 36, 0.4), 0 0 40px rgba(245, 158, 11, 0.2)',
                        'cosmic-glow': '0 0 30px rgba(251, 191, 36, 0.3), 0 0 60px rgba(245, 158, 11, 0.15)',
                        'mystic-aura': '0 0 25px rgba(251, 191, 36, 0.5), inset 0 1px 0 rgba(251, 191, 36, 0.2)'
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'twinkle': 'twinkle 4s ease-in-out infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        },
                        twinkle: {
                            '0%, 100%': { opacity: '0.3', transform: 'scale(1)' },
                            '50%': { opacity: '1', transform: 'scale(1.2)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Uncial+Antiqua&family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Mystical Futuristic Custom Styles */
        .room-input-section {
            display: none;
        }
        .room-input-section.active {
            display: block;
        }
        .connecting {
            opacity: 1;
        }
        .connected {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.8)) !important;
            border-color: rgba(34, 197, 94, 0.6) !important;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4) !important;
        }
        .error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.8)) !important;
            border-color: rgba(239, 68, 68, 0.6) !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4) !important;
        }
        
        /* Enhanced glowing scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at top, rgba(184, 134, 11, 0.1) 0%, transparent 70%),
                radial-gradient(ellipse at bottom, rgba(139, 69, 19, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: 
                linear-gradient(145deg, rgba(139, 69, 19, 0.4) 0%, rgba(160, 82, 45, 0.3) 50%, rgba(184, 134, 11, 0.4) 100%),
                linear-gradient(45deg, rgba(25, 25, 112, 0.1) 0%, transparent 100%);
            backdrop-filter: blur(15px);
            padding: 50px 40px;
            border-radius: 20px;
            border: 3px solid;
            border-image: linear-gradient(45deg, #b8860b, #daa520, #cd853f, #b8860b) 1;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 8px 20px rgba(184, 134, 11, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.1),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(218, 165, 32, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(184, 134, 11, 0.1) 0%, transparent 50%);
            z-index: 1;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #b8860b, #daa520, #cd853f, #b8860b);
            border-radius: 20px;
            z-index: -1;
        }

        .title {
            font-family: 'Uncial Antiqua', cursive;
            font-size: 3.8em;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 25%, #daa520 50%, #b8860b 75%, #ffd700 100%);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-shadow: 
                0 0 30px rgba(255, 215, 0, 0.5),
                0 0 60px rgba(218, 165, 32, 0.3);
            filter: 
                drop-shadow(0 4px 8px rgba(0, 0, 0, 0.6))
                drop-shadow(0 8px 16px rgba(184, 134, 11, 0.4));
            animation: titleGlow 6s ease-in-out infinite;
            position: relative;
            z-index: 2;
            letter-spacing: 2px;
        }

        @keyframes titleGlow {
            0%, 100% { 
                background-position: 0% 50%;
                filter: 
                    drop-shadow(0 4px 8px rgba(0, 0, 0, 0.6))
                    drop-shadow(0 8px 16px rgba(184, 134, 11, 0.4));
            }
            33% { 
                background-position: 50% 50%;
                filter: 
                    drop-shadow(0 6px 12px rgba(0, 0, 0, 0.7))
                    drop-shadow(0 12px 24px rgba(218, 165, 32, 0.5));
            }
            66% { 
                background-position: 100% 50%;
                filter: 
                    drop-shadow(0 8px 16px rgba(0, 0, 0, 0.8))
                    drop-shadow(0 16px 32px rgba(255, 215, 0, 0.6));
            }
        }

        .subtitle {
            font-size: 1.5em;
            color: #f5deb3;
            font-weight: 400;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.8),
                0 4px 8px rgba(139, 69, 19, 0.5);
            position: relative;
            z-index: 2;
            letter-spacing: 1px;
            line-height: 1.4;
        }

        .info-box {
            background: 
                linear-gradient(145deg, rgba(25, 25, 112, 0.2) 0%, rgba(70, 130, 180, 0.15) 50%, rgba(100, 149, 237, 0.2) 100%);
            backdrop-filter: blur(10px);
            border: 2px solid;
            border-image: linear-gradient(45deg, #4169e1, #6495ed, #87ceeb, #4169e1) 1;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 35px;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                0 4px 10px rgba(65, 105, 225, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .info-title {
            color: #4a90e2;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-list {
            list-style: none;
            padding-left: 20px;
        }

        .info-list li {
            margin-bottom: 8px;
            color: #e0d0c0;
        }

        .game-mode {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: 
                linear-gradient(145deg, rgba(139, 69, 19, 0.3) 0%, rgba(160, 82, 45, 0.2) 50%, rgba(184, 134, 11, 0.3) 100%),
                linear-gradient(45deg, rgba(25, 25, 112, 0.05) 0%, transparent 100%);
            backdrop-filter: blur(10px);
            border: 2px solid;
            border-image: linear-gradient(45deg, #8b4513, #cd853f, #daa520, #8b4513) 1;
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 5px 15px rgba(139, 69, 19, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.1),
                inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 30%, rgba(218, 165, 32, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(184, 134, 11, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mode-card:hover::before {
            opacity: 1;
        }

        .mode-card:hover {
            background: 
                linear-gradient(145deg, rgba(139, 69, 19, 0.5) 0%, rgba(160, 82, 45, 0.4) 50%, rgba(184, 134, 11, 0.5) 100%),
                linear-gradient(45deg, rgba(25, 25, 112, 0.1) 0%, transparent 100%);
            border-image: linear-gradient(45deg, #daa520, #ffd700, #ffed4e, #daa520) 1;
            transform: translateY(-15px) scale(1.05);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.6),
                0 10px 25px rgba(218, 165, 32, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.2),
                inset 0 -2px 0 rgba(0, 0, 0, 0.1);
        }

        .mode-card.selected {
            background: rgba(212, 175, 55, 0.2);
            border-color: #f4e876;
        }

        .mode-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            display: block;
        }

        .mode-title {
            font-size: 1.6em;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700, #daa520, #b8860b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }

        .mode-description {
            color: #f5deb3;
            font-size: 1em;
            line-height: 1.5;
            font-weight: 400;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
        }

        .multiplayer-setup {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .setup-title {
            color: #d4af37;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .team-input {
            margin-bottom: 20px;
        }

        .team-input label {
            display: block;
            color: #b8a082;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .team-input input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #6b4d37;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1f2937 !important;
            font-family: inherit;
        }

        .team-input input:focus {
            outline: none;
            border-color: #d4af37;
            background: rgba(255, 255, 255, 0.98) !important;
            color: #1f2937 !important;
        }

        .room-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .room-option {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .room-option:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }

        .room-option-title {
            color: #d4af37;
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .room-option-desc {
            color: #b8a082;
            font-size: 0.9em;
        }

        .room-input-section {
            margin-bottom: 20px;
            display: none;
        }

        .room-input-section.active {
            display: block;
        }

        .complexity-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .complexity-content {
            background: linear-gradient(135deg, #2c1810, #4a3425);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .complexity-title {
            color: #d4af37;
            font-family: 'Uncial Antiqua', cursive;
            font-size: 2.2em;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .complexity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .complexity-card {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #6b4d37;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .complexity-card:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-5px);
        }

        .complexity-card.selected {
            border-color: #f4e876;
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        .complexity-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .complexity-name {
            color: #d4af37;
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .complexity-description {
            color: #ffffff;
            font-size: 0.95em;
            line-height: 1.5;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .complexity-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .complexity-features li {
            color: #ffffff;
            font-size: 0.85em;
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .complexity-features li:before {
            content: "✓";
            color: #d4af37;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .complexity-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .room-code-display {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .room-code {
            font-size: 1.5em;
            color: #4a90e2;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .share-link {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #6b4d37;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9em;
            color: #b8a082;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .button {
            background: linear-gradient(135deg, #d4af37, #b8941f);
            color: #2c1810;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .button:hover {
            background: linear-gradient(135deg, #f4e876, #d4af37);
            transform: translateY(-2px);
        }

        .button.secondary {
            background: rgba(108, 77, 55, 0.8);
            color: #f4f1e8;
            border: 2px solid #6b4d37;
        }

        .button.secondary:hover {
            background: rgba(108, 77, 55, 1);
            border-color: #8b6d47;
        }

        .lobby {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #4a90e2;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .lobby-title {
            color: #4a90e2;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .teams-list {
            margin-bottom: 20px;
        }

        .team-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #6b4d37;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-name {
            color: #d4af37;
            font-weight: 600;
        }

        .team-status {
            color: #4a90e2;
            font-size: 0.9em;
        }

        .game-container {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .game-options {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #6b4d37;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .option-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #b8a082;
            font-size: 0.9em;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #6b4d37;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #f4f1e8;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #d4af37;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .option-description {
            font-size: 0.8em;
            color: #8b7355;
            margin-left: 5px;
        }

        /* Drag and Drop Styles */
        .drag-drop-container {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #6b4d37;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .drag-item {
            background: linear-gradient(135deg, #4a3425, #6b4d37);
            border: 2px solid #d4af37;
            border-radius: 8px;
            padding: 15px;
            margin: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            color: #f4f1e8;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .drag-item:hover {
            background: linear-gradient(135deg, #6b4d37, #8b6d47);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
        }

        .drag-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .drop-zone {
            min-height: 60px;
            background: rgba(0, 0, 0, 0.2);
            border: 2px dashed #6b4d37;
            border-radius: 8px;
            margin: 5px 0;
            padding: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b7355;
        }

        .drop-zone.drag-over {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }

        .drop-zone.filled {
            border-style: solid;
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.15);
        }

        .chronology-timeline {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .scripture-topics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .topic-section {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #6b4d37;
            border-radius: 10px;
            padding: 15px;
        }

        .topic-title {
            color: #d4af37;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .items-pool {
            background: rgba(212, 175, 55, 0.05);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .pool-title {
            color: #d4af37;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .timer {
            font-size: 1.5em;
            color: #d4af37;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #d4af37;
        }

        .progress-container {
            flex: 1;
            min-width: 200px;
        }

        .progress-label {
            color: #b8a082;
            margin-bottom: 8px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 2px solid #6b4d37;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #f4e876);
            width: 0%;
            transition: width 0.3s ease;
        }

        .seals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .seal {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8b0000;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .seal:hover {
            border-color: #d4af37;
            transform: translateY(-5px);
        }

        .seal.opened {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .seal-number {
            font-size: 3em;
            color: #8b0000;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px auto;
            border: 2px solid #8b0000;
        }

        .seal.opened .seal-number {
            color: #d4af37;
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.2);
        }

        .seal-title {
            color: #f4f1e8;
            font-weight: 600;
        }

        .leaderboard {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 20px;
        }

        .leaderboard-title {
            color: #d4af37;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .leaderboard-rank {
            color: #d4af37;
            font-weight: bold;
            width: 30px;
        }

        .leaderboard-name {
            flex: 1;
            color: #f4f1e8;
        }

        .leaderboard-score {
            color: #4a90e2;
            font-weight: 600;
        }

        .puzzle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .puzzle-content {
            background: linear-gradient(135deg, #2c1810, #4a3425);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 30px;
            max-width: 95vw;
            width: 95vw;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            box-sizing: border-box;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .puzzle-content {
                padding: 20px;
                max-width: 98vw;
                width: 98vw;
                max-height: 98vh;
                border-radius: 15px;
                margin: 1vh auto;
            }
            
            .modal-header {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .puzzle-title {
                font-size: 1.4em;
                text-align: center;
            }
            
            .close-button {
                align-self: flex-end;
                width: 40px;
                height: 40px;
                font-size: 1.3em;
            }
        }

        /* Enhanced scrolling for chronological challenges */
        .chronology-timeline {
            max-height: 60vh;
            overflow-y: auto;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            min-height: 200px;
        }

        .chronology-events {
            max-height: 40vh;
            overflow-y: auto;
            border: 2px solid #8b6914;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            background: rgba(139, 105, 20, 0.2);
            min-height: 150px;
        }

        /* Mobile improvements for drag and drop */
        @media (max-width: 768px) {
            .chronology-timeline,
            .chronology-events {
                max-height: 35vh;
                min-height: 120px;
                padding: 10px;
                margin: 10px 0;
            }
            
            .draggable-item {
                padding: 15px !important;
                margin: 8px 0 !important;
                font-size: 0.9em !important;
                touch-action: none;
                cursor: grab;
            }
            
            .draggable-item:active {
                cursor: grabbing;
            }
            
            .drop-zone {
                min-height: 60px !important;
                padding: 12px !important;
                margin: 5px 0 !important;
            }
            
            .challenge-controls {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }
            
            .btn {
                width: 100%;
                padding: 15px;
                font-size: 1.1em;
            }
        }

        /* Improved scrollbar styling for drag areas */
        .chronology-timeline::-webkit-scrollbar,
        .chronology-events::-webkit-scrollbar {
            width: 8px;
        }

        .chronology-timeline::-webkit-scrollbar-track,
        .chronology-events::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .chronology-timeline::-webkit-scrollbar-thumb,
        .chronology-events::-webkit-scrollbar-thumb {
            background: #d4af37;
            border-radius: 4px;
        }

        .chronology-timeline::-webkit-scrollbar-thumb:hover,
        .chronology-events::-webkit-scrollbar-thumb:hover {
            background: #f4e876;
        }

        /* Visual hint for scrollable areas */
        .chronology-timeline::before,
        .chronology-events::before {
            content: "📜 Scroll to see all items";
            display: block;
            text-align: center;
            color: #d4af37;
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        /* Spiritual Footer Styles */
        .spiritual-footer {
            background: linear-gradient(135deg, #1a1a1a, #2c1810);
            border-top: 3px solid #d4af37;
            padding: 30px 20px;
            margin-top: 50px;
            min-height: 200px;
        }

        .inspiration-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 300px;
            gap: 30px;
            align-items: start;
        }

        .scripture-motivation,
        .ministerial-wisdom {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .scripture-motivation:hover,
        .ministerial-wisdom:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: rgba(212, 175, 55, 0.5);
            transform: translateY(-2px);
        }

        .scripture-text,
        .wisdom-text {
            color: #f4f1e8;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
            font-style: italic;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .scripture-reference,
        .wisdom-attribution {
            color: #d4af37;
            font-weight: bold;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .worship-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .worship-btn {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #1a1a1a;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .worship-btn:hover {
            background: linear-gradient(145deg, #f4e876, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .worship-btn.playing {
            background: linear-gradient(145deg, #28a745, #20a83a);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
            50% { box-shadow: 0 6px 25px rgba(40, 167, 69, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
        }

        .now-playing {
            background: rgba(0, 0, 0, 0.4);
            color: #d4af37;
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            text-align: center;
            font-size: 0.9em;
            animation: nowPlayingGlow 3s ease-in-out infinite;
        }

        @keyframes nowPlayingGlow {
            0% { border-color: rgba(212, 175, 55, 0.3); }
            50% { border-color: rgba(212, 175, 55, 0.7); }
            100% { border-color: rgba(212, 175, 55, 0.3); }
        }

        /* Responsive design for spiritual footer */
        @media (max-width: 768px) {
            .inspiration-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .scripture-motivation,
            .ministerial-wisdom {
                padding: 20px;
            }
            
            .scripture-text,
            .wisdom-text {
                font-size: 1em;
            }

            /* Mobile game layout improvements */
            .seals-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
                padding: 15px !important;
            }

            .seal {
                min-height: 120px !important;
                padding: 15px 10px !important;
                font-size: 0.9em !important;
            }

            .game-options {
                flex-direction: column !important;
                gap: 15px !important;
                padding: 20px !important;
            }

            .option-toggle {
                flex-direction: column !important;
                align-items: stretch !important;
                text-align: center !important;
                gap: 10px !important;
            }

            .progress-container {
                flex-direction: column !important;
                gap: 10px !important;
                text-align: center !important;
            }

            .timer {
                font-size: 1.5em !important;
                margin-bottom: 15px !important;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-button {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }

        .puzzle-title {
            color: #d4af37;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .puzzle-question {
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .puzzle-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #6b4d37;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #f4f1e8;
            font-family: inherit;
            margin-bottom: 20px;
        }

        .puzzle-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .puzzle-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .alert.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .alert.error {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .alert.show {
            opacity: 1;
            transform: translateX(0);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0.8;
        }

        .connected {
            background: rgba(34, 139, 34, 0.8);
            color: white;
        }

        .disconnected {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }

        .connecting {
            background: rgba(255, 193, 7, 0.8);
            color: black;
        }

        @media (max-width: 768px) {
            .game-mode {
                grid-template-columns: 1fr;
            }

            .room-options {
                grid-template-columns: 1fr;
            }

            .game-header {
                flex-direction: column;
                text-align: center;
            }

            .seals-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>

<body class="bg-cosmic-void min-h-screen font-inter text-amber-50 overflow-x-hidden relative">
    <!-- Golden Mystical Background -->
    <div class="fixed inset-0">
        <!-- Deep golden gradient -->
        <div class="absolute inset-0 bg-stellar-field"></div>
        <!-- Animated golden star field -->
        <div class="absolute inset-0" style="background-image: 
            radial-gradient(2px 2px at 20px 30px, rgba(251, 191, 36, 0.4), transparent),
            radial-gradient(2px 2px at 40px 70px, rgba(245, 158, 11, 0.5), transparent),
            radial-gradient(1px 1px at 90px 40px, rgba(251, 191, 36, 0.7), transparent),
            radial-gradient(1px 1px at 130px 80px, rgba(217, 119, 6, 0.3), transparent),
            radial-gradient(2px 2px at 160px 30px, rgba(245, 158, 11, 0.4), transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: twinkle 4s ease-in-out infinite;"></div>
        <!-- Floating golden particles -->
        <div class="absolute top-1/4 left-1/4 w-2 h-2 bg-mystic-gold-300 rounded-full opacity-70 animate-float"></div>
        <div class="absolute top-3/4 right-1/3 w-1 h-1 bg-mystic-gold-400 rounded-full opacity-50 animate-pulse-slow"></div>
        <div class="absolute bottom-1/4 left-3/4 w-3 h-3 bg-mystic-gold-200 rounded-full opacity-40 animate-twinkle"></div>
    </div>

    <!-- Connection Status -->
    <div class="fixed top-4 right-4 z-50">
        <div class="bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/30 rounded-2xl px-4 py-2 text-sm text-slate-200 shadow-golden-glow connecting" id="connectionStatus">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <div class="w-2 h-2 bg-mystic-gold-400 rounded-full animate-pulse"></div>
                    <div class="absolute inset-0 w-2 h-2 bg-mystic-gold-400 rounded-full animate-ping"></div>
                </div>
                <span class="font-medium">⚡ Connecting to Firebase...</span>
            </div>
        </div>
    </div>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-16 relative">
            <div class="bg-glass-morphism backdrop-blur-2xl border border-mystic-gold-400/20 rounded-3xl p-12 shadow-mystic-aura relative overflow-hidden group">
                <!-- Decorative Elements -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gold-mystique"></div>
                <div class="absolute -top-4 -left-4 w-20 h-20 bg-mystic-gold-400/20 rounded-full blur-2xl animate-pulse-slow"></div>
                <div class="absolute -bottom-4 -right-4 w-24 h-24 bg-cosmic-400/10 rounded-full blur-2xl animate-float"></div>
                
                <!-- Mystical Orb Icon -->
                <div class="flex justify-center mb-6">
                    <div class="relative">
                        <div class="w-16 h-16 bg-gold-mystique rounded-full shadow-golden-glow animate-pulse-slow"></div>
                        <div class="absolute inset-2 bg-midnight-950 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-mystic-gold-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2L15.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <h1 class="font-cinzel font-bold text-5xl md:text-7xl text-amber-100 mb-6 tracking-wide relative">
                    <span class="relative z-10 drop-shadow-2xl" style="text-shadow: 0 0 40px rgba(251, 191, 36, 0.8), 0 0 80px rgba(245, 158, 11, 0.6), 0 2px 4px rgba(0, 0, 0, 0.8);">
                        The Scroll of Seven Seals
                    </span>
                </h1>
                <p class="text-xl md:text-2xl text-amber-200 font-inter font-light tracking-wider mb-4 opacity-90">
                    Real-time Firebase Multiplayer Bible Mystery Adventure
                </p>
                <div class="w-32 h-px bg-gradient-to-r from-transparent via-mystic-gold-400 to-transparent mx-auto"></div>
            </div>
        </header>

        <!-- Multiplayer Info Box -->
        <div class="mb-16">
            <div class="bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/30 rounded-2xl p-8 shadow-golden-glow relative overflow-hidden">
                <!-- Animated background pattern -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute top-4 right-4 w-32 h-32 border border-mystic-gold-400/20 rounded-full animate-spin" style="animation-duration: 20s;"></div>
                    <div class="absolute bottom-4 left-4 w-24 h-24 border border-mystic-gold-500/20 rounded-full animate-spin" style="animation-duration: 15s; animation-direction: reverse;"></div>
                </div>
                
                <div class="relative z-10">
                    <h3 class="flex items-center justify-center text-2xl font-bold text-amber-100 mb-8">
                        <svg class="w-8 h-8 text-mystic-gold-400 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9m0 9a9 9 0 01-9-9m9 9c0 5-4 9-9 9s-9-4-9-9m9 9a9 9 0 009-9"></path>
                        </svg>
                        <span class="bg-gradient-to-r from-mystic-gold-300 to-mystic-gold-500 bg-clip-text text-transparent">
                            Real Cross-Device Multiplayer
                        </span>
                    </h3>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="flex items-center text-amber-200 group">
                            <div class="w-12 h-12 bg-gold-mystique rounded-xl flex items-center justify-center text-midnight-950 font-bold text-lg mr-4 shadow-golden-glow group-hover:scale-110 transition-transform duration-300">
                                1
                            </div>
                            <div>
                                <strong class="text-mystic-gold-200 block">Create Room</strong>
                                <span class="text-sm text-white opacity-90" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Get shareable link</span>
                            </div>
                        </div>
                        <div class="flex items-center text-amber-200 group">
                            <div class="w-12 h-12 bg-gold-mystique rounded-xl flex items-center justify-center text-midnight-950 font-bold text-lg mr-4 shadow-golden-glow group-hover:scale-110 transition-transform duration-300">
                                2
                            </div>
                            <div>
                                <strong class="text-mystic-gold-200 block">Share Link</strong>
                                <span class="text-sm text-white opacity-90" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Cross-device access</span>
                            </div>
                        </div>
                        <div class="flex items-center text-amber-200 group">
                            <div class="w-12 h-12 bg-gold-mystique rounded-xl flex items-center justify-center text-midnight-950 font-bold text-lg mr-4 shadow-golden-glow group-hover:scale-110 transition-transform duration-300">
                                3
                            </div>
                            <div>
                                <strong class="text-mystic-gold-200 block">Join Together</strong>
                                <span class="text-sm text-white opacity-90" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Same link entry</span>
                            </div>
                        </div>
                        <div class="flex items-center text-amber-200 group">
                            <div class="w-12 h-12 bg-gold-mystique rounded-xl flex items-center justify-center text-midnight-950 font-bold text-lg mr-4 shadow-golden-glow group-hover:scale-110 transition-transform duration-300">
                                4
                            </div>
                            <div>
                                <strong class="text-mystic-gold-200 block">Compete Live</strong>
                                <span class="text-sm text-white opacity-90" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Real-time gaming</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Mode Selection -->
        <div id="modeSelection" class="grid md:grid-cols-3 gap-8 mb-16">
            <!-- Single Group -->
            <div class="group cursor-pointer transform transition-all duration-500 hover:scale-105 hover:-translate-y-4 mode-card" data-mode="single">
                <div class="bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/20 rounded-3xl p-10 h-full shadow-mystic-aura hover:shadow-golden-glow hover:border-mystic-gold-400/60 transition-all duration-500 relative overflow-hidden">
                    <!-- Mystical background effect -->
                    <div class="absolute inset-0 bg-gradient-to-br from-mystic-gold-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    
                    <div class="text-center relative z-10">
                        <!-- Modern Icon -->
                        <div class="flex justify-center mb-8">
                            <div class="relative">
                                <div class="w-20 h-20 bg-gradient-to-br from-mystic-gold-500 to-mystic-gold-700 rounded-2xl flex items-center justify-center shadow-golden-glow group-hover:animate-pulse-slow transition-all duration-500 group-hover:scale-110">
                                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/>
                                    </svg>
                                </div>
                                <div class="absolute -inset-2 bg-mystic-gold-400/20 rounded-3xl blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                            </div>
                        </div>
                        
                        <h3 class="text-2xl font-bold font-cinzel bg-gradient-to-r from-mystic-gold-200 to-mystic-gold-400 bg-clip-text text-transparent mb-4 group-hover:scale-105 transition-transform duration-300">
                            Single Group
                        </h3>
                        <p class="text-white leading-relaxed font-inter" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">
                            Play as one unified team and challenge your best completion time
                        </p>
                        
                        <!-- Hover effect indicator -->
                        <div class="mt-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="w-12 h-px bg-gradient-to-r from-transparent via-mystic-gold-400 to-transparent mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VS Computer Teams -->
            <div class="group cursor-pointer transform transition-all duration-500 hover:scale-105 hover:-translate-y-4 mode-card" data-mode="ai">
                <div class="bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/20 rounded-3xl p-10 h-full shadow-golden-glow hover:shadow-mystic-aura hover:border-mystic-gold-400/60 transition-all duration-500 relative overflow-hidden">
                    <!-- Mystical background effect -->
                    <div class="absolute inset-0 bg-gradient-to-br from-mystic-gold-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    
                    <div class="text-center relative z-10">
                        <!-- Modern Icon -->
                        <div class="flex justify-center mb-8">
                            <div class="relative">
                                <div class="w-20 h-20 bg-gradient-to-br from-mystic-gold-500 to-mystic-gold-700 rounded-2xl flex items-center justify-center shadow-golden-glow group-hover:animate-pulse-slow transition-all duration-500 group-hover:scale-110">
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <div class="absolute -inset-2 bg-mystic-gold-400/20 rounded-3xl blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                            </div>
                        </div>
                        
                        <h3 class="text-2xl font-bold font-cinzel bg-gradient-to-r from-mystic-gold-200 to-mystic-gold-400 bg-clip-text text-transparent mb-4 group-hover:scale-105 transition-transform duration-300">
                            VS Computer Teams
                        </h3>
                        <p class="text-white leading-relaxed font-inter" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">
                            Battle against intelligent AI opponents in strategic competition
                        </p>
                        
                        <!-- Hover effect indicator -->
                        <div class="mt-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="w-12 h-px bg-gradient-to-r from-transparent via-mystic-gold-400 to-transparent mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real Multiplayer -->
            <div class="group cursor-pointer transform transition-all duration-500 hover:scale-105 hover:-translate-y-4 mode-card" data-mode="multiplayer">
                <div class="bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/20 rounded-3xl p-10 h-full shadow-mystic-aura hover:shadow-golden-glow hover:border-mystic-gold-400/60 transition-all duration-500 relative overflow-hidden">
                    <!-- Mystical background effect -->
                    <div class="absolute inset-0 bg-gradient-to-br from-mystic-gold-500/5 to-cosmic-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    
                    <div class="text-center relative z-10">
                        <!-- Modern Icon -->
                        <div class="flex justify-center mb-8">
                            <div class="relative">
                                <div class="w-20 h-20 bg-gradient-to-br from-mystic-gold-400 via-mystic-gold-500 to-cosmic-500 rounded-2xl flex items-center justify-center shadow-golden-glow group-hover:animate-pulse-slow transition-all duration-500 group-hover:scale-110">
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9m0 9a9 9 0 01-9-9m9 9c0 5-4 9-9 9s-9-4-9-9m9 9a9 9 0 009-9"/>
                                    </svg>
                                </div>
                                <div class="absolute -inset-2 bg-gradient-to-br from-mystic-gold-400/20 to-cosmic-400/20 rounded-3xl blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                            </div>
                        </div>
                        
                        <h3 class="text-2xl font-bold font-cinzel bg-gradient-to-r from-mystic-gold-300 via-mystic-gold-400 to-cosmic-400 bg-clip-text text-transparent mb-4 group-hover:scale-105 transition-transform duration-300">
                            Real Multiplayer
                        </h3>
                        <p class="text-white leading-relaxed font-inter" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">
                            Connect with friends worldwide using Firebase real-time technology
                        </p>
                        
                        <!-- Hover effect indicator -->
                        <div class="mt-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="w-12 h-px bg-gradient-to-r from-transparent via-mystic-gold-400 to-transparent mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Multiplayer Setup -->
        <div id="multiplayerSetup" class="hidden">
            <div class="bg-card-gradient backdrop-blur-xl border border-gold-400/30 rounded-3xl p-8 mb-8 shadow-2xl">
                <h2 class="text-3xl font-bold text-center bg-gold-gradient bg-clip-text text-transparent mb-6">
                    Firebase Real-time Multiplayer Setup
                </h2>

                <div class="max-w-md mx-auto mb-8">
                    <label for="teamName" class="block text-gold-300 font-semibold mb-2">Team Name:</label>
                    <input type="text" id="teamName" placeholder="Enter your team name" maxlength="20" 
                           class="w-full px-4 py-3 bg-white/90 border border-mystic-600/50 rounded-xl text-gray-900 placeholder-gray-500 focus:border-gold-400 focus:outline-none focus:ring-2 focus:ring-gold-400/20 transition-all duration-300"
                           style="color: #1f2937 !important; background-color: rgba(255, 255, 255, 0.95) !important;">
                </div>

                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="group cursor-pointer" onclick="showRoomCreation()">
                        <div class="bg-gradient-to-br from-green-900/30 to-emerald-900/20 border border-green-400/30 rounded-2xl p-6 transition-all duration-300 hover:border-green-400/60 hover:shadow-lg hover:scale-105">
                            <div class="text-center">
                                <div class="text-4xl mb-4">🏠</div>
                                <h3 class="text-xl font-bold text-green-300 mb-2">Create Room</h3>
                                <p class="text-mystic-300">Start a new Firebase game room</p>
                            </div>
                        </div>
                    </div>

                    <div class="group cursor-pointer" onclick="showRoomJoin()">
                        <div class="bg-gradient-to-br from-blue-900/30 to-indigo-900/20 border border-blue-400/30 rounded-2xl p-6 transition-all duration-300 hover:border-blue-400/60 hover:shadow-lg hover:scale-105">
                            <div class="text-center">
                                <div class="text-4xl mb-4">🔗</div>
                                <h3 class="text-xl font-bold text-blue-300 mb-2">Join via Link</h3>
                                <p class="text-mystic-300">Use a friend's room link</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="roomCreation" class="room-input-section hidden">
                    <div class="bg-mystic-800/30 backdrop-blur-lg border border-mystic-600/50 rounded-2xl p-6 mb-6">
                        <div class="text-center mb-4">
                            <label class="block text-gold-300 font-semibold mb-2">Room Code:</label>
                            <div class="bg-mystic-900/50 border border-gold-400/30 rounded-xl p-4 font-mono text-2xl text-gold-300 tracking-wider" id="roomCode">
                                ------
                            </div>
                        </div>
                        <div class="text-center">
                            <label class="block text-gold-300 font-semibold mb-2">Your Room Link:</label>
                            <div class="bg-mystic-900/50 border border-gold-400/30 rounded-xl p-4 text-sm text-mystic-300 break-all" id="shareLink">
                                Click Create Room to generate link...
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="copyRoomLink()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg">
                            📋 Copy Room Link
                        </button>
                        <button onclick="createRoom()" class="bg-gold-gradient text-mystic-900 font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg">
                            Create Room
                        </button>
                    </div>
                </div>

                <div id="roomJoin" class="room-input-section hidden">
                    <div class="max-w-md mx-auto mb-6">
                        <label class="block text-gold-300 font-semibold mb-2">Paste Room Link or Code:</label>
                        <input type="text" id="roomInput" placeholder="Paste room link from your friend"
                               class="w-full px-4 py-3 bg-mystic-800/50 border border-mystic-600/50 rounded-xl text-mystic-100 placeholder-mystic-400 focus:border-gold-400 focus:outline-none focus:ring-2 focus:ring-gold-400/20 transition-all duration-300">
                    </div>
                    <div class="text-center">
                        <button onclick="joinRoom()" class="bg-gold-gradient text-mystic-900 font-semibold py-3 px-8 rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg">
                            Join Room
                        </button>
                    </div>
                </div>

                <div class="text-center mt-8">
                    <button onclick="goBack()" class="bg-mystic-700 hover:bg-mystic-600 text-mystic-200 font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover:scale-105">
                        ← Back
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Mode Setup -->
        <div id="aiSetup" class="multiplayer-setup" style="display: none;">
            <div class="setup-title">🤖 VS Computer Teams Setup</div>

            <div class="team-input">
                <label for="playerTeamName">Your Team Name:</label>
                <input type="text" id="playerTeamName" placeholder="Enter your team name" maxlength="20" value="Player">
            </div>

            <div class="team-input">
                <label for="aiTeamCount">Number of AI Opponents:</label>
                <select id="aiTeamCount" style="width: 100%; padding: 12px; font-size: 1em; border: 2px solid #6b4d37; border-radius: 8px; background: rgba(0, 0, 0, 0.3); color: #f4f1e8; font-family: inherit;">
                    <option value="1">1 AI Team</option>
                    <option value="2" selected>2 AI Teams</option>
                    <option value="3">3 AI Teams</option>
                    <option value="4">4 AI Teams</option>
                    <option value="5">5 AI Teams</option>
                </select>
            </div>

            <div class="team-input">
                <label for="aiDifficulty">AI Difficulty:</label>
                <select id="aiDifficulty" style="width: 100%; padding: 12px; font-size: 1em; border: 2px solid #6b4d37; border-radius: 8px; background: rgba(0, 0, 0, 0.3); color: #f4f1e8; font-family: inherit;">
                    <option value="easy">🟢 Easy - AI completes seals every 45-90 seconds</option>
                    <option value="medium" selected>🟡 Medium - AI completes seals every 30-60 seconds</option>
                    <option value="hard">🔴 Hard - AI completes seals every 15-45 seconds</option>
                    <option value="expert">🔥 Expert - AI completes seals every 10-30 seconds</option>
                </select>
            </div>

            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid #c9a96e; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <h4 style="color: #d4af37; margin-bottom: 10px;">🎮 How it Works:</h4>
                <ul style="color: #e8dcc0; margin: 0; padding-left: 20px;">
                    <li>You compete against AI teams that solve seals automatically</li>
                    <li>First team (you or AI) to complete all 7 seals wins</li>
                    <li>Game ends immediately when someone wins</li>
                    <li>Final rankings show all teams' performance</li>
                </ul>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" onclick="startAIGame()">🚀 Start Competition</button>
                <button class="button secondary" onclick="goBack()">← Back</button>
            </div>
        </div>

        <!-- Lobby -->
        <div id="lobby" class="lobby">
            <div class="lobby-title">Firebase Game Lobby</div>
            <div class="room-code-display">
                <div>Room Code: <span class="room-code" id="lobbyRoomCode">------</span></div>
            </div>
            <div class="teams-list" id="teamsList"></div>
            <div style="text-align: center;">
                <button class="button" onclick="startRoomGameplay()" id="startLobbyBtn">Start Adventure</button>
                <button class="button secondary" onclick="goBack()">← Back to Setup</button>
            </div>
        </div>

        <!-- Game Container -->
        <div id="gameContainer" class="game-container">
            <div class="game-header">
                <div class="timer" id="timer">00:00</div>
                <div class="progress-container">
                    <div class="progress-label">Progress: <span id="progressText">0/7 Seals</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <!-- Universal Game Options -->
            <div class="game-options">
                <div class="option-toggle">
                    <span>🔊 Sound Effects:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundEnabled" onchange="toggleSound()" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="option-description">Play audio feedback for game actions</span>
                </div>
                <div class="option-toggle">
                    <span>💡 Enhanced Hints:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="hintsEnabled" onchange="toggleHints()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="option-description">Show additional guidance for challenging puzzles</span>
                </div>
                <div class="option-toggle">
                    <span>🔀 Random Mode:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="randomMode" checked onchange="toggleRandomMode()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="option-description">Generate fresh puzzles each game</span>
                </div>
                <div class="option-toggle">
                    <span>📊 Show Progress:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="detailedProgress" checked onchange="toggleDetailedProgress()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="option-description">Display detailed completion statistics</span>
                </div>
            </div>

            <div class="seals-grid" id="sealsGrid"></div>

            <div class="leaderboard">
                <div class="leaderboard-title">Live Rankings</div>
                <div id="leaderboardList"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button secondary" onclick="resetGameState()">🔄 Reset Game</button>
                <button class="button secondary" onclick="goBack()">← Back to Lobby</button>
            </div>
        </div>
    </div>

    <!-- Complexity Selection Modal -->
    <div id="complexityModal" class="complexity-modal">
        <div class="complexity-content">
            <h2 class="complexity-title">⚔️ Choose Your Challenge Level ⚔️</h2>
            <p style="text-align: center; color: #b8a082; margin-bottom: 30px; font-size: 1.1em;">
                Select the complexity level that matches your biblical knowledge and puzzle-solving experience
            </p>
            
            <div class="complexity-grid">
                <!-- Beginner Level -->
                <div class="complexity-card" onclick="selectComplexity('beginner')" data-complexity="beginner">
                    <span class="complexity-icon">🌱</span>
                    <div class="complexity-name">Beginner</div>
                    <div class="complexity-description">
                        Perfect for newcomers to biblical puzzles and those who prefer a gentle introduction to the mysteries.
                    </div>
                    <ul class="complexity-features">
                        <li>Enhanced hints and guidance available</li>
                        <li>More forgiving answer validation</li>
                        <li>Extra time for challenging puzzles</li>
                        <li>Simplified puzzle variations</li>
                        <li>Progress tracking and encouragement</li>
                    </ul>
                </div>

                <!-- Intermediate Level -->
                <div class="complexity-card" onclick="selectComplexity('intermediate')" data-complexity="intermediate">
                    <span class="complexity-icon">⚖️</span>
                    <div class="complexity-name">Intermediate</div>
                    <div class="complexity-description">
                        Balanced challenge for those with moderate biblical knowledge and puzzle-solving experience.
                    </div>
                    <ul class="complexity-features">
                        <li>Standard hints when needed</li>
                        <li>Balanced answer requirements</li>
                        <li>Normal time limits</li>
                        <li>Mixed puzzle complexity</li>
                        <li>Achievement tracking</li>
                    </ul>
                </div>

                <!-- Advanced Level -->
                <div class="complexity-card" onclick="selectComplexity('advanced')" data-complexity="advanced">
                    <span class="complexity-icon">🔥</span>
                    <div class="complexity-name">Advanced</div>
                    <div class="complexity-description">
                        Challenging experience for seasoned biblical scholars and puzzle enthusiasts seeking deeper mysteries.
                    </div>
                    <ul class="complexity-features">
                        <li>Limited hints available</li>
                        <li>Stricter answer validation</li>
                        <li>Shorter time limits</li>
                        <li>Complex puzzle variations</li>
                        <li>Bonus challenges unlocked</li>
                    </ul>
                </div>

                <!-- Expert Level -->
                <div class="complexity-card" onclick="selectComplexity('expert')" data-complexity="expert">
                    <span class="complexity-icon">👑</span>
                    <div class="complexity-name">Expert</div>
                    <div class="complexity-description">
                        Ultimate challenge for biblical masters who dare to unlock the deepest secrets of the Seven Seals.
                    </div>
                    <ul class="complexity-features">
                        <li>No hints or guidance</li>
                        <li>Exact answer requirements</li>
                        <li>Strict time constraints</li>
                        <li>Maximum puzzle complexity</li>
                        <li>Legendary achievements</li>
                    </ul>
                </div>
            </div>

            <div class="complexity-buttons">
                <button class="button" id="confirmComplexity" onclick="confirmComplexitySelection()" disabled>
                    🚀 Begin Quest
                </button>
                <button class="button secondary" onclick="closeComplexityModal()">
                    ← Back
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Challenge Modal -->
    <div id="puzzleModal" class="puzzle-modal">
        <div class="puzzle-content">
            <div class="modal-header">
                <div class="puzzle-title" id="puzzleTitle"></div>
                <button class="close-button" onclick="closePuzzle()">✕</button>
            </div>
            <div class="puzzle-question" id="puzzleQuestion">
                <!-- Enhanced challenge content loads here -->
            </div>
            <!-- Legacy input - hidden by default for enhanced challenges -->
            <div id="legacyInputs" style="display: none;">
                <input type="text" id="puzzleAnswer" class="puzzle-input" placeholder="Enter your answer">
                <div class="puzzle-buttons">
                    <button class="button" onclick="submitAnswer()">Submit</button>
                    <button class="button secondary" onclick="closePuzzle()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase config handled by firebase-config.js
        
        // Missing function definitions
        function showAlert(message, type = 'info') {
            if (window.showNotification) {
                window.showNotification(message, type);
            } else {
                console.log(`${type.toUpperCase()}: ${message}`);
                alert(message);
            }
        }
        
        // Make showAlert globally available
        window.showAlert = showAlert;
        
        // Initialize mode selection event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 Setting up mode selection event listeners...');
            
            const modeCards = document.querySelectorAll('.mode-card[data-mode]');
            modeCards.forEach(card => {
                card.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    console.log('🎮 Mode selected:', mode);
                    
                    if (window.selectMode) {
                        window.selectMode(mode);
                    } else {
                        console.error('selectMode function not yet available');
                        // Fallback - try again after a short delay
                        setTimeout(() => {
                            if (window.selectMode) {
                                window.selectMode(mode);
                            } else {
                                alert('Game is still loading. Please try again in a moment.');
                            }
                        }, 1000);
                    }
                });
            });
            
            console.log('✅ Mode selection event listeners setup complete');
            
            // Initialize spiritual content when DOM is ready
            if (typeof updateSpiritualContent === 'function') {
                updateSpiritualContent();
            } else {
                // Wait for function to be defined
                setTimeout(() => {
                    if (typeof updateSpiritualContent === 'function') {
                        updateSpiritualContent();
                    }
                }, 1000);
            }
        });

        // VERSION CHECK - Force browser cache refresh
        console.log('🚀 GAME VERSION: v1.6.0 - ULTIMATE FIX: Single player + enhanced features fallbacks + all game modes working');
        console.log('📅 Code loaded at:', new Date().toISOString());
        
        // EMERGENCY WINNER TESTING - Call from console if needed
        window.forcePlayerWin = function() {
            console.log('🆘 EMERGENCY: Forcing player victory manually');
            if (gameState.mode === 'ai' && gameState.completedSeals.length >= 7) {
                const elapsed = Date.now() - gameState.startTime;
                const playerTeam = gameState.teams.find(team => !team.isAI) || { name: gameState.currentTeam, isAI: false };
                playerTeam.score = 7;
                playerTeam.completedSeals = [...gameState.completedSeals];
                playerTeam.lastSealTime = Date.now();
                handleAIGameEnd(playerTeam, elapsed);
            }
        };
        
        // Game State
        let gameState = {
            mode: '',
            currentTeam: '',
            teams: [],
            completedSeals: [],
            startTime: null,
            currentPuzzle: null,
            isGameActive: false,
            roomCode: '',
            isHost: false,
            roomRef: null,
            // AI Mode specific
            aiTeams: [],
            aiTimers: [],
            aiDifficulty: 'medium'
        };

        // Ensure enhanced data is loaded
        function initializeEnhancedGame() {
            if (!window.GameData) {
                console.error('❌ GameData not loaded! Check console for script errors.');
                showAlert('Enhanced challenges failed to load!', 'error');
                return false;
            }
            if (!window.PuzzleManager) {
                console.error('❌ PuzzleManager not loaded! Check console for script errors.');
                showAlert('Enhanced challenges failed to load!', 'error');
                return false;
            }
            
            console.log('✅ Enhanced challenge system initialized');
            console.log('📚 Available seals:', window.GameData.seals.length);
            return true;
        }

        // Firebase connection monitoring
        let isFirebaseReady = false;
        // Firebase variables declared in firebase-config.js

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;

            switch (status) {
                case 'connecting':
                    statusEl.textContent = '🔄 Connecting to Firebase...';
                    break;
                case 'connected':
                    statusEl.textContent = '✅ Firebase Connected';
                    isFirebaseReady = true;
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                    break;
                case 'disconnected':
                    statusEl.textContent = '❌ Firebase Disconnected';
                    statusEl.style.display = 'block';
                    break;
            }
        }

        // Initialize Firebase
        function initializeFirebase() {
            return new Promise((resolve, reject) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        console.log('🔥 Firebase SDK loaded, initializing...');

                        // Check if already initialized
                        if (isFirebaseReady && database && auth) {
                            console.log('✅ Firebase already ready');
                            resolve(true);
                            return;
                        }

                        if (!app) {
                            app = firebase.initializeApp(firebaseConfig);
                        }
                        database = firebase.database();
                        auth = firebase.auth();

                        console.log('🔥 Firebase initialized successfully');

                        // Wait for authentication state
                        const unsubscribe = auth.onAuthStateChanged((user) => {
                            if (user) {
                                console.log('✅ User authenticated:', user.uid);
                                isFirebaseReady = true;
                                updateConnectionStatus('connected');
                                unsubscribe(); // Remove listener after first authentication
                                resolve(true);

                                // Monitor connection status
                                database.ref('.info/connected').on('value', (snapshot) => {
                                    const connected = snapshot.val();
                                    console.log('🔥 Firebase connection status:', connected);
                                    if (connected === true) {
                                        updateConnectionStatus('connected');
                                        isFirebaseReady = true;
                                    } else {
                                        updateConnectionStatus('disconnected');
                                        isFirebaseReady = false;
                                    }
                                });
                            } else {
                                // Sign in anonymously for multiplayer access
                                console.log('🔐 Signing in anonymously...');
                                auth.signInAnonymously()
                                    .catch((error) => {
                                        console.error('❌ Anonymous authentication failed:', error);
                                        updateConnectionStatus('disconnected');
                                        unsubscribe();
                                        reject(error);
                                    });
                            }
                        });
                    } else {
                        console.error('❌ Firebase SDK not loaded');
                        updateConnectionStatus('disconnected');
                        reject(new Error('Firebase SDK not available'));
                    }
                } catch (error) {
                    console.error('❌ Firebase initialization failed:', error);
                    updateConnectionStatus('disconnected');
                    reject(error);
                }
            });
        }

        // Wait for Firebase SDK to load
        function waitForFirebase() {
            if (typeof firebase !== 'undefined') {
                initializeFirebase();
            } else {
                setTimeout(waitForFirebase, 100);
            }
        }

        // Firebase initialization handled by firebase-config.js
        // waitForFirebase(); // Removed to prevent duplicate initialization

        // Check for room parameter in URL
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam) {
                // Auto-fill join form
                document.getElementById('roomInput').value = roomParam;
                selectMode('multiplayer');
                showRoomJoin();
            }
        });

        function selectMode(mode) {
            gameState.mode = mode;

            // Update UI
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('selected'));
            // Find and select the mode card by data attribute or content
            const modeCards = document.querySelectorAll('.mode-card');
            modeCards.forEach(card => {
                if (card.textContent.toLowerCase().includes(mode) || 
                    (mode === 'single' && card.textContent.includes('Single')) ||
                    (mode === 'ai' && card.textContent.includes('VS Computer')) ||
                    (mode === 'multiplayer' && card.textContent.includes('Real Multiplayer'))) {
                    card.classList.add('selected');
                }
            });

            if (mode === 'multiplayer') {
                if (!isFirebaseReady) {
                    showAlert('Firebase is not ready yet. Please wait a moment and try again.', 'error');
                    return;
                }
                document.getElementById('multiplayerSetup').style.display = 'block';
            } else if (mode === 'ai') {
                // Show AI mode setup
                document.getElementById('aiSetup').style.display = 'block';
            } else {
                // Start single player mode directly
                startSinglePlayerGame();
            }
        }
        
        // Make selectMode globally available
        window.selectMode = selectMode;

        function showRoomCreation() {
            document.getElementById('roomCreation').classList.add('active');
            document.getElementById('roomJoin').classList.remove('active');

            // Automatically generate room code and link when showing creation form
            const roomCode = Math.random().toString(36).substr(2, 6).toUpperCase();
            const shareLink = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;

            document.getElementById('roomCode').textContent = roomCode;
            document.getElementById('shareLink').textContent = shareLink;

            // Store for when they actually create the room
            window.tempRoomCode = roomCode;
            window.tempShareLink = shareLink;
        }

        function showRoomJoin() {
            document.getElementById('roomJoin').classList.add('active');
            document.getElementById('roomCreation').classList.remove('active');
        }

        async function createRoom() {
            console.log('🎯 Create room clicked');

            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                showAlert('Please enter a team name', 'error');
                return;
            }

            // Use pre-generated room code and link
            const roomCode = window.tempRoomCode || Math.random().toString(36).substr(2, 6).toUpperCase();
            const shareLink = window.tempShareLink || `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
            console.log('🎲 Using room code:', roomCode);

            gameState.roomCode = roomCode;
            gameState.currentTeam = teamName;
            gameState.isHost = true;
            gameState.teams = [{ name: teamName, score: 0, completedSeals: [] }];

            try {
                // Ensure Firebase is ready before proceeding
                if (!isFirebaseReady) {
                    updateConnectionStatus('connecting');
                    await initializeFirebase();
                }

                if (database && isFirebaseReady) {
                    console.log('🔥 Attempting Firebase save...');

                    const roomData = {
                        code: roomCode,
                        host: teamName,
                        teams: {
                            [teamName]: {
                                name: teamName,
                                isHost: true,
                                joinTime: firebase.database.ServerValue.TIMESTAMP,
                                score: 0,
                                completedSeals: []
                            }
                        },
                        status: 'waiting',
                        gameStarted: false,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    await database.ref(`rooms/${roomCode}`).set(roomData);
                    console.log('✅ Firebase save successful');
                    showAlert('Room created! Share the link to invite players.', 'success');
                } else {
                    console.log('⚠️ Creating room without Firebase');
                    showAlert('Room created locally (limited functionality)', 'success');
                }
            } catch (error) {
                console.error('❌ Error creating room:', error);
                showAlert('Room created (with sync issues)', 'success');
            }

            // Always proceed to lobby
            showLobby();
        }

        async function joinRoom() {
            const teamName = document.getElementById('teamName').value.trim();
            let roomInput = document.getElementById('roomInput').value.trim();

            if (!teamName) {
                showAlert('Please enter a team name', 'error');
                return;
            }

            // Extract room code from URL if provided
            let roomCode = roomInput;
            if (roomInput.includes('?room=')) {
                roomCode = roomInput.split('?room=')[1].split('&')[0];
            }

            if (!roomCode) {
                showAlert('Please enter a room code or link', 'error');
                return;
            }

            roomCode = roomCode.toUpperCase();
            
            // DEBUG: Add extensive logging
            console.log('🚪 JOINING ROOM - Room code:', roomCode);
            console.log('🔥 Firebase ready?', isFirebaseReady);
            console.log('📡 Database object:', database);

            try {
                // Ensure Firebase is ready before proceeding
                if (!isFirebaseReady) {
                    updateConnectionStatus('connecting');
                    showAlert('Connecting to room...', 'success');
                    await initializeFirebase();
                }

                if (!database || !isFirebaseReady) {
                    showAlert('Unable to connect to multiplayer service', 'error');
                    return;
                }

                console.log('🔍 Checking room:', roomCode);

                // Check if room exists
                console.log('🔍 Searching for room at path:', `rooms/${roomCode}`);
                const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
                const roomData = snapshot.val();
                
                console.log('📊 Room data found:', roomData);
                console.log('📊 Snapshot exists:', snapshot.exists());
                
                // DEBUG: List all rooms to see what's in the database
                const allRoomsSnapshot = await database.ref('rooms').once('value');
                const allRooms = allRoomsSnapshot.val();
                console.log('📋 All rooms in database:', allRooms);

                if (!roomData) {
                    console.log('❌ Room not found for code:', roomCode);
                    showAlert('Room not found. Please check the room code.', 'error');
                    return;
                }
                
                console.log('✅ Room found successfully!');

                if (roomData.status !== 'waiting') {
                    showAlert('This game has already started.', 'error');
                    return;
                }

                // Check if team name already exists
                if (roomData.teams && roomData.teams[teamName]) {
                    showAlert('A team with this name already exists in the room.', 'error');
                    return;
                }

                // Join the room
                gameState.roomCode = roomCode;
                gameState.currentTeam = teamName;
                gameState.isHost = false;

                const teamData = {
                    name: teamName,
                    isHost: false,
                    joinTime: firebase.database.ServerValue.TIMESTAMP,
                    score: 0,
                    completedSeals: []
                };

                console.log('💾 Saving team data:', teamData);
                await database.ref(`rooms/${roomCode}/teams/${teamName}`).set(teamData);

                // Update URL
                window.history.pushState({}, '', `${window.location.pathname}?room=${roomCode}`);

                showLobby();
                showAlert('Joined room successfully!', 'success');

            } catch (error) {
                console.error('❌ Error joining room:', error);
                showAlert('Failed to join room: ' + error.message, 'error');
            }
        }

        function showLobby() {
            document.getElementById('multiplayerSetup').style.display = 'none';
            document.getElementById('lobby').style.display = 'block';
            document.getElementById('lobbyRoomCode').textContent = gameState.roomCode;

            // Listen for room updates
            gameState.roomRef = database.ref(`rooms/${gameState.roomCode}`);
            gameState.roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (roomData) {
                    updateLobby(roomData);

                    // CRITICAL: Update leaderboard with live Firebase data during gameplay
                    if (gameState.isGameActive && roomData.teams) {
                        console.log('📊 ROOM LISTENER: Updating leaderboard with live data');
                        updateLeaderboardFromFirebase(roomData.teams);
                    }

                    // Check if game started
                    if (roomData.gameStarted && !gameState.isGameActive) {
                        startRoomGameplay();
                    }

                    // Check if game has ended with a winner
                    if (roomData.status === 'finished' && roomData.winner && gameState.isGameActive) {
                        console.log('🏆 ROOM LISTENER: Game ended, winner detected:', roomData.winner);
                        console.log('🏆 ROOM LISTENER: Current team:', gameState.currentTeam);
                        console.log('🏆 ROOM LISTENER: Is game active?', gameState.isGameActive);
                        console.log('🏆 ROOM LISTENER: Final rankings available?', !!roomData.finalRankings);
                        
                        const isWinner = roomData.winner === gameState.currentTeam;
                        console.log('🏆 ROOM LISTENER: Is current team winner?', isWinner);
                        
                        // Show enhanced modal with rankings if available, otherwise fallback to simple modal
                        if (roomData.finalRankings) {
                            showWinnerModalWithRankings(roomData.winner, roomData.completionTime || 0, roomData.finalRankings, isWinner);
                        } else {
                            showWinnerModal(roomData.winner, roomData.completionTime || 0, isWinner);
                        }
                    } 
                    // Also check for gameActive flag to lock the game immediately
                    else if (roomData.gameActive === false && gameState.isGameActive) {
                        console.log('🔒 ROOM LISTENER: Game deactivated, locking UI');
                        lockGameInputs();
                        
                        // If there's winner data but status isn't finished yet, prepare for incoming winner announcement
                        if (roomData.winner) {
                            console.log('🏆 ROOM LISTENER: Winner exists, showing modal soon');
                            const isWinner = roomData.winner === gameState.currentTeam;
                            if (roomData.finalRankings) {
                                showWinnerModalWithRankings(roomData.winner, roomData.completionTime || 0, roomData.finalRankings, isWinner);
                            } else {
                                showWinnerModal(roomData.winner, roomData.completionTime || 0, isWinner);
                            }
                        }
                    }
                    else {
                        console.log('🔍 ROOM LISTENER: Room status:', roomData.status, 'Winner:', roomData.winner, 'Game active:', roomData.gameActive, 'Local game active:', gameState.isGameActive);
                    }
                } else {
                    showAlert('Room no longer exists', 'error');
                    goBack();
                }
            });
        }

        function updateLobby(roomData) {
            // Update teams list
            gameState.teams = Object.values(roomData.teams || {});
            updateTeamsList();

            // Update start button for host
            if (gameState.isHost) {
                const startBtn = document.getElementById('startLobbyBtn');
                const canStart = gameState.teams.length >= 1; // Allow single player start for testing
                startBtn.disabled = !canStart;
                startBtn.textContent = canStart ? 'Start Adventure' : 'Waiting for players...';
            } else {
                const startBtn = document.getElementById('startLobbyBtn');
                startBtn.style.display = 'none';
            }
        }

        function updateTeamsList() {
            const teamsList = document.getElementById('teamsList');
            teamsList.innerHTML = '';

            gameState.teams.forEach(team => {
                const teamItem = document.createElement('div');
                teamItem.className = 'team-item';
                teamItem.innerHTML = `
                    <span class="team-name">${team.name}${team.isHost ? ' 👑' : ''}</span>
                    <span class="team-status">Ready</span>
                `;
                teamsList.appendChild(teamItem);
            });
        }

        function startRoomGameplay() {
            if (gameState.isHost) {
                // Host starts the game for everyone
                database.ref(`rooms/${gameState.roomCode}`).update({
                    gameStarted: true,
                    gameActive: true,
                    status: 'playing',
                    startTime: firebase.database.ServerValue.TIMESTAMP
                });
            }

            // Initialize enhanced game system
            if (!initializeEnhancedGame()) {
                showAlert('Failed to load enhanced challenges!', 'error');
                return;
            }

            // Start local game
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            gameState.isGameActive = true;
            gameState.startTime = Date.now();
            gameState.completedSeals = [];

            renderSeals();
            startTimer();
            updateProgress();
            updateLeaderboard();

            showAlert('Game started!', 'success');
        }

        function startSinglePlayerGame() {
            // Initialize enhanced game system
            if (!initializeEnhancedGame()) {
                console.warn('Enhanced features not available, using basic game mode');
                // Initialize basic PuzzleManager fallback
                if (!window.PuzzleManager) {
                    window.PuzzleManager = {
                        resetChallenge: (type) => {
                            console.log('Basic puzzle reset for:', type);
                        },
                        getCurrentPuzzle: () => {
                            return { number: 1, type: 'basic' };
                        }
                    };
                }
                // Continue with basic game instead of failing
            }
            
            // Update spiritual content for fresh inspiration
            updateSpiritualContent();
            
            gameState.currentTeam = 'Player';
            gameState.teams = [{ name: 'Player', score: 0, completedSeals: [] }];

            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            gameState.isGameActive = true;
            gameState.startTime = Date.now();
            gameState.completedSeals = [];

            renderSeals();
            startTimer();
            updateProgress();
            updateLeaderboard();
        }

        // AI team name pool
        const aiTeamNames = [
            'Scripture Scholars', 'Bible Blazers', 'Faith Warriors', 'Gospel Guardians',
            'Verse Virtuosos', 'Holy Hunters', 'Divine Detectives', 'Sacred Seekers',
            'Truth Trackers', 'Word Warriors', 'Righteous Runners', 'Glory Gatherers',
            'Heaven Hounds', 'Salvation Squad', 'Psalm Pioneers', 'Covenant Crusaders',
            'Prophecy Pros', 'Testament Titans', 'Miracle Masters', 'Grace Gladiators'
        ];

        // AI difficulty settings
        const aiDifficultySettings = {
            easy: { minTime: 45000, maxTime: 90000, variance: 0.3 },      // 45-90 seconds
            medium: { minTime: 30000, maxTime: 60000, variance: 0.4 },    // 30-60 seconds  
            hard: { minTime: 15000, maxTime: 45000, variance: 0.5 },      // 15-45 seconds
            expert: { minTime: 10000, maxTime: 30000, variance: 0.6 }     // 10-30 seconds
        };

        function startAIGame() {
            const playerTeamName = document.getElementById('playerTeamName').value.trim() || 'Player';
            const aiTeamCount = parseInt(document.getElementById('aiTeamCount').value);
            const aiDifficulty = document.getElementById('aiDifficulty').value;

            if (!playerTeamName) {
                showAlert('Please enter your team name', 'error');
                return;
            }

            console.log('🤖 Starting AI Game:', { playerTeamName, aiTeamCount, aiDifficulty });

            // Initialize enhanced game system
            if (!initializeEnhancedGame()) {
                console.warn('Enhanced features not available, using basic AI game mode');
                // Initialize basic fallbacks
                if (!window.PuzzleManager) {
                    window.PuzzleManager = {
                        resetChallenge: (type) => console.log('Basic puzzle reset for:', type),
                        getCurrentPuzzle: () => ({ number: 1, type: 'basic' })
                    };
                }
                if (!window.BibleGameAI) {
                    window.BibleGameAI = class {
                        constructor(name, difficulty) {
                            this.name = name;
                            this.difficulty = difficulty;
                        }
                        simulateProgress() {
                            console.log('Basic AI simulation for:', this.name);
                        }
                    };
                }
                // Continue with basic game
            }
            
            // Setup game state
            gameState.mode = 'ai';
            gameState.currentTeam = playerTeamName;
            gameState.aiDifficulty = aiDifficulty;
            gameState.completedSeals = [];
            gameState.aiTeams = [];
            gameState.aiTimers = [];

            // Create player team
            const playerTeam = { 
                name: playerTeamName, 
                score: 0, 
                completedSeals: [], 
                isAI: false,
                lastSealTime: null
            };

            // Create AI teams with unique names
            const selectedAINames = aiTeamNames
                .sort(() => Math.random() - 0.5)  // Shuffle
                .slice(0, aiTeamCount);           // Take required number

            console.log('🤖 Selected AI names:', selectedAINames);
            console.log('🤖 AI team count requested:', aiTeamCount);

            const aiTeams = selectedAINames.map((name, index) => ({
                name: name,
                id: `ai_${index}`, // Add unique ID
                score: 0,
                completedSeals: [],
                isAI: true,
                lastSealTime: null,
                nextSealTime: null
            }));

            // Combine all teams (ensure no duplication)
            gameState.teams = [playerTeam, ...aiTeams];
            gameState.aiTeams = aiTeams;

            console.log('🤖 Final teams array:', gameState.teams);
            console.log('🤖 Teams count - Expected:', aiTeamCount + 1, 'Actual:', gameState.teams.length);

            console.log('🤖 Teams created:', gameState.teams);

            // Hide setup and show game
            document.getElementById('aiSetup').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            // Start game
            gameState.isGameActive = true;
            gameState.startTime = Date.now();

            renderSeals();
            startTimer();
            updateProgress();
            updateLeaderboard();

            // Start AI progression
            startAIProgression();

            showAlert(`🤖 Competition started against ${aiTeamCount} AI team${aiTeamCount > 1 ? 's' : ''}!`, 'success');
        }

        function startAIProgression() {
            console.log('🤖 Starting AI progression with difficulty:', gameState.aiDifficulty);
            
            const settings = aiDifficultySettings[gameState.aiDifficulty];
            
            gameState.aiTeams.forEach((aiTeam, index) => {
                // Schedule first seal for each AI team with some initial delay and randomization
                const initialDelay = (index + 1) * 2000 + Math.random() * 5000; // 2-7 seconds staggered start
                
                setTimeout(() => {
                    if (gameState.isGameActive) {
                        scheduleNextAISeal(aiTeam);
                    }
                }, initialDelay);
            });
        }

        function scheduleNextAISeal(aiTeam) {
            // Enhanced check to prevent scheduling after game ends
            if (!gameState.isGameActive) {
                console.log(`🛑 Not scheduling next seal for ${aiTeam.name} - game inactive`);
                return;
            }
            
            if (aiTeam.score >= 7) {
                console.log(`🛑 Not scheduling next seal for ${aiTeam.name} - already completed`);
                return;
            }

            const settings = aiDifficultySettings[gameState.aiDifficulty];
            
            // Calculate next seal time with variance
            const baseTime = settings.minTime + Math.random() * (settings.maxTime - settings.minTime);
            const variance = (Math.random() - 0.5) * 2 * settings.variance; // -variance to +variance
            const nextSealTime = baseTime * (1 + variance);
            
            console.log(`🤖 ${aiTeam.name} next seal in ${Math.round(nextSealTime/1000)}s`);
            
            const timer = setTimeout(() => {
                // Triple check before executing - game state can change
                if (gameState.isGameActive && aiTeam.score < 7) {
                    completeAISeal(aiTeam);
                } else {
                    console.log(`🛑 ${aiTeam.name} timer fired but game inactive or team completed`);
                }
            }, nextSealTime);
            
            // Store timer for cleanup only if game is still active
            if (gameState.isGameActive) {
                gameState.aiTimers.push(timer);
                aiTeam.nextSealTime = Date.now() + nextSealTime;
            } else {
                // Clear the timer immediately if game became inactive
                clearTimeout(timer);
            }
        }

        function completeAISeal(aiTeam) {
            // CRITICAL: Double check game is still active - player might have won
            if (!gameState.isGameActive) {
                console.log(`🛑 ${aiTeam.name} seal completion cancelled - game already ended`);
                return;
            }
            
            if (aiTeam.score >= 7) {
                console.log(`🛑 ${aiTeam.name} already completed all seals`);
                return;
            }

            const sealNumber = aiTeam.score + 1;
            aiTeam.score = sealNumber;
            aiTeam.completedSeals.push(sealNumber);
            aiTeam.lastSealTime = Date.now();

            console.log(`🤖 ${aiTeam.name} completed seal ${sealNumber}!`);

            // Update UI only if game is still active
            if (gameState.isGameActive) {
                updateLeaderboard();
            }

            // Check for winner - but only if game is still active
            if (sealNumber === 7 && gameState.isGameActive) {
                console.log(`🏆 AI team ${aiTeam.name} completed all seals!`);
                const completionTime = Date.now() - gameState.startTime;
                
                // Final check before declaring AI winner - ensure player hasn't already won
                const playerTeam = gameState.teams.find(team => !team.isAI);
                if (playerTeam && playerTeam.score >= 7) {
                    console.log(`🛑 Player already won - ignoring AI completion`);
                    return;
                }
                
                handleAIGameEnd(aiTeam, completionTime);
            } else if (gameState.isGameActive) {
                // Schedule next seal only if game is still active
                scheduleNextAISeal(aiTeam);
            }
        }

        function handleAIGameEnd(winningTeam, completionTime) {
            console.log('🏆 handleAIGameEnd called');
            console.log('🏆 AI Game ended, winner:', winningTeam ? winningTeam.name : 'Unknown');
            console.log('🏆 Winning team details:', winningTeam);
            console.log('🏆 Completion time:', completionTime);
            console.log('🏆 Current teams state:', gameState.teams);
            
            // Ensure game is marked as inactive
            gameState.isGameActive = false;
            
            // Clear all AI timers to stop further AI progression
            if (gameState.aiTimers && gameState.aiTimers.length > 0) {
                console.log('🛑 Clearing', gameState.aiTimers.length, 'AI timers');
                gameState.aiTimers.forEach(timer => clearTimeout(timer));
                gameState.aiTimers = [];
            }
            
            // Calculate final rankings
            console.log('📊 Calculating final rankings...');
            const finalRankings = calculateAIFinalRankings();
            console.log('📊 Final rankings calculated:', finalRankings);
            
            // Show winner modal with rankings
            const isPlayerWinner = !winningTeam.isAI;
            console.log('🎉 Showing winner modal - Is player winner?', isPlayerWinner);
            console.log('🎉 Winner team name:', winningTeam.name);
            console.log('🎉 Final rankings:', finalRankings);
            
            try {
                // Force display of winner modal
                console.log('🚀 FORCING WINNER MODAL DISPLAY');
                showWinnerModalWithRankings(winningTeam.name, completionTime, finalRankings, isPlayerWinner);
                console.log('✅ Winner modal displayed successfully');
            } catch (error) {
                console.error('❌ Error showing winner modal:', error);
                console.error('❌ Error details:', error.stack);
                
                // Enhanced fallback - show both alert and try simple modal
                showAlert(`🏆 GAME OVER! ${winningTeam.name} WINS! Time: ${Math.floor(completionTime/60000)}:${Math.floor((completionTime%60000)/1000).toString().padStart(2,'0')}`, 'success');
                
                // Try showing the simple winner modal as backup
                try {
                    showWinnerModal(winningTeam.name, completionTime, isPlayerWinner);
                } catch (fallbackError) {
                    console.error('❌ Fallback modal also failed:', fallbackError);
                }
            }
            
            // Lock game inputs
            console.log('🔒 Locking game inputs...');
            lockGameInputs();
            console.log('✅ AI game end handling complete');
        }

        function calculateAIFinalRankings() {
            console.log('📊 Calculating AI game final rankings');
            console.log('📊 gameState.teams:', gameState.teams);
            console.log('📊 gameState.completedSeals:', gameState.completedSeals);
            
            const rankings = gameState.teams.map(team => {
                // For the player team, use gameState.completedSeals.length as authoritative source
                let sealsCompleted = team.score;
                if (!team.isAI && team.name === gameState.currentTeam) {
                    sealsCompleted = Math.max(team.score, gameState.completedSeals.length);
                    console.log(`📊 Player team ${team.name}: score=${team.score}, gameState=${gameState.completedSeals.length}, using=${sealsCompleted}`);
                }
                
                return {
                    teamName: team.name,
                    sealsCompleted: sealsCompleted,
                    completionTime: sealsCompleted === 7 ? (Date.now() - gameState.startTime) : null,
                    lastSealTime: team.lastSealTime || Date.now(),
                    completed: sealsCompleted === 7,
                    isAI: team.isAI || false
                };
            });

            // Sort rankings: completed first, then by seals, then by completion/last seal time
            rankings.sort((a, b) => {
                if (a.completed && !b.completed) return -1;
                if (!a.completed && b.completed) return 1;
                
                if (a.sealsCompleted !== b.sealsCompleted) {
                    return b.sealsCompleted - a.sealsCompleted;
                }
                
                if (a.completed && b.completed && a.completionTime && b.completionTime) {
                    return a.completionTime - b.completionTime;
                }
                
                if (a.lastSealTime && b.lastSealTime) {
                    return a.lastSealTime - b.lastSealTime;
                }
                
                return 0;
            });

            rankings.forEach((team, index) => {
                team.rank = index + 1;
            });

            console.log('🏆 AI Final rankings:', rankings);
            return rankings;
        }

        // Old question system removed - using enhanced challenges from game-data.js

        // Use enhanced seals from game-data.js - no redeclaration needed
        function getSeals() {
            return window.GameData ? window.GameData.seals : [];
        }

        function renderSeals() {
            const sealsGrid = document.getElementById('sealsGrid');
            sealsGrid.innerHTML = '';

            const seals = getSeals();
            seals.forEach(seal => {
                const sealElement = document.createElement('div');
                sealElement.className = `seal ${gameState.completedSeals.includes(seal.id) ? 'opened' : ''}`;
                sealElement.setAttribute('data-challenge-type', seal.challengeType);
                sealElement.setAttribute('data-seal-id', seal.id);
                sealElement.onclick = () => openSeal(seal.id);

                sealElement.innerHTML = `
                    <div class="seal-number">${seal.id}</div>
                    <div class="seal-title">${seal.title}</div>
                    <div class="seal-theme">${seal.theme}</div>
                    <div class="challenge-type-indicator">${seal.challengeType}</div>
                `;

                sealsGrid.appendChild(sealElement);
            });
        }



        // Enhanced seal completion function for new challenge system
        function completeSeal(sealId) {
            console.log('🔓 Completing seal:', sealId);
            
            if (!gameState.completedSeals.includes(sealId)) {
                gameState.completedSeals.push(sealId);
                console.log('✅ Seal completed, total seals:', gameState.completedSeals.length);
                
                // Update player team score in AI mode
                if (gameState.mode === 'ai') {
                    const currentTeam = gameState.teams.find(team => team.name === gameState.currentTeam);
                    if (currentTeam) {
                        currentTeam.score = gameState.completedSeals.length;
                        currentTeam.completedSeals = [...gameState.completedSeals];
                        currentTeam.lastSealTime = Date.now();
                        console.log('🏆 Updated player team score:', currentTeam.score);
                    }
                    
                    // Update leaderboard immediately
                    updateLeaderboard();
                }
                
                // Update progress
                updateProgress();
                renderSeals();
                
                // Close the modal
                document.getElementById('puzzleModal').style.display = 'none';
                
                // Check if all seals are completed
                if (gameState.completedSeals.length === 7) {
                    finishGame();
                }
                
                // For multiplayer, update Firebase
                if (gameState.roomCode && database) {
                    updateMultiplayerProgress();
                }
            }
        }

        // Make completeSeal available globally for the enhanced challenge system
        window.completeSeal = completeSeal;

        function submitAnswer() {
            // Check if game is still active
            if (!gameState.isGameActive) {
                showAlert('Game has ended. No more answers can be submitted!', 'error');
                closePuzzle();
                return;
            }
            
            const answer = document.getElementById('puzzleAnswer').value.trim().toLowerCase();
            const correctAnswers = gameState.currentPuzzle.answer;

            if (correctAnswers.some(correct => answer.includes(correct))) {
                // Correct answer
                gameState.completedSeals.push(gameState.currentPuzzle.number);

                // Update team score
                const currentTeam = gameState.teams.find(team => team.name === gameState.currentTeam);
                if (currentTeam) {
                    currentTeam.score = gameState.completedSeals.length;
                    currentTeam.completedSeals = [...gameState.completedSeals];
                    // For AI mode, also update lastSealTime for proper ranking
                    if (gameState.mode === 'ai') {
                        currentTeam.lastSealTime = Date.now();
                    }
                }

                console.log('🎯 SEAL COMPLETED - Mode:', gameState.mode, 'Team:', gameState.currentTeam, 'Score:', gameState.completedSeals.length);
                
                // AGGRESSIVE IMMEDIATE WINNER CHECK - FIRST PRIORITY BEFORE ANYTHING ELSE
                if (gameState.mode === 'ai' && gameState.completedSeals.length === 7) {
                    console.log('🚨 IMMEDIATE AI MODE WIN DETECTED - FORCING WINNER MODAL NOW!');
                    
                    // Stop everything immediately
                    gameState.isGameActive = false;
                    
                    // Clear all AI timers
                    if (gameState.aiTimers) {
                        gameState.aiTimers.forEach(timer => clearTimeout(timer));
                        gameState.aiTimers = [];
                    }
                    
                    // Force immediate winner handling
                    const elapsed = Date.now() - gameState.startTime;
                    const playerTeam = gameState.teams.find(team => !team.isAI) || { 
                        name: gameState.currentTeam, 
                        isAI: false, 
                        score: 7,
                        completedSeals: [...gameState.completedSeals],
                        lastSealTime: Date.now()
                    };
                    
                    console.log('🏆 CALLING DIRECT WINNER MODAL DISPLAY');
                    
                    // Calculate rankings immediately
                    const finalRankings = gameState.teams.map(team => ({
                        teamName: team.name,
                        sealsCompleted: team.name === gameState.currentTeam ? 7 : (team.score || 0),
                        completionTime: team.name === gameState.currentTeam ? elapsed : null,
                        lastSealTime: team.lastSealTime || Date.now(),
                        completed: team.name === gameState.currentTeam,
                        isAI: team.isAI || false,
                        rank: 0
                    })).sort((a, b) => {
                        if (a.completed && !b.completed) return -1;
                        if (!a.completed && b.completed) return 1;
                        if (a.sealsCompleted !== b.sealsCompleted) return b.sealsCompleted - a.sealsCompleted;
                        return (a.completionTime || 999999) - (b.completionTime || 999999);
                    }).map((team, index) => ({ ...team, rank: index + 1 }));
                    
                    // Show winner modal immediately
                    try {
                        showWinnerModalWithRankings(gameState.currentTeam, elapsed, finalRankings, true);
                        lockGameInputs();
                        console.log('✅ Winner modal displayed successfully - GAME WON!');
                    } catch (error) {
                        console.error('Winner modal failed:', error);
                        alert(`🏆 CONGRATULATIONS! You won in ${Math.floor(elapsed/60000)}:${Math.floor((elapsed%60000)/1000).toString().padStart(2,'0')}!`);
                    }
                    
                    return; // EXIT IMMEDIATELY - NO FURTHER CODE EXECUTION
                }

                // Update Firebase if in multiplayer (check for roomCode instead of mode)
                if (gameState.roomCode && gameState.currentTeam) {
                    console.log('🔥 UPDATING FIREBASE - Seal completed:', gameState.currentPuzzle.number);
                    console.log('🔥 Total seals completed:', gameState.completedSeals.length);
                    updateTeamProgressInFirebase();
                }

                closePuzzle();
                renderSeals();
                updateProgress();
                updateLeaderboard();

                showAlert(`Seal ${gameState.currentPuzzle ? gameState.currentPuzzle.number : 'Unknown'} opened!`, 'success');

                // Enhanced check for 7-seal completion
                console.log('🔍 CHECKING COMPLETION - Seals completed:', gameState.completedSeals.length, 'Total:', gameState.completedSeals);
                
                if (gameState.completedSeals.length === 7) {
                    console.log('🎉 TEAM COMPLETED ALL 7 SEALS!', gameState.currentTeam);
                    console.log('🎮 Game Mode:', gameState.mode);
                    console.log('🎮 Room code:', gameState.roomCode);
                    console.log('🔥 Is multiplayer?', !!gameState.roomCode);
                    console.log('🤖 Is AI mode?', gameState.mode === 'ai');
                    console.log('🏆 Is game still active?', gameState.isGameActive);
                    
                    // Enhanced AI mode handling with immediate winner declaration
                    if (gameState.mode === 'ai') {
                        console.log('🏆 AI MODE: Player wins by completing 7 seals first!');
                        
                        // CRITICAL: Immediately stop the game and clear all AI timers to prevent race conditions
                        gameState.isGameActive = false;
                        if (gameState.aiTimers && gameState.aiTimers.length > 0) {
                            console.log('🛑 EMERGENCY: Clearing', gameState.aiTimers.length, 'AI timers to prevent race condition');
                            gameState.aiTimers.forEach(timer => clearTimeout(timer));
                            gameState.aiTimers = [];
                        }
                        
                        // Force immediate winner handling for player
                        console.log('🚀 FORCING IMMEDIATE PLAYER VICTORY HANDLING');
                        const elapsed = Date.now() - gameState.startTime;
                        const playerTeam = gameState.teams.find(team => !team.isAI) || { name: gameState.currentTeam, isAI: false };
                        
                        // Update player team with completion data
                        if (playerTeam) {
                            playerTeam.score = 7;
                            playerTeam.completedSeals = [...gameState.completedSeals];
                            playerTeam.lastSealTime = Date.now();
                            console.log('✅ Final player team state:', playerTeam);
                        }
                        
                        // Immediate winner modal display
                        console.log('🏆 CALLING handleAIGameEnd IMMEDIATELY');
                        handleAIGameEnd(playerTeam, elapsed);
                        
                    } else {
                        console.log('📞 Calling finishGame() for non-AI mode');
                        finishGame();
                    }
                } else {
                    console.log('🔄 Not enough seals yet:', gameState.completedSeals.length, '< 7');
                }
            } else {
                showAlert('Incorrect answer. Try again!', 'error');
                document.getElementById('puzzleAnswer').focus();
            }
        }

        async function updateTeamProgressInFirebase() {
            if (!gameState.roomCode || !gameState.currentTeam) return;

            const teamData = {
                score: gameState.completedSeals.length,
                completedSeals: gameState.completedSeals,
                lastUpdate: firebase.database.ServerValue.TIMESTAMP,
                lastSealTime: Date.now() // Track when this seal was completed for tiebreaking
            };

            console.log('💾 FIREBASE UPDATE: Updating team progress...', teamData);
            console.log('📍 FIREBASE UPDATE: Path:', `rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`);

            try {
                await database.ref(`rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`).update(teamData);
                console.log('✅ FIREBASE UPDATE: Team progress updated successfully');
                
                // CRITICAL: Check for winner after EACH seal completion, not just at the end
                if (gameState.completedSeals.length === 7 && gameState.isGameActive) {
                    console.log('🏆 FIREBASE UPDATE: Team completed 7 seals - checking for winner!');
                    const elapsed = Date.now() - gameState.startTime;
                    await checkForGameWinner(elapsed);
                }
            } catch (error) {
                console.error('❌ FIREBASE UPDATE: Failed to update team progress:', error);
            }
        }

        function closePuzzle() {
            document.getElementById('puzzleModal').style.display = 'none';
            gameState.currentPuzzle = null;
        }

        function updateProgress() {
            const completed = gameState.completedSeals.length;
            const total = 7; // Always 7 seals
            const percentage = (completed / total) * 100;

            document.getElementById('progressText').textContent = `${completed}/${total} Seals`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }

        function updateLeaderboard() {
            console.log('📊 updateLeaderboard() called');
            console.log('📊 gameState.teams:', gameState.teams);
            console.log('📊 gameState.completedSeals:', gameState.completedSeals);
            console.log('📊 gameState.currentTeam:', gameState.currentTeam);
            
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;
            
            leaderboardList.innerHTML = '';

            // Use teams directly - AI teams are already included in gameState.teams
            let allTeams = [...gameState.teams];

            console.log('📊 All teams before sort:', allTeams);

            // Sort teams by score (descending)
            const sortedTeams = allTeams.sort((a, b) => b.score - a.score);

            sortedTeams.forEach((team, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                const isCurrentTeam = team.name === gameState.currentTeam;
                const teamLabel = isCurrentTeam ? ' (You)' : (team.isAI ? ' 🤖' : '');
                item.innerHTML = `
                    <span class="leaderboard-rank">#${index + 1}</span>
                    <span class="leaderboard-name">${team.name}${teamLabel}</span>
                    <span class="leaderboard-score">${team.score}/7</span>
                `;
                leaderboardList.appendChild(item);
            });
        }

        // CRITICAL: Update leaderboard with LIVE Firebase data for real-time sync
        function updateLeaderboardFromFirebase(firebaseTeams) {
            console.log('📊 FIREBASE LEADERBOARD: Updating with live data', firebaseTeams);
            
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) {
                console.log('📊 FIREBASE LEADERBOARD: Leaderboard element not found');
                return;
            }
            
            leaderboardList.innerHTML = '';

            // Convert Firebase teams object to array and sort by score
            const teamsArray = Object.entries(firebaseTeams).map(([teamId, teamData]) => ({
                id: teamId,
                name: teamData.name || teamId,
                score: teamData.score || (teamData.completedSeals ? teamData.completedSeals.length : 0),
                completedSeals: teamData.completedSeals || [],
                isHost: teamData.isHost || false
            }));

            // Sort by score (descending)
            const sortedTeams = teamsArray.sort((a, b) => b.score - a.score);
            
            console.log('📊 FIREBASE LEADERBOARD: Sorted teams:', sortedTeams);

            sortedTeams.forEach((team, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                const isCurrentTeam = team.name === gameState.currentTeam;
                item.innerHTML = `
                    <span class="leaderboard-rank">#${index + 1}</span>
                    <span class="leaderboard-name">${team.name}${isCurrentTeam ? ' (YOU)' : ''}</span>
                    <span class="leaderboard-score">${team.score}/7</span>
                `;
                leaderboardList.appendChild(item);
            });
            
            console.log('📊 FIREBASE LEADERBOARD: Leaderboard updated successfully');
        }

        function startTimer() {
            const timerElement = document.getElementById('timer');

            setInterval(() => {
                if (gameState.isGameActive && gameState.startTime) {
                    const elapsed = Date.now() - gameState.startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function finishGame() {
            console.log('🏁 finishGame() called');
            console.log('🎮 gameState.mode:', gameState.mode);
            console.log('👥 gameState.currentTeam:', gameState.currentTeam);
            console.log('📊 gameState.teams:', gameState.teams);
            console.log('🏆 gameState.isGameActive:', gameState.isGameActive);
            
            const elapsed = Date.now() - gameState.startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            if (gameState.mode === 'ai') {
                // AI mode - player won!
                console.log('🏆 AI mode - player completed all seals first!');
                
                // Find and update the player team
                const playerTeam = gameState.teams.find(team => !team.isAI);
                console.log('🎯 Found player team:', playerTeam);
                
                if (playerTeam) {
                    // Ensure player team has correct completion data
                    playerTeam.score = Math.max(playerTeam.score, 7); // Ensure it's 7
                    playerTeam.completedSeals = [...gameState.completedSeals];
                    playerTeam.lastSealTime = Date.now();
                    console.log('✅ Updated player team:', playerTeam);
                }
                
                // End the game and show winner modal
                console.log('🎉 Calling handleAIGameEnd for player victory');
                handleAIGameEnd(playerTeam || { name: gameState.currentTeam, isAI: false }, elapsed);
                
            } else if (gameState.roomCode) {
                // Multiplayer mode - winner detection handled in Firebase update
                console.log('🏆 Multiplayer mode - winner detection handled in Firebase update');
            } else {
                // Single player mode - show proper completion screen
                console.log('🎮 Single player mode - showing completion screen');
                gameState.isGameActive = false;
                
                // Show completion modal with proper victory screen
                const completionModal = `
                    <div id="completionModal" style="
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.9); display: flex; justify-content: center; 
                        align-items: center; z-index: 10000;">
                        <div style="
                            background: linear-gradient(145deg, #2c1810, #3a1f12);
                            border: 3px solid #ffd700; border-radius: 15px; padding: 40px;
                            text-align: center; max-width: 600px; width: 95%;
                            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3);">
                            <h2 style="color: #ffd700; font-size: 2.5em; margin-bottom: 20px; 
                                       text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">🏆 VICTORY! 🏆</h2>
                            <div style="margin: 20px 0;">
                                <div style="font-size: 1.4em; color: #c9a96e; margin-bottom: 15px; font-weight: bold;">
                                    🎉 Congratulations! All Seven Seals Unlocked! 🎉
                                </div>
                                <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid #c9a96e; 
                                            border-radius: 8px; padding: 15px; margin: 15px 0;">
                                    <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Team:</strong> ${gameState.currentTeam}</p>
                                    <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Completion Time:</strong> ${minutes}:${seconds.toString().padStart(2, '0')}</p>
                                    <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Seals Completed:</strong> 7/7</p>
                                </div>
                                <div style="font-size: 1.1em; color: #b8a082; line-height: 1.5; margin: 20px 0;">
                                    You have successfully unlocked all the mysteries of the Seven Seals!<br>
                                    The ancient wisdom is now yours to keep.
                                </div>
                            </div>
                            <div style="margin-top: 30px;">
                                <button onclick="closeCompletionModal(); goBack();" style="
                                    background: #d4af37; color: #2c1810; border: none; padding: 12px 24px;
                                    border-radius: 5px; font-size: 1.1em; cursor: pointer; font-weight: bold; margin: 0 10px;">
                                    🎮 Play Again
                                </button>
                                <button onclick="closeCompletionModal();" style="
                                    background: #6b4d37; color: #f4f1e8; border: none; padding: 12px 24px;
                                    border-radius: 5px; font-size: 1.1em; cursor: pointer; font-weight: bold; margin: 0 10px;">
                                    ⚡ Continue
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', completionModal);
                
                // Auto-close after 60 seconds
                setTimeout(() => {
                    closeCompletionModal();
                }, 60000);
            }
        }

        // Close completion modal
        function closeCompletionModal() {
            const modal = document.getElementById('completionModal');
            if (modal) {
                modal.remove();
            }
        }

        // Enhanced winner detection and ranking system for multi-team scenarios
        async function checkForGameWinner(completionTime) {
            try {
                console.log('🏆 checkForGameWinner() called with time:', completionTime);
                console.log('📡 Database available?', !!database);
                console.log('🎮 Room code:', gameState.roomCode);
                
                if (!database || !gameState.roomCode) {
                    console.log('❌ Missing database or room code, returning');
                    return;
                }

                console.log('🏆 Checking for game winner...');
                
                // Mark this team as completed with timestamp and last seal time
                const teamCompletionData = {
                    completed: true,
                    completionTime: completionTime,
                    completedAt: firebase.database.ServerValue.TIMESTAMP,
                    finalScore: gameState.completedSeals.length,
                    lastSealTime: Date.now() // Track when last seal was clicked for tiebreaking
                };

                console.log('💾 Updating team data:', teamCompletionData);
                console.log('📍 Path:', `rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`);
                
                await database.ref(`rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`).update(teamCompletionData);
                console.log('✅ Team data updated successfully');

                // Check if this is the first team to complete
                console.log('🔍 Checking room data for other completed teams...');
                const roomSnapshot = await database.ref(`rooms/${gameState.roomCode}`).once('value');
                const roomData = roomSnapshot.val();
                
                console.log('📊 Current room data:', roomData);

                if (roomData && roomData.teams) {
                    // Check for teams that completed 7 seals
                    const teams = Object.values(roomData.teams);
                    const teamsWithSevenSeals = teams.filter(team => {
                        const sealsCount = team.completedSeals ? team.completedSeals.length : (team.score || 0);
                        return sealsCount >= 7 || team.completed;
                    });
                    
                    console.log('👥 All teams scores:', teams.map(t => ({ 
                        name: t.name, 
                        seals: t.completedSeals ? t.completedSeals.length : (t.score || 0),
                        completed: t.completed 
                    })));
                    console.log('🏁 Teams with 7 seals:', teamsWithSevenSeals.length);

                    if (teamsWithSevenSeals.length === 1) {
                        // This is the winner! End the game for everyone
                        console.log('🏆 First team to complete - declaring winner!');
                        
                        // Calculate final rankings for all teams
                        const finalRankings = await calculateFinalRankings(teams);
                        
                        const gameEndData = {
                            winner: gameState.currentTeam,
                            completionTime: completionTime,
                            endedAt: firebase.database.ServerValue.TIMESTAMP,
                            gameActive: false,
                            status: 'finished',
                            finalRankings: finalRankings
                        };

                        console.log('💾 Setting game end data:', gameEndData);
                        await database.ref(`rooms/${gameState.roomCode}`).update(gameEndData);
                        console.log('✅ Game end data saved to Firebase');
                        
                        // Show winner modal with rankings to all players
                        console.log('🎉 Showing winner modal with rankings...');
                        showWinnerModalWithRankings(gameState.currentTeam, completionTime, finalRankings, true);
                    } else if (teamsWithSevenSeals.length > 1) {
                        // Someone else already won - show existing rankings if available
                        console.log('🥈 Another team already won');
                        if (roomData.finalRankings) {
                            showWinnerModalWithRankings(roomData.winner, roomData.completionTime, roomData.finalRankings, false);
                        } else {
                            const winner = teamsWithSevenSeals[0];
                            showWinnerModal(winner.name || 'Another team', winner.completionTime || completionTime, false);
                        }
                    } else {
                        console.log('🔄 No teams with 7 seals yet');
                    }
                } else {
                    console.log('❌ No room data or teams found');
                }

            } catch (error) {
                console.error('Error checking for winner:', error);
                const minutes = Math.floor(completionTime / 60000);
                const seconds = Math.floor((completionTime % 60000) / 1000);
                showAlert(`🎉 Congratulations! All seals opened in ${minutes}:${seconds.toString().padStart(2, '0')}!`, 'success');
            }
        }

        // Calculate final rankings for all teams
        async function calculateFinalRankings(teams) {
            console.log('📊 Calculating final rankings for teams:', teams.length);
            
            const rankings = teams.map(team => {
                const sealsCount = team.completedSeals ? team.completedSeals.length : (team.score || 0);
                return {
                    teamName: team.name,
                    sealsCompleted: sealsCount,
                    completionTime: team.completionTime || null,
                    lastSealTime: team.lastSealTime || Date.now(),
                    completed: team.completed || false
                };
            });

            // Sort rankings:
            // 1. By completion status (completed teams first)
            // 2. By number of seals completed (higher is better)
            // 3. By completion time for completed teams (faster is better)
            // 4. By last seal time for incomplete teams (faster last seal is better)
            rankings.sort((a, b) => {
                // Completed teams come first
                if (a.completed && !b.completed) return -1;
                if (!a.completed && b.completed) return 1;
                
                // Both completed or both incomplete - sort by seals
                if (a.sealsCompleted !== b.sealsCompleted) {
                    return b.sealsCompleted - a.sealsCompleted; // Higher seals first
                }
                
                // Same number of seals - use time
                if (a.completed && b.completed && a.completionTime && b.completionTime) {
                    return a.completionTime - b.completionTime; // Faster completion first
                }
                
                // For incomplete teams with same seals, use last seal time
                if (a.lastSealTime && b.lastSealTime) {
                    return a.lastSealTime - b.lastSealTime; // Earlier last seal first
                }
                
                return 0;
            });

            // Add rank positions
            rankings.forEach((team, index) => {
                team.rank = index + 1;
            });

            console.log('🏆 Final rankings calculated:', rankings);
            return rankings;
        }

        // Enhanced winner modal with final rankings for multi-team scenarios
        function showWinnerModalWithRankings(winnerTeam, completionTime, rankings, isWinner) {
            console.log('🎉 showWinnerModalWithRankings() called');
            console.log('🏆 Winner team:', winnerTeam);
            console.log('⏰ Completion time:', completionTime);
            console.log('📊 Rankings:', rankings);
            console.log('🎯 Is winner?', isWinner);
            
            const minutes = Math.floor(completionTime / 60000);
            const seconds = Math.floor((completionTime % 60000) / 1000);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            const modalTitle = isWinner ? '🏆 CONGRATULATIONS!' : '🎮 GAME OVER';
            const modalMessage = isWinner ? 
                `YOUR TEAM HAS WON THE GAME!` : 
                `${winnerTeam} HAS WON THE GAME!`;

            // Generate rankings HTML
            let rankingsHTML = '';
            if (rankings && rankings.length > 0) {
                rankingsHTML = `
                    <div style="background: rgba(0, 0, 0, 0.4); border: 1px solid #c9a96e; 
                                border-radius: 8px; padding: 15px; margin: 15px 0; max-height: 250px; overflow-y: auto;">
                        <h3 style="color: #ffd700; margin-bottom: 15px; text-align: center;">🏅 Final Rankings</h3>
                        <div style="text-align: left;">
                `;
                
                rankings.forEach((team, index) => {
                    const rank = team.rank || (index + 1);
                    const isCurrentTeam = team.teamName === gameState.currentTeam;
                    const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `${rank}.`;
                    const completionDisplay = team.completed ? 
                        `✅ ${Math.floor((team.completionTime || 0) / 60000)}:${Math.floor(((team.completionTime || 0) % 60000) / 1000).toString().padStart(2, '0')}` : 
                        `⏱️ ${team.sealsCompleted}/7 seals`;
                    const teamLabel = isCurrentTeam ? ' (YOU)' : (team.isAI ? ' 🤖' : '');
                    
                    rankingsHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; 
                                    padding: 8px 12px; margin: 5px 0; background: rgba(0, 0, 0, 0.2); 
                                    border-radius: 5px; ${isCurrentTeam ? 'border: 1px solid #ffd700;' : ''}">
                            <span style="color: #ffd700; font-weight: bold; min-width: 30px;">${medal}</span>
                            <span style="color: ${isCurrentTeam ? '#ffd700' : '#e8dcc0'}; flex: 1; margin: 0 10px; font-weight: ${isCurrentTeam ? 'bold' : 'normal'};">
                                ${team.teamName}${teamLabel}
                            </span>
                            <span style="color: #c9a96e; font-size: 0.9em;">${completionDisplay}</span>
                        </div>
                    `;
                });
                
                rankingsHTML += `
                        </div>
                    </div>
                `;
            }
                
            console.log('🎨 Creating enhanced modal with rankings');

            const modalHTML = `
                <div id="winnerModal" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                    align-items: center; z-index: 10000;">
                    <div style="
                        background: linear-gradient(145deg, #2c1810, #3a1f12);
                        border: 3px solid #ffd700; border-radius: 15px; padding: 30px;
                        text-align: center; max-width: 600px; width: 95%; max-height: 90%; overflow-y: auto;
                        box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3);">
                        <h2 style="color: #ffd700; font-size: 2.5em; margin-bottom: 20px; 
                                   text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${modalTitle}</h2>
                        <div style="margin: 20px 0;">
                            <div style="font-size: 1.4em; color: #c9a96e; margin-bottom: 15px; font-weight: bold;">
                                ${modalMessage}
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid #c9a96e; 
                                        border-radius: 8px; padding: 15px; margin: 15px 0;">
                                <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Winning Team:</strong> ${winnerTeam}</p>
                                <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Completion Time:</strong> ${timeString}</p>
                            </div>
                            ${rankingsHTML}
                        </div>
                        <button onclick="closeWinnerModal()" style="
                            background: #d4af37; color: #2c1810; border: none; padding: 12px 24px;
                            border-radius: 5px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                            Return to Lobby
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Lock the game for all players
            lockGameInputs();

            // Auto-close after 45 seconds (more time to view rankings)
            setTimeout(() => {
                closeWinnerModal();
            }, 45000);
        }

        // Show winner modal to all players (legacy function for backward compatibility)
        function showWinnerModal(winnerTeam, completionTime, isWinner) {
            console.log('🎉 showWinnerModal() called');
            console.log('🏆 Winner team:', winnerTeam);
            console.log('⏰ Completion time:', completionTime);
            console.log('🎯 Is winner?', isWinner);
            
            const minutes = Math.floor(completionTime / 60000);
            const seconds = Math.floor((completionTime % 60000) / 1000);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            const modalTitle = isWinner ? '🏆 CONGRATULATIONS!' : '🎮 GAME OVER';
            const modalMessage = isWinner ? 
                `Your team has won the game!` : 
                `${winnerTeam} has won the game!`;
                
            console.log('🎨 Creating modal with title:', modalTitle);

            const modalHTML = `
                <div id="winnerModal" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                    align-items: center; z-index: 10000;">
                    <div style="
                        background: linear-gradient(145deg, #2c1810, #3a1f12);
                        border: 3px solid #ffd700; border-radius: 15px; padding: 30px;
                        text-align: center; max-width: 500px; width: 90%;
                        box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3);">
                        <h2 style="color: #ffd700; font-size: 2.5em; margin-bottom: 20px; 
                                   text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${modalTitle}</h2>
                        <div style="margin: 20px 0;">
                            <div style="font-size: 1.4em; color: #c9a96e; margin-bottom: 15px; font-weight: bold;">
                                ${modalMessage}
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid #c9a96e; 
                                        border-radius: 8px; padding: 15px; margin: 15px 0;">
                                <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Winning Team:</strong> ${winnerTeam}</p>
                                <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Completion Time:</strong> ${timeString}</p>
                            </div>
                        </div>
                        <button onclick="closeWinnerModal()" style="
                            background: #d4af37; color: #2c1810; border: none; padding: 12px 24px;
                            border-radius: 5px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                            Return to Lobby
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Lock the game for all players
            lockGameInputs();

            // Auto-close after 30 seconds
            setTimeout(() => {
                closeWinnerModal();
            }, 30000);
        }

        // Lock game inputs when game ends
        function lockGameInputs() {
            gameState.isGameActive = false;
            
            // Disable all seal buttons
            const sealButtons = document.querySelectorAll('.seal');
            sealButtons.forEach(button => {
                button.onclick = null;
                button.style.pointerEvents = 'none';
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            });

            // Close any open puzzle modals
            const puzzleModal = document.getElementById('puzzleModal');
            if (puzzleModal) {
                puzzleModal.style.display = 'none';
            }

            // Add visual indicator that game has ended
            const gameContainer = document.getElementById('gameContainer');
            if (gameContainer) {
                gameContainer.style.filter = 'grayscale(30%)';
                
                // Add overlay message
                const overlay = document.createElement('div');
                overlay.id = 'gameEndOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.3);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 5000;
                    pointer-events: none;
                `;
                overlay.innerHTML = `
                    <div style="
                        background: rgba(139, 0, 0, 0.9);
                        color: #ffd700;
                        padding: 20px 40px;
                        border-radius: 10px;
                        border: 2px solid #ffd700;
                        font-size: 1.5em;
                        font-weight: bold;
                        text-align: center;
                        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                    ">
                        🔒 GAME ENDED
                        <br>
                        <span style="font-size: 0.7em; margin-top: 10px; display: block;">
                            A team has completed all seven seals
                        </span>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            console.log('🔒 Game inputs locked - game has ended');
        }

        // Close winner modal
        function closeWinnerModal() {
            const modal = document.getElementById('winnerModal');
            if (modal) {
                modal.remove();
            }
            
            // Clean up game end overlay
            const overlay = document.getElementById('gameEndOverlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Reset game container filter
            const gameContainer = document.getElementById('gameContainer');
            if (gameContainer) {
                gameContainer.style.filter = '';
            }
            
            // Go back to lobby
            showLobby();
        }

        function resetGameState() {
            // Generate new random questions for replayability
            if (gameOptions.randomMode) {
                window.PuzzleManager.regeneratePuzzles();
            }
            
            gameState.completedSeals = [];
            gameState.isGameActive = false;
            gameState.startTime = null;

            // Reset team scores
            gameState.teams.forEach(team => {
                team.score = 0;
                team.completedSeals = [];
            });

            renderSeals();
            updateProgress();
            updateLeaderboard();

            document.getElementById('timer').textContent = '00:00';
            showAlert('Game reset! Fresh challenges await!', 'success');
        }

        function goBack() {
            // Clean up Firebase listeners
            if (gameState.roomRef) {
                gameState.roomRef.off();
                gameState.roomRef = null;
            }

            // Clean up AI timers
            if (gameState.aiTimers) {
                gameState.aiTimers.forEach(timer => clearTimeout(timer));
                gameState.aiTimers = [];
            }

            // Hide all game sections
            document.getElementById('multiplayerSetup').style.display = 'none';
            document.getElementById('aiSetup').style.display = 'none';
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'none';

            // Show mode selection
            document.getElementById('modeSelection').style.display = 'grid';

            // Reset game state
            gameState = {
                mode: '',
                currentTeam: '',
                teams: [],
                completedSeals: [],
                startTime: null,
                currentPuzzle: null,
                isGameActive: false,
                roomCode: '',
                isHost: false,
                roomRef: null,
                // AI Mode specific
                aiTeams: [],
                aiTimers: [],
                aiDifficulty: 'medium'
            };

            // Clear URL parameters
            window.history.pushState({}, '', window.location.pathname);
        }

        function copyRoomLink() {
            const shareLink = document.getElementById('shareLink').textContent;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareLink).then(() => {
                    showAlert('Room link copied to clipboard!', 'success');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('Room link copied to clipboard!', 'success');
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            document.body.appendChild(alert);

            setTimeout(() => alert.classList.add('show'), 100);

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => document.body.removeChild(alert), 300);
            }, 3000);
        }

        // Universal Game Options - Available in all modes
        let gameOptions = {
            hintsEnabled: false,
            randomMode: true,
            detailedProgress: true
        };

        // Complexity system
        let gameComplexity = {
            level: 'intermediate',
            selectedMode: null,
            settings: {
                beginner: {
                    hintsAvailable: true,
                    answerTolerance: 'high',
                    timeMultiplier: 1.5,
                    puzzleComplexity: 'simple',
                    encouragement: true
                },
                intermediate: {
                    hintsAvailable: true,
                    answerTolerance: 'medium',
                    timeMultiplier: 1.0,
                    puzzleComplexity: 'mixed',
                    encouragement: false
                },
                advanced: {
                    hintsAvailable: false,
                    answerTolerance: 'low',
                    timeMultiplier: 0.8,
                    puzzleComplexity: 'complex',
                    encouragement: false
                },
                expert: {
                    hintsAvailable: false,
                    answerTolerance: 'strict',
                    timeMultiplier: 0.6,
                    puzzleComplexity: 'maximum',
                    encouragement: false
                }
            }
        };

        // Load saved game options from localStorage
        function loadGameOptions() {
            try {
                const saved = localStorage.getItem('scrollGameOptions');
                if (saved) {
                    gameOptions = { ...gameOptions, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.log('Using default game options');
            }
            
            // Update UI toggles
            document.getElementById('hintsEnabled').checked = gameOptions.hintsEnabled;
            document.getElementById('randomMode').checked = gameOptions.randomMode;
            document.getElementById('detailedProgress').checked = gameOptions.detailedProgress;
        }

        // Save game options to localStorage
        function saveGameOptions() {
            localStorage.setItem('scrollGameOptions', JSON.stringify(gameOptions));
        }

        // Toggle sound functionality
        function toggleSound() {
            if (window.ImmersionEngine && window.ImmersionEngine.toggleSound) {
                const isEnabled = window.ImmersionEngine.toggleSound();
                document.getElementById('soundEnabled').checked = isEnabled;
                
                if (isEnabled) {
                    showAlert('🔊 Sound effects enabled', 'success');
                    // Play a test sound
                    window.ImmersionEngine.playSound('sealActivation');
                } else {
                    showAlert('🔇 Sound effects disabled', 'info');
                }
            } else {
                showAlert('🔇 Sound system not available', 'error');
                console.warn('⚠️ ImmersionEngine not available for sound toggle');
            }
        }

        // Toggle hints functionality
        function toggleHints() {
            gameOptions.hintsEnabled = document.getElementById('hintsEnabled').checked;
            saveGameOptions();
            
            if (gameOptions.hintsEnabled) {
                showAlert('💡 Enhanced hints enabled - additional guidance will be shown', 'success');
            } else {
                showAlert('💡 Enhanced hints disabled - pure challenge mode', 'info');
            }
            
            // Update any existing puzzle displays
            updatePuzzleHintsDisplay();
        }

        // Toggle random mode
        function toggleRandomMode() {
            gameOptions.randomMode = document.getElementById('randomMode').checked;
            saveGameOptions();
            
            if (gameOptions.randomMode) {
                showAlert('🔀 Random mode enabled - fresh puzzles each game!', 'success');
                // Regenerate puzzles for current game if already started
                if (gameState.isGameActive) {
                    window.PuzzleManager.regeneratePuzzles();
                }
            } else {
                showAlert('🔀 Random mode disabled - consistent puzzles', 'info');
            }
        }

        // Toggle detailed progress
        function toggleDetailedProgress() {
            gameOptions.detailedProgress = document.getElementById('detailedProgress').checked;
            saveGameOptions();
            
            if (gameOptions.detailedProgress) {
                showAlert('📊 Detailed progress enabled', 'success');
            } else {
                showAlert('📊 Detailed progress disabled', 'info');
            }
            
            updateProgressDisplay();
        }

        // Update puzzle hints display based on settings
        function updatePuzzleHintsDisplay() {
            const hintElements = document.querySelectorAll('.cipher-hint, .puzzle-hint, .challenge-hint');
            hintElements.forEach(hint => {
                hint.style.display = gameOptions.hintsEnabled ? 'block' : 'none';
            });
        }

        // Update progress display based on settings
        function updateProgressDisplay() {
            const progressText = document.getElementById('progressText');
            if (progressText && gameOptions.detailedProgress) {
                const completed = gameState.completedSeals.length;
                const elapsed = gameState.startTime ? Date.now() - gameState.startTime : 0;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                progressText.textContent = `${completed}/7 Seals (${minutes}:${seconds.toString().padStart(2, '0')})`;
            } else if (progressText) {
                progressText.textContent = `${gameState.completedSeals.length}/7 Seals`;
            }
        }

        // Initialize game options when game starts
        function initializeGameOptions() {
            loadGameOptions();
            
            // Initialize sound toggle
            if (window.ImmersionEngine) {
                document.getElementById('soundEnabled').checked = window.ImmersionEngine.soundEnabled;
            }
            
            // Apply random mode setting
            if (gameOptions.randomMode) {
                window.PuzzleManager.regeneratePuzzles();
            }
        }

        // Handle Enter key in inputs
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (e.target.id === 'puzzleAnswer') {
                    submitAnswer();
                }
            }
        });

        // Complexity Selection Functions
        function showComplexityModal(gameMode) {
            gameComplexity.selectedMode = gameMode;
            document.getElementById('complexityModal').style.display = 'flex';
            
            // Load saved complexity level
            const saved = localStorage.getItem('scrollComplexityLevel');
            if (saved) {
                gameComplexity.level = saved;
                selectComplexity(saved, false);
            }
        }

        function closeComplexityModal() {
            document.getElementById('complexityModal').style.display = 'none';
            gameComplexity.selectedMode = null;
            
            // Reset selection
            document.querySelectorAll('.complexity-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('confirmComplexity').disabled = true;
        }

        function selectComplexity(level, showFeedback = true) {
            gameComplexity.level = level;
            
            // Update UI
            document.querySelectorAll('.complexity-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`[data-complexity="${level}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            document.getElementById('confirmComplexity').disabled = false;
            
            if (showFeedback) {
                const complexityNames = {
                    beginner: 'Beginner - Guided Journey',
                    intermediate: 'Intermediate - Balanced Challenge', 
                    advanced: 'Advanced - Scholar\'s Trial',
                    expert: 'Expert - Master\'s Crucible'
                };
                
                showAlert(`🎯 Selected: ${complexityNames[level]}`, 'info');
            }
            
            // Save preference
            localStorage.setItem('scrollComplexityLevel', level);
        }

        function confirmComplexitySelection() {
            const mode = gameComplexity.selectedMode;
            const level = gameComplexity.level;
            
            if (!mode || !level) return;
            
            // Apply complexity settings
            applyComplexitySettings(level);
            
            closeComplexityModal();
            
            // Start the appropriate game mode
            switch(mode) {
                case 'single':
                    startSinglePlayer();
                    break;
                case 'ai':
                    startAIMode();
                    break;
                case 'multiplayer':
                    showMultiplayerChoice();
                    break;
                default:
                    console.error('Unknown game mode:', mode);
            }
        }

        function applyComplexitySettings(level) {
            const settings = gameComplexity.settings[level];
            
            // Apply settings to game options
            gameOptions.hintsEnabled = settings.hintsAvailable;
            document.getElementById('hintsEnabled').checked = settings.hintsAvailable;
            
            // Store complexity-specific settings
            gameState.complexity = {
                level: level,
                settings: settings
            };
            
            console.log(`🎯 Applied ${level} complexity settings:`, settings);
            showAlert(`⚔️ Challenge Level: ${level.toUpperCase()} - Settings Applied!`, 'success');
        }

        // selectMode function is defined earlier in the file - removed duplicate

        // Original game start functions (now called after complexity selection)
        function startSinglePlayer() {
            console.log('🎮 Starting Single Player with complexity:', gameComplexity.level);
            
            // Hide mode selection and show setup if needed
            document.getElementById('modeSelection').style.display = 'none';
            
            // Start game immediately for single player (no additional setup needed)
            initializeSinglePlayerGame();
        }

        function startAIMode() {
            console.log('🤖 Starting AI Mode with complexity:', gameComplexity.level);
            
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('aiSetup').style.display = 'block';
        }

        function showMultiplayerChoice() {
            console.log('🌐 Starting Multiplayer with complexity:', gameComplexity.level);
            
            // Show choice modal for create vs join
            const choiceModal = `
                <div id="multiplayerChoiceModal" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                    align-items: center; z-index: 1002;">
                    <div style="
                        background: linear-gradient(135deg, #2c1810, #4a3425);
                        border: 3px solid #d4af37; border-radius: 15px; padding: 40px;
                        text-align: center; max-width: 500px; width: 95%;">
                        <h2 style="color: #d4af37; font-size: 2em; margin-bottom: 30px;">🌐 Multiplayer Mode</h2>
                        <p style="color: #b8a082; margin-bottom: 30px; font-size: 1.1em;">
                            Would you like to create a new room or join an existing one?
                        </p>
                        <div style="display: flex; gap: 20px; justify-content: center;">
                            <button onclick="createMultiplayerRoom()" style="
                                background: #d4af37; color: #2c1810; border: none; padding: 15px 25px;
                                border-radius: 8px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                                🏠 Create Room
                            </button>
                            <button onclick="joinMultiplayerRoom()" style="
                                background: #6b4d37; color: #f4f1e8; border: none; padding: 15px 25px;
                                border-radius: 8px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                                🔗 Join Room
                            </button>
                        </div>
                        <button onclick="closeMultiplayerChoice()" style="
                            background: transparent; color: #b8a082; border: 1px solid #6b4d37; 
                            padding: 10px 20px; border-radius: 5px; font-size: 1em; cursor: pointer; 
                            margin-top: 20px;">
                            ← Back
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', choiceModal);
        }

        function closeMultiplayerChoice() {
            const modal = document.getElementById('multiplayerChoiceModal');
            if (modal) {
                modal.remove();
            }
        }

        function createMultiplayerRoom() {
            closeMultiplayerChoice();
            console.log('👥 Creating multiplayer room with complexity:', gameComplexity.level);
            
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('multiplayerSetup').style.display = 'block';
            
            // Show create room section
            document.getElementById('createRoom').style.display = 'block';
            document.getElementById('joinRoom').style.display = 'none';
        }

        function joinMultiplayerRoom() {
            closeMultiplayerChoice();
            console.log('🔗 Joining multiplayer room with complexity:', gameComplexity.level);
            
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('multiplayerSetup').style.display = 'block';
            
            // Show join room section
            document.getElementById('createRoom').style.display = 'none';
            document.getElementById('joinRoom').style.display = 'block';
        }

        // Initialize single player game
        function initializeSinglePlayerGame() {
            console.log('🎮 Initializing single player game...');
            
            // Set up basic game state
            gameState.mode = 'single';
            gameState.currentTeam = `Player Team`;
            gameState.teams = [
                {
                    name: gameState.currentTeam,
                    score: 0,
                    completedSeals: [],
                    isAI: false
                }
            ];
            gameState.startTime = Date.now();
            gameState.isGameActive = true;
            
            // Apply complexity settings to puzzle generation
            if (gameOptions.randomMode) {
                window.PuzzleManager.regeneratePuzzles();
            }
            
            // Show game interface
            document.getElementById('gameContainer').style.display = 'block';
            
            renderSeals();
            updateProgress();
            updateLeaderboard();
            
            showAlert(`🎮 Single Player Mode Started! Complexity: ${gameComplexity.level.toUpperCase()}`, 'success');
        }

        // Enhanced Drag and Drop Functionality
        function initializeDragAndDrop() {
            // Enable drag and drop for all draggable items
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('draggable-item') || e.target.classList.contains('drag-item')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', '');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('draggable-item') || e.target.classList.contains('drag-item')) {
                    e.target.classList.remove('dragging');
                }
            });

            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                // Find the drop zone
                let dropZone = null;
                if (e.target.classList.contains('category-drop-zone') || e.target.classList.contains('drop-zone')) {
                    dropZone = e.target;
                } else {
                    dropZone = e.target.closest('.category-drop-zone') || e.target.closest('.drop-zone');
                }
                
                if (dropZone) {
                    dropZone.classList.add('drag-over');
                    dropZone.style.backgroundColor = 'rgba(255, 215, 0, 0.2)';
                }
            });

            document.addEventListener('dragleave', function(e) {
                let dropZone = null;
                if (e.target.classList.contains('category-drop-zone') || e.target.classList.contains('drop-zone')) {
                    dropZone = e.target;
                }
                
                if (dropZone) {
                    dropZone.classList.remove('drag-over');
                    dropZone.style.backgroundColor = '';
                }
            });

            document.addEventListener('drop', function(e) {
                e.preventDefault();
                
                // Find the drop zone
                let dropZone = null;
                if (e.target.classList.contains('category-drop-zone') || e.target.classList.contains('drop-zone')) {
                    dropZone = e.target;
                } else {
                    dropZone = e.target.closest('.category-drop-zone') || e.target.closest('.drop-zone');
                }
                
                if (dropZone) {
                    dropZone.classList.remove('drag-over');
                    dropZone.style.backgroundColor = '';
                    
                    const draggedItem = document.querySelector('.dragging');
                    
                    if (draggedItem) {
                        // For biblical classification (Seal 4) - testament sorting
                        if (dropZone.hasAttribute('data-testament')) {
                            // Remove instruction text
                            const instruction = dropZone.querySelector('.drop-instruction');
                            if (instruction) {
                                instruction.style.display = 'none';
                            }
                            
                            // Add the dragged item to this drop zone
                            dropZone.appendChild(draggedItem);
                            dropZone.classList.add('filled');
                            
                            console.log('Item dropped:', draggedItem.textContent, 'into', dropZone.getAttribute('data-testament'));
                        }
                        // For chronological order - only allow one item per drop zone
                        else if (dropZone.hasAttribute('data-position')) {
                            // Remove any existing item from this drop zone
                            const existingItem = dropZone.querySelector('.draggable-item, .drag-item');
                            if (existingItem) {
                                // Move existing item back to pool
                                const pool = document.querySelector('.items-pool');
                                if (pool) {
                                    pool.appendChild(existingItem);
                                }
                            }
                            
                            // Add the dragged item to this drop zone
                            dropZone.appendChild(draggedItem);
                            dropZone.classList.add('filled');
                            updateDropZoneText(dropZone);
                        }
                        // For scripture topics - allow multiple items per topic
                        else if (dropZone.hasAttribute('data-topic')) {
                            dropZone.appendChild(draggedItem);
                            dropZone.classList.add('filled');
                            updateTopicDropZoneText(dropZone);
                        }
                    }
                }
            });
        }

        function updateDropZoneText(dropZone) {
            const draggedItem = dropZone.querySelector('.drag-item');
            if (draggedItem) {
                const position = dropZone.getAttribute('data-position');
                dropZone.innerHTML = '';
                dropZone.appendChild(draggedItem);
            } else {
                const position = dropZone.getAttribute('data-position');
                dropZone.innerHTML = `Drop event ${parseInt(position) + 1} here`;
                dropZone.classList.remove('filled');
            }
        }

        function updateTopicDropZoneText(dropZone) {
            const items = dropZone.querySelectorAll('.drag-item');
            if (items.length === 0) {
                const topicName = dropZone.getAttribute('data-topic');
                dropZone.innerHTML = `Drop ${topicName.toLowerCase()} verses here`;
                dropZone.classList.remove('filled');
            }
        }

        // Enhanced seal opening with immersive effects
        async function openSeal(sealId) {
            const seal = window.GameData.seals.find(s => s.id === sealId);
            if (!seal) return;

            // Check if game is still active
            if (!gameState.isGameActive) {
                showAlert('Game has ended. No more seals can be opened!', 'error');
                return;
            }
            
            if (gameState.completedSeals.includes(seal.id)) {
                showAlert('This seal is already opened!', 'error');
                return;
            }

            // Check if required seals are completed
            if (seal.requiredSeals && seal.requiredSeals.length > 0) {
                const missingSeals = seal.requiredSeals.filter(reqId => !gameState.completedSeals.includes(reqId));
                if (missingSeals.length > 0) {
                    showAlert(`Complete seals ${missingSeals.join(', ')} first!`, 'error');
                    return;
                }
            }
            
            // Find the seal element for visual effects (fix selector to work with onclick function)
            const sealElement = document.querySelector(`[data-seal-id="${sealId}"]`) || 
                               document.querySelector(`.seal:nth-child(${sealId})`);
            
            // Trigger immersive seal activation
            if (window.ImmersionEngine && sealElement) {
                await window.ImmersionEngine.triggerSealActivation(sealElement, sealId);
            }
            
            gameState.currentPuzzle = seal;
            
            // Enhanced title with immersive elements
            document.getElementById('puzzleTitle').innerHTML = `
                <span class="seal-activation-title">
                    <span class="seal-number-display">${seal.id}</span>
                    ${seal.title}
                </span>
            `;
            
            // Generate puzzle content (now with potential AI generation)
            const puzzleContent = await window.PuzzleManager.generatePuzzleContent(seal.id, seal.puzzle);
            document.getElementById('puzzleQuestion').innerHTML = puzzleContent;
            
            // Show modal with enhanced appearance
            const modal = document.getElementById('puzzleModal');
            modal.style.display = 'block';
            
            // Apply immersive modal effects
            if (window.ImmersionEngine) {
                window.ImmersionEngine.enhanceModalAppearance(modal, seal.puzzle);
            }
            
            // Initialize drag and drop for new content
            setTimeout(() => {
                initializeDragAndDrop();
                
                // Enhance drag and drop with visual effects
                if (window.ImmersionEngine) {
                    window.ImmersionEngine.enhanceDragAndDrop();
                }
            }, 100);
        }

        // Initialize game engines
        function initializeGameEngines() {
            try {
                // Initialize AI Engine
                if (typeof BibleGameAI !== 'undefined') {
                    window.BibleGameAI = new BibleGameAI();
                    console.log('✅ Bible Game AI initialized');
                } else {
                    console.warn('⚠️ BibleGameAI class not found');
                }

                // Initialize Immersion Engine
                if (typeof ImmersionEngine !== 'undefined') {
                    window.ImmersionEngine = new ImmersionEngine();
                    console.log('✅ Immersion Engine initialized');
                } else {
                    console.warn('⚠️ ImmersionEngine class not found');
                }
            } catch (error) {
                console.error('❌ Error initializing game engines:', error);
            }
        }

        // Spiritual Content Management
        const spiritualContent = {
            scriptureMotivations: [
                {
                    text: "Study to show yourself approved unto God, a workman that needs not to be ashamed, rightly dividing the word of truth.",
                    reference: "2 Timothy 2:15"
                },
                {
                    text: "Your word is a lamp unto my feet, and a light unto my path.",
                    reference: "Psalm 119:105"
                },
                {
                    text: "Faith comes by hearing, and hearing by the word of God.",
                    reference: "Romans 10:17"
                },
                {
                    text: "All Scripture is given by inspiration of God, and is profitable for doctrine, for reproof, for correction, for instruction in righteousness.",
                    reference: "2 Timothy 3:16"
                },
                {
                    text: "The entrance of Your words gives light; it gives understanding to the simple.",
                    reference: "Psalm 119:130"
                },
                {
                    text: "Heaven and earth will pass away, but My words will by no means pass away.",
                    reference: "Matthew 24:35"
                },
                {
                    text: "Blessed is the man who walks not in the counsel of the ungodly, but his delight is in the law of the Lord.",
                    reference: "Psalm 1:1-2"
                },
                {
                    text: "The fear of the Lord is the beginning of wisdom, and the knowledge of the Holy One is understanding.",
                    reference: "Proverbs 9:10"
                }
            ],
            ministerialWisdom: [
                {
                    text: "The Word of God is the foundation of all true spiritual knowledge and victory in life.",
                    attribution: "Biblical Teaching on Faith"
                },
                {
                    text: "When we meditate on God's Word day and night, we become like trees planted by rivers of water.",
                    attribution: "Wisdom on Scripture Meditation"
                },
                {
                    text: "Divine wisdom is not learned in classrooms but revealed through intimate fellowship with the Holy Spirit.",
                    attribution: "Understanding Spiritual Revelation"
                },
                {
                    text: "Every believer is called to be a student of the Word, rightly dividing truth with precision and power.",
                    attribution: "The Call to Biblical Excellence"
                },
                {
                    text: "God's Word contains everything needed for life and godliness - study it with passion and purpose.",
                    attribution: "The Sufficiency of Scripture"
                },
                {
                    text: "The anointing upon your life increases as you increase in the knowledge of God's Word.",
                    attribution: "Growing in Spiritual Authority"
                },
                {
                    text: "Biblical wisdom transforms minds, renews hearts, and empowers believers to walk in divine purpose.",
                    attribution: "The Transforming Power of Truth"
                },
                {
                    text: "Understanding God's Word is not just academic pursuit - it's the pathway to experiencing His glory.",
                    attribution: "Living in Divine Glory"
                }
            ],
            worshipInstrumentals: [
                'Peaceful Worship Ambience',
                'Holy Spirit Instrumental',
                'Sacred Meditation Music',
                'Reverent Praise Atmosphere',
                'Gentle Worship Sounds',
                'Spiritual Reflection Music',
                'Divine Presence Instrumental',
                'Sanctuary Worship Ambience'
            ]
        };

        let currentWorshipIndex = 0;
        let worshipPlaying = false;

        function updateSpiritualContent() {
            // Update Scripture motivation
            const scriptureIndex = Math.floor(Math.random() * spiritualContent.scriptureMotivations.length);
            const scripture = spiritualContent.scriptureMotivations[scriptureIndex];
            document.getElementById('scriptureText').textContent = scripture.text;
            document.getElementById('scriptureReference').textContent = `- ${scripture.reference}`;

            // Update ministerial wisdom
            const wisdomIndex = Math.floor(Math.random() * spiritualContent.ministerialWisdom.length);
            const wisdom = spiritualContent.ministerialWisdom[wisdomIndex];
            document.getElementById('wisdomText').textContent = wisdom.text;
            document.getElementById('wisdomAttribution').textContent = `- ${wisdom.attribution}`;

            console.log('✝️ Spiritual content updated for fresh inspiration');
        }

        // Enhanced Audio System for Beautiful Worship Atmosphere
        let audioContext = null;
        let worshipAudio = null;
        let isAudioInitialized = false;
        let currentTrackIndex = 0;

        const worshipTracks = [
            {
                name: "Holy Spirit's Presence",
                frequencies: [261.63, 329.63, 392.00, 523.25, 659.25], // C major pentatonic
                harmonics: [130.81, 164.81, 196.00], // Lower harmony
                modulation: { rate: 0.2, depth: 1.5 },
                reverb: { roomSize: 0.85, damping: 0.25 },
                atmosphere: "peaceful"
            },
            {
                name: "Sanctuary of Grace", 
                frequencies: [220.00, 277.18, 329.63, 440.00, 554.37], // A minor pentatonic
                harmonics: [110.00, 138.59, 164.81], // Lower harmony
                modulation: { rate: 0.18, depth: 1.8 },
                reverb: { roomSize: 0.9, damping: 0.3 },
                atmosphere: "contemplative"
            },
            {
                name: "Divine Light",
                frequencies: [196.00, 246.94, 293.66, 392.00, 493.88], // G major pentatonic
                harmonics: [98.00, 123.47, 146.83], // Lower harmony
                modulation: { rate: 0.25, depth: 2.2 },
                reverb: { roomSize: 0.95, damping: 0.2 },
                atmosphere: "uplifting"
            },
            {
                name: "River of Peace",
                frequencies: [174.61, 220.00, 261.63, 349.23, 440.00], // F major pentatonic
                harmonics: [87.31, 110.00, 130.81], // Lower harmony
                modulation: { rate: 0.15, depth: 1.0 },
                reverb: { roomSize: 0.8, damping: 0.4 },
                atmosphere: "tranquil"
            },
            {
                name: "Eternal Worship",
                frequencies: [293.66, 369.99, 440.00, 587.33, 739.99], // D major pentatonic
                harmonics: [146.83, 185.00, 220.00], // Lower harmony
                modulation: { rate: 0.22, depth: 1.6 },
                reverb: { roomSize: 0.88, damping: 0.28 },
                atmosphere: "majestic"
            },
            {
                name: "Morning Prayer",
                frequencies: [246.94, 311.13, 369.99, 493.88, 622.25], // B major pentatonic
                harmonics: [123.47, 155.56, 185.00], // Lower harmony
                modulation: { rate: 0.19, depth: 1.3 },
                reverb: { roomSize: 0.82, damping: 0.32 },
                atmosphere: "hopeful"
            }
        ];

        async function initializeAudio() {
            if (isAudioInitialized) return;
            
            try {
                // Initialize AudioContext with higher quality settings
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 44100,
                    latencyHint: 'playback'
                });
                
                // Create beautiful worship audio
                worshipAudio = createEnhancedWorshipAmbience();
                isAudioInitialized = true;
                console.log('🎵 Enhanced worship audio system initialized');
            } catch (error) {
                console.log('Audio initialization failed:', error);
                isAudioInitialized = true;
            }
        }

        function createEnhancedWorshipAmbience() {
            if (!audioContext) return null;
            
            const track = worshipTracks[currentTrackIndex];
            
            // Create main gain node
            const masterGain = audioContext.createGain();
            masterGain.gain.setValueAtTime(0, audioContext.currentTime);
            
            // Create enhanced reverb effect
            const convolver = audioContext.createConvolver();
            const reverbGain = audioContext.createGain();
            reverbGain.gain.setValueAtTime(track.reverb.roomSize * 0.4, audioContext.currentTime);
            
            // Create richer reverb impulse response
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * 3; // 3 seconds reverb for cathedral effect
            const impulse = audioContext.createBuffer(2, length, sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    const progress = i / length;
                    const envelope = Math.pow(1 - progress, track.reverb.damping);
                    // Add some early reflections for cathedral effect
                    const earlyReflection = Math.sin(progress * Math.PI * 20) * 0.1 * envelope;
                    const randomNoise = (Math.random() * 2 - 1) * envelope;
                    channelData[i] = randomNoise + earlyReflection;
                }
            }
            convolver.buffer = impulse;
            
            // Create low-pass filter for warmth
            const lowPassFilter = audioContext.createBiquadFilter();
            lowPassFilter.type = 'lowpass';
            lowPassFilter.frequency.setValueAtTime(8000, audioContext.currentTime);
            lowPassFilter.Q.setValueAtTime(1, audioContext.currentTime);
            
            // Create oscillators for main frequencies
            const oscillators = [];
            const gains = [];
            
            // Main melody frequencies
            track.frequencies.forEach((freq, index) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const lfo = audioContext.createOscillator();
                const lfoGain = audioContext.createGain();
                
                // Use more musical waveforms
                osc.type = index % 3 === 0 ? 'sine' : index % 3 === 1 ? 'triangle' : 'sawtooth';
                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                
                // Slower, more gentle modulation
                lfo.type = 'sine';
                lfo.frequency.setValueAtTime(track.modulation.rate + (Math.random() * 0.05), audioContext.currentTime);
                lfoGain.gain.setValueAtTime(track.modulation.depth * 0.5, audioContext.currentTime);
                
                // Stereo positioning
                const panner = audioContext.createStereoPanner();
                const panPosition = (index / track.frequencies.length - 0.5) * 0.6;
                panner.pan.setValueAtTime(panPosition, audioContext.currentTime);
                
                gain.gain.setValueAtTime(0.08 / track.frequencies.length, audioContext.currentTime);
                
                // Connect modulation
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                
                // Connect audio chain with filter
                osc.connect(gain);
                gain.connect(panner);
                panner.connect(lowPassFilter);
                lowPassFilter.connect(masterGain);
                panner.connect(reverbGain);
                
                osc.start();
                lfo.start();
                
                oscillators.push(osc);
                gains.push(gain);
            });
            
            // Add harmonic bass frequencies for richness
            track.harmonics.forEach((freq, index) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const lfo = audioContext.createOscillator();
                const lfoGain = audioContext.createGain();
                
                osc.type = 'sine'; // Bass frequencies work best with sine
                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                
                lfo.type = 'sine';
                lfo.frequency.setValueAtTime(track.modulation.rate * 0.7, audioContext.currentTime);
                lfoGain.gain.setValueAtTime(track.modulation.depth * 0.3, audioContext.currentTime);
                
                const panner = audioContext.createStereoPanner();
                panner.pan.setValueAtTime(0, audioContext.currentTime); // Center bass
                
                gain.gain.setValueAtTime(0.04 / track.harmonics.length, audioContext.currentTime);
                
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                
                osc.connect(gain);
                gain.connect(panner);
                panner.connect(lowPassFilter);
                lowPassFilter.connect(masterGain);
                panner.connect(reverbGain);
                
                osc.start();
                lfo.start();
                
                oscillators.push(osc);
                gains.push(gain);
            });
            
            // Connect reverb
            reverbGain.connect(convolver);
            convolver.connect(lowPassFilter);
            lowPassFilter.connect(masterGain);
            
            // Connect to destination
            masterGain.connect(audioContext.destination);
            
            return { 
                masterGain, 
                oscillators, 
                gains, 
                convolver, 
                reverbGain,
                lowPassFilter,
                trackName: track.name,
                atmosphere: track.atmosphere
            };
        }

        async function toggleWorship() {
            const button = document.getElementById('worshipToggle');
            const nowPlaying = document.getElementById('nowPlaying');
            const currentTrack = document.getElementById('currentTrack');

            // Initialize audio on first interaction (required by browsers)
            if (!isAudioInitialized) {
                await initializeAudio();
            }

            if (!worshipPlaying) {
                // Start beautiful worship atmosphere
                worshipPlaying = true;
                button.innerHTML = '<span class="worship-icon">🔇</span><span class="worship-text">Pause Worship</span>';
                button.classList.add('playing');
                nowPlaying.style.display = 'block';
                
                // Resume audio context if suspended
                if (audioContext && audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                // Start enhanced worship audio with smooth fade-in
                if (worshipAudio && worshipAudio.masterGain) {
                    worshipAudio.masterGain.gain.setTargetAtTime(0.08, audioContext.currentTime, 2.0);
                }
                
                // Display current track name with atmosphere
                const trackName = worshipAudio ? worshipAudio.trackName : 'Divine Ambience';
                const atmosphere = worshipAudio ? worshipAudio.atmosphere : 'peaceful';
                currentTrack.textContent = `♪ ${trackName} • ${atmosphere}`;
                
                console.log(`🎵 Enhanced worship atmosphere activated: ${trackName} (${atmosphere})`);
                
                // Auto-change track every 4 minutes with smooth transitions
                if (window.worshipInterval) clearInterval(window.worshipInterval);
                window.worshipInterval = setInterval(async () => {
                    if (worshipPlaying && audioContext) {
                        // Fade out current track
                        if (worshipAudio && worshipAudio.masterGain) {
                            worshipAudio.masterGain.gain.setTargetAtTime(0, audioContext.currentTime, 1.0);
                        }
                        
                        // Wait for fade out, then change track
                        setTimeout(() => {
                            // Stop current oscillators
                            if (worshipAudio && worshipAudio.oscillators) {
                                worshipAudio.oscillators.forEach(osc => {
                                    try { osc.stop(); } catch(e) {}
                                });
                            }
                            
                            // Move to next track
                            currentTrackIndex = (currentTrackIndex + 1) % worshipTracks.length;
                            worshipAudio = createEnhancedWorshipAmbience();
                            
                            // Fade in new track
                            if (worshipAudio && worshipAudio.masterGain) {
                                worshipAudio.masterGain.gain.setTargetAtTime(0.08, audioContext.currentTime, 2.0);
                            }
                            
                            // Update display
                            const newTrackName = worshipAudio ? worshipAudio.trackName : 'Divine Ambience';
                            const newAtmosphere = worshipAudio ? worshipAudio.atmosphere : 'peaceful';
                            currentTrack.textContent = `♪ ${newTrackName} • ${newAtmosphere}`;
                            console.log(`🎵 Transitioned to: ${newTrackName} (${newAtmosphere})`);
                        }, 1000);
                    }
                }, 240000); // 4 minutes
                
            } else {
                // Stop worship atmosphere with graceful fade-out
                worshipPlaying = false;
                button.innerHTML = '<span class="worship-icon">🎵</span><span class="worship-text">Gentle Worship Sounds</span>';
                button.classList.remove('playing');
                
                // Smooth fade out
                if (worshipAudio && worshipAudio.masterGain) {
                    worshipAudio.masterGain.gain.setTargetAtTime(0, audioContext.currentTime, 1.5);
                }
                
                // Hide now playing after fade completes
                setTimeout(() => {
                    nowPlaying.style.display = 'none';
                }, 1500);
                
                if (window.worshipInterval) {
                    clearInterval(window.worshipInterval);
                }
                
                console.log('🔇 Worship atmosphere gracefully faded out');
            }
        }

        // Global reset function for challenges
        function resetChallenge(challengeType) {
            if (window.PuzzleManager && window.PuzzleManager.resetChallenge) {
                window.PuzzleManager.resetChallenge(challengeType);
            } else {
                console.error('PuzzleManager not available for reset');
                location.reload(); // Fallback
            }
        }

        // Initialize options when DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeGameEngines, 50);
            setTimeout(initializeGameOptions, 100);
            setTimeout(initializeDragAndDrop, 200);
            // updateSpiritualContent now called in DOMContentLoaded event
        });
    </script>

    <style>
        /* Enhanced Worship Controls */
        .spiritual-footer {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(138, 43, 226, 0.05));
            backdrop-filter: blur(20px);
            border-top: 2px solid rgba(255, 215, 0, 0.3);
            margin-top: 40px;
            padding: 40px 0;
            position: relative;
            box-shadow: 
                0 -5px 20px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .spiritual-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.6), transparent);
        }

        .inspiration-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 30px;
            align-items: center;
        }

        .worship-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .worship-btn {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 240, 120, 0.8));
            border: 2px solid rgba(255, 215, 0, 0.6);
            border-radius: 30px;
            padding: 15px 30px;
            color: #1a0f0f;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 6px 20px rgba(255, 215, 0, 0.4),
                0 3px 10px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
        }

        .worship-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .worship-btn:hover::before {
            left: 100%;
        }

        .worship-btn:hover {
            background: linear-gradient(135deg, rgba(255, 240, 120, 1), rgba(255, 215, 0, 0.9));
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 10px 30px rgba(255, 215, 0, 0.5),
                0 5px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 215, 0, 0.8);
        }

        .worship-btn.playing {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.8), rgba(50, 205, 50, 0.6));
            color: white;
            animation: pulse 2s infinite;
        }

        .worship-icon {
            font-size: 1.2em;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        .worship-text {
            font-size: 0.95em;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 16px rgba(34, 139, 34, 0.3); }
            50% { box-shadow: 0 8px 24px rgba(34, 139, 34, 0.6); }
        }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            font-size: 0.9em;
            color: #e8e8e8;
        }

        .audio-visualizer {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 16px;
        }

        .audio-bar {
            width: 3px;
            background: linear-gradient(to top, #d4af37, #f4e976);
            border-radius: 2px;
            animation: audioViz 1.5s ease-in-out infinite;
        }

        .audio-bar:nth-child(1) { animation-delay: 0s; }
        .audio-bar:nth-child(2) { animation-delay: 0.3s; }
        .audio-bar:nth-child(3) { animation-delay: 0.6s; }
        .audio-bar:nth-child(4) { animation-delay: 0.9s; }

        @keyframes audioViz {
            0%, 100% { height: 4px; opacity: 0.5; }
            50% { height: 16px; opacity: 1; }
        }

        .scripture-motivation, .ministerial-wisdom {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .scripture-text, .wisdom-text {
            font-style: italic;
            color: #e8e8e8;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .scripture-reference, .wisdom-attribution {
            color: #d4af37;
            font-weight: 600;
            font-size: 0.9em;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .inspiration-container {
                grid-template-columns: 1fr;
                gap: 20px;
                text-align: center;
            }
            
            .worship-btn {
                font-size: 0.9em;
                padding: 10px 20px;
            }
        }
    </style>

        <!-- Spiritual Inspiration Footer -->
        <footer class="bg-glass-morphism backdrop-blur-2xl border-t border-mystic-gold-400/20 mt-20 py-16 relative overflow-hidden">
            <!-- Decorative elements -->
            <div class="absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-mystic-gold-400/60 to-transparent"></div>
            <div class="absolute top-4 left-1/4 w-32 h-32 border border-cosmic-400/10 rounded-full animate-spin" style="animation-duration: 30s;"></div>
            <div class="absolute bottom-4 right-1/4 w-24 h-24 border border-mystic-gold-400/10 rounded-full animate-spin" style="animation-duration: 25s; animation-direction: reverse;"></div>
            
            <div class="container mx-auto px-4 max-w-7xl relative z-10">
                <div class="grid lg:grid-cols-3 gap-10 items-center">
                    <!-- Scripture Motivation -->
                    <div class="bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/20 rounded-3xl p-8 group hover:shadow-golden-glow transition-all duration-500" id="scriptureMotivation">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-mystic-gold-400 mr-3" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V5H19V19M17,17H7V16H17V17M17,15H7V14H17V15M17,13H7V12H17V13M17,11H7V10H17V11M17,9H7V8H17V9Z"/>
                            </svg>
                            <span class="text-mystic-gold-300 font-semibold">Sacred Scripture</span>
                        </div>
                        <div class="text-white italic mb-4 leading-relaxed font-inter" id="scriptureText" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);"></div>
                        <div class="text-mystic-gold-400 font-semibold text-sm font-cinzel" id="scriptureReference"></div>
                    </div>
                    
                    <!-- Ministerial Wisdom -->
                    <div class="bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/20 rounded-3xl p-8 group hover:shadow-golden-glow transition-all duration-500" id="ministerialWisdom">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-mystic-gold-400 mr-3" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,17H13V11H11V17M11,9H13V7H11V9Z"/>
                            </svg>
                            <span class="text-mystic-gold-300 font-semibold">Divine Wisdom</span>
                        </div>
                        <div class="text-white italic mb-4 leading-relaxed font-inter" id="wisdomText" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);"></div>
                        <div class="text-mystic-gold-400 font-semibold text-sm font-cinzel" id="wisdomAttribution"></div>
                    </div>
                    
                    <!-- Worship Controls -->
                    <div class="flex flex-col items-center space-y-6">
                        <button id="worshipToggle" onclick="toggleWorship()" 
                                class="group bg-gold-mystique text-midnight-950 font-bold py-5 px-10 rounded-2xl transition-all duration-500 hover:scale-105 hover:shadow-golden-glow flex items-center space-x-4 relative overflow-hidden">
                            <!-- Shimmer effect -->
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-200%] group-hover:translate-x-[200%] transition-transform duration-1000"></div>
                            
                            <svg id="worshipIcon" class="w-6 h-6 relative z-10 group-hover:animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <span id="worshipText" class="text-lg font-semibold relative z-10 font-cinzel">Divine Worship Sounds</span>
                        </button>
                        
                        <div class="flex items-center space-x-4 bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/20 rounded-2xl px-6 py-3 text-sm text-amber-200 shadow-golden-glow" 
                             id="nowPlaying" style="display: none;">
                            <div class="flex items-end space-x-1 h-6">
                                <div class="w-1 bg-mystic-gold-400 rounded-full animate-pulse" style="height: 30%; animation-delay: 0s;"></div>
                                <div class="w-1 bg-mystic-gold-400 rounded-full animate-pulse" style="height: 80%; animation-delay: 0.3s;"></div>
                                <div class="w-1 bg-mystic-gold-400 rounded-full animate-pulse" style="height: 60%; animation-delay: 0.6s;"></div>
                                <div class="w-1 bg-mystic-gold-400 rounded-full animate-pulse" style="height: 100%; animation-delay: 0.9s;"></div>
                            </div>
                            <span id="currentTrack" class="font-inter">Peaceful Worship</span>
                        </div>
                        
                        <!-- Volume Control -->
                        <div class="flex items-center space-x-3 bg-glass-morphism backdrop-blur-xl border border-mystic-gold-400/20 rounded-xl px-4 py-2">
                            <svg class="w-4 h-4 text-mystic-gold-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.01,19.86 21,16.28 21,12C21,7.72 18.01,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/>
                            </svg>
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.3" 
                                   onchange="adjustWorshipVolume(this.value)"
                                   class="w-20 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                   style="background: linear-gradient(to right, #d4af37 0%, #d4af37 30%, #4a5568 30%, #4a5568 100%);">
                            <span class="text-xs text-mystic-gold-400 font-mono">30%</span>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</body>

</html>
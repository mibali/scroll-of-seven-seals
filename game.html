<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Scroll of Seven Seals - FIXED WINNER v1.3.1</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Uncial+Antiqua&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #2c1810, #4a3425, #6b4d37);
            color: #f4f1e8;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #d4af37;
        }

        .title {
            font-family: 'Uncial Antiqua', cursive;
            font-size: 2.5em;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #b8a082;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #4a90e2;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .info-title {
            color: #4a90e2;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-list {
            list-style: none;
            padding-left: 20px;
        }

        .info-list li {
            margin-bottom: 8px;
            color: #e0d0c0;
        }

        .game-mode {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-card:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #f4e876;
            transform: translateY(-5px);
        }

        .mode-card.selected {
            background: rgba(212, 175, 55, 0.2);
            border-color: #f4e876;
        }

        .mode-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            display: block;
        }

        .mode-title {
            font-size: 1.4em;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .mode-description {
            color: #b8a082;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .multiplayer-setup {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .setup-title {
            color: #d4af37;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .team-input {
            margin-bottom: 20px;
        }

        .team-input label {
            display: block;
            color: #b8a082;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .team-input input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #6b4d37;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #f4f1e8;
            font-family: inherit;
        }

        .team-input input:focus {
            outline: none;
            border-color: #d4af37;
            background: rgba(0, 0, 0, 0.5);
        }

        .room-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .room-option {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .room-option:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }

        .room-option-title {
            color: #d4af37;
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .room-option-desc {
            color: #b8a082;
            font-size: 0.9em;
        }

        .room-input-section {
            margin-bottom: 20px;
            display: none;
        }

        .room-input-section.active {
            display: block;
        }

        .room-code-display {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .room-code {
            font-size: 1.5em;
            color: #4a90e2;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .share-link {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #6b4d37;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9em;
            color: #b8a082;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .button {
            background: linear-gradient(135deg, #d4af37, #b8941f);
            color: #2c1810;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .button:hover {
            background: linear-gradient(135deg, #f4e876, #d4af37);
            transform: translateY(-2px);
        }

        .button.secondary {
            background: rgba(108, 77, 55, 0.8);
            color: #f4f1e8;
            border: 2px solid #6b4d37;
        }

        .button.secondary:hover {
            background: rgba(108, 77, 55, 1);
            border-color: #8b6d47;
        }

        .lobby {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #4a90e2;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .lobby-title {
            color: #4a90e2;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .teams-list {
            margin-bottom: 20px;
        }

        .team-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #6b4d37;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-name {
            color: #d4af37;
            font-weight: 600;
        }

        .team-status {
            color: #4a90e2;
            font-size: 0.9em;
        }

        .game-container {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .timer {
            font-size: 1.5em;
            color: #d4af37;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #d4af37;
        }

        .progress-container {
            flex: 1;
            min-width: 200px;
        }

        .progress-label {
            color: #b8a082;
            margin-bottom: 8px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 2px solid #6b4d37;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #f4e876);
            width: 0%;
            transition: width 0.3s ease;
        }

        .seals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .seal {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8b0000;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .seal:hover {
            border-color: #d4af37;
            transform: translateY(-5px);
        }

        .seal.opened {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .seal-number {
            font-size: 2em;
            color: #8b0000;
            margin-bottom: 10px;
        }

        .seal.opened .seal-number {
            color: #d4af37;
        }

        .seal-title {
            color: #f4f1e8;
            font-weight: 600;
        }

        .leaderboard {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 20px;
        }

        .leaderboard-title {
            color: #d4af37;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .leaderboard-rank {
            color: #d4af37;
            font-weight: bold;
            width: 30px;
        }

        .leaderboard-name {
            flex: 1;
            color: #f4f1e8;
        }

        .leaderboard-score {
            color: #4a90e2;
            font-weight: 600;
        }

        .puzzle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .puzzle-content {
            background: linear-gradient(135deg, #2c1810, #4a3425);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .puzzle-title {
            color: #d4af37;
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        .puzzle-question {
            color: #f4f1e8;
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .puzzle-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #6b4d37;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #f4f1e8;
            font-family: inherit;
            margin-bottom: 20px;
        }

        .puzzle-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .puzzle-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .alert.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .alert.error {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .alert.show {
            opacity: 1;
            transform: translateX(0);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0.8;
        }

        .connected {
            background: rgba(34, 139, 34, 0.8);
            color: white;
        }

        .disconnected {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }

        .connecting {
            background: rgba(255, 193, 7, 0.8);
            color: black;
        }

        @media (max-width: 768px) {
            .game-mode {
                grid-template-columns: 1fr;
            }

            .room-options {
                grid-template-columns: 1fr;
            }

            .game-header {
                flex-direction: column;
                text-align: center;
            }

            .seals-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>

<body>
    <div class="connection-status connecting" id="connectionStatus">
        üîÑ Connecting to Firebase...
    </div>

    <div class="container">
        <div class="header">
            <h1 class="title">üîÆ The Scroll of Seven Seals</h1>
            <p class="subtitle">Real-time Firebase Multiplayer Bible Mystery Adventure</p>
        </div>

        <div class="info-box">
            <div class="info-title">
                üåê Real Cross-Device Multiplayer:
            </div>
            <ol class="info-list">
                <li><strong>Create room ‚Üí</strong> Get a shareable link</li>
                <li><strong>Share link with friends</strong> on different devices</li>
                <li><strong>Everyone clicks the same link to join</strong></li>
                <li><strong>Compete in real-time across the internet!</strong></li>
            </ol>
        </div>

        <!-- Game Mode Selection -->
        <div id="modeSelection" class="game-mode">
            <div class="mode-card" onclick="selectMode('single')">
                <span class="mode-icon">üè†</span>
                <div class="mode-title">Single Group</div>
                <div class="mode-description">Play as one team and beat your best time</div>
            </div>

            <div class="mode-card" onclick="selectMode('ai')">
                <span class="mode-icon">ü§ñ</span>
                <div class="mode-title">VS Computer Teams</div>
                <div class="mode-description">Compete against AI opponents</div>
            </div>

            <div class="mode-card" onclick="selectMode('multiplayer')">
                <span class="mode-icon">üåê</span>
                <div class="mode-title">Real Multiplayer</div>
                <div class="mode-description">Compete with friends online using Firebase</div>
            </div>
        </div>

        <!-- Multiplayer Setup -->
        <div id="multiplayerSetup" class="multiplayer-setup">
            <div class="setup-title">Firebase Real-time Multiplayer Setup</div>

            <div class="team-input">
                <label for="teamName">Team Name:</label>
                <input type="text" id="teamName" placeholder="Enter your team name" maxlength="20">
            </div>

            <div class="room-options">
                <div class="room-option" onclick="showRoomCreation()">
                    <div class="room-option-title">üè† Create Room</div>
                    <div class="room-option-desc">Start a new Firebase game room</div>
                </div>

                <div class="room-option" onclick="showRoomJoin()">
                    <div class="room-option-title">üîó Join via Link</div>
                    <div class="room-option-desc">Use a friend's room link</div>
                </div>
            </div>

            <div id="roomCreation" class="room-input-section">
                <div class="room-code-display">
                    <div>Room Code:</div>
                    <div class="room-code" id="roomCode">------</div>
                </div>
                <div class="room-code-display">
                    <div>Your Room Link:</div>
                    <div class="share-link" id="shareLink">Click Create Room to generate link...</div>
                </div>
                <button class="button" onclick="copyRoomLink()">üìã Copy Room Link</button>
                <button class="button" onclick="createRoom()">Create Room</button>
            </div>

            <div id="roomJoin" class="room-input-section">
                <div class="team-input">
                    <label>Paste Room Link or Code:</label>
                    <input type="text" id="roomInput" placeholder="Paste room link from your friend">
                </div>
                <button class="button" onclick="joinRoom()">Join Room</button>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button secondary" onclick="goBack()">‚Üê Back</button>
            </div>
        </div>

        <!-- AI Mode Setup -->
        <div id="aiSetup" class="multiplayer-setup" style="display: none;">
            <div class="setup-title">ü§ñ VS Computer Teams Setup</div>

            <div class="team-input">
                <label for="playerTeamName">Your Team Name:</label>
                <input type="text" id="playerTeamName" placeholder="Enter your team name" maxlength="20" value="Player">
            </div>

            <div class="team-input">
                <label for="aiTeamCount">Number of AI Opponents:</label>
                <select id="aiTeamCount" style="width: 100%; padding: 12px; font-size: 1em; border: 2px solid #6b4d37; border-radius: 8px; background: rgba(0, 0, 0, 0.3); color: #f4f1e8; font-family: inherit;">
                    <option value="1">1 AI Team</option>
                    <option value="2" selected>2 AI Teams</option>
                    <option value="3">3 AI Teams</option>
                    <option value="4">4 AI Teams</option>
                    <option value="5">5 AI Teams</option>
                </select>
            </div>

            <div class="team-input">
                <label for="aiDifficulty">AI Difficulty:</label>
                <select id="aiDifficulty" style="width: 100%; padding: 12px; font-size: 1em; border: 2px solid #6b4d37; border-radius: 8px; background: rgba(0, 0, 0, 0.3); color: #f4f1e8; font-family: inherit;">
                    <option value="easy">üü¢ Easy - AI completes seals every 45-90 seconds</option>
                    <option value="medium" selected>üü° Medium - AI completes seals every 30-60 seconds</option>
                    <option value="hard">üî¥ Hard - AI completes seals every 15-45 seconds</option>
                    <option value="expert">üî• Expert - AI completes seals every 10-30 seconds</option>
                </select>
            </div>

            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid #c9a96e; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <h4 style="color: #d4af37; margin-bottom: 10px;">üéÆ How it Works:</h4>
                <ul style="color: #e8dcc0; margin: 0; padding-left: 20px;">
                    <li>You compete against AI teams that solve seals automatically</li>
                    <li>First team (you or AI) to complete all 7 seals wins</li>
                    <li>Game ends immediately when someone wins</li>
                    <li>Final rankings show all teams' performance</li>
                </ul>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" onclick="startAIGame()">üöÄ Start Competition</button>
                <button class="button secondary" onclick="goBack()">‚Üê Back</button>
            </div>
        </div>

        <!-- Lobby -->
        <div id="lobby" class="lobby">
            <div class="lobby-title">Firebase Game Lobby</div>
            <div class="room-code-display">
                <div>Room Code: <span class="room-code" id="lobbyRoomCode">------</span></div>
            </div>
            <div class="teams-list" id="teamsList"></div>
            <div style="text-align: center;">
                <button class="button" onclick="startRoomGameplay()" id="startLobbyBtn">Start Adventure</button>
                <button class="button secondary" onclick="goBack()">‚Üê Back to Setup</button>
            </div>
        </div>

        <!-- Game Container -->
        <div id="gameContainer" class="game-container">
            <div class="game-header">
                <div class="timer" id="timer">00:00</div>
                <div class="progress-container">
                    <div class="progress-label">Progress: <span id="progressText">0/7 Seals</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <div class="seals-grid" id="sealsGrid"></div>

            <div class="leaderboard">
                <div class="leaderboard-title">Live Rankings</div>
                <div id="leaderboardList"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button secondary" onclick="resetGameState()">üîÑ Reset Game</button>
                <button class="button secondary" onclick="goBack()">‚Üê Back to Lobby</button>
            </div>
        </div>
    </div>

    <!-- Puzzle Modal -->
    <div id="puzzleModal" class="puzzle-modal">
        <div class="puzzle-content">
            <div class="puzzle-title" id="puzzleTitle"></div>
            <div class="puzzle-question" id="puzzleQuestion"></div>
            <input type="text" id="puzzleAnswer" class="puzzle-input" placeholder="Enter your answer">
            <div class="puzzle-buttons">
                <button class="button" onclick="submitAnswer()">Submit</button>
                <button class="button secondary" onclick="closePuzzle()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase directly
        const firebaseConfig = {
            apiKey: "AIzaSyB9eQyqDeIjQvCRDtVVEsImhsfXNA9xMRc",
            authDomain: "scroll-of-seven-seals.firebaseapp.com",
            databaseURL: "https://scroll-of-seven-seals-default-rtdb.firebaseio.com",
            projectId: "scroll-of-seven-seals",
            storageBucket: "scroll-of-seven-seals.firebasestorage.app",
            messagingSenderId: "156760249212",
            appId: "1:156760249212:web:1bf31ad5f92b410f29caf9",
            measurementId: "G-DPY2ZJ7CSD"
        };

        // VERSION CHECK - Force browser cache refresh
        console.log('üöÄ GAME VERSION: v1.3.1 - FIXED NULL ERROR + IMMEDIATE WINNER');
        console.log('üìÖ Code loaded at:', new Date().toISOString());
        
        // EMERGENCY WINNER TESTING - Call from console if needed
        window.forcePlayerWin = function() {
            console.log('üÜò EMERGENCY: Forcing player victory manually');
            if (gameState.mode === 'ai' && gameState.completedSeals.length >= 7) {
                const elapsed = Date.now() - gameState.startTime;
                const playerTeam = gameState.teams.find(team => !team.isAI) || { name: gameState.currentTeam, isAI: false };
                playerTeam.score = 7;
                playerTeam.completedSeals = [...gameState.completedSeals];
                playerTeam.lastSealTime = Date.now();
                handleAIGameEnd(playerTeam, elapsed);
            }
        };
        
        // Game State
        let gameState = {
            mode: '',
            currentTeam: '',
            teams: [],
            completedSeals: [],
            startTime: null,
            currentPuzzle: null,
            isGameActive: false,
            roomCode: '',
            isHost: false,
            roomRef: null,
            // AI Mode specific
            aiTeams: [],
            aiTimers: [],
            aiDifficulty: 'medium'
        };

        // Firebase connection monitoring
        let isFirebaseReady = false;
        let app, database, auth;

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;

            switch (status) {
                case 'connecting':
                    statusEl.textContent = 'üîÑ Connecting to Firebase...';
                    break;
                case 'connected':
                    statusEl.textContent = '‚úÖ Firebase Connected';
                    isFirebaseReady = true;
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                    break;
                case 'disconnected':
                    statusEl.textContent = '‚ùå Firebase Disconnected';
                    statusEl.style.display = 'block';
                    break;
            }
        }

        // Initialize Firebase
        function initializeFirebase() {
            return new Promise((resolve, reject) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        console.log('üî• Firebase SDK loaded, initializing...');

                        // Check if already initialized
                        if (isFirebaseReady && database && auth) {
                            console.log('‚úÖ Firebase already ready');
                            resolve(true);
                            return;
                        }

                        if (!app) {
                            app = firebase.initializeApp(firebaseConfig);
                        }
                        database = firebase.database();
                        auth = firebase.auth();

                        console.log('üî• Firebase initialized successfully');

                        // Wait for authentication state
                        const unsubscribe = auth.onAuthStateChanged((user) => {
                            if (user) {
                                console.log('‚úÖ User authenticated:', user.uid);
                                isFirebaseReady = true;
                                updateConnectionStatus('connected');
                                unsubscribe(); // Remove listener after first authentication
                                resolve(true);

                                // Monitor connection status
                                database.ref('.info/connected').on('value', (snapshot) => {
                                    const connected = snapshot.val();
                                    console.log('üî• Firebase connection status:', connected);
                                    if (connected === true) {
                                        updateConnectionStatus('connected');
                                        isFirebaseReady = true;
                                    } else {
                                        updateConnectionStatus('disconnected');
                                        isFirebaseReady = false;
                                    }
                                });
                            } else {
                                // Sign in anonymously for multiplayer access
                                console.log('üîê Signing in anonymously...');
                                auth.signInAnonymously()
                                    .catch((error) => {
                                        console.error('‚ùå Anonymous authentication failed:', error);
                                        updateConnectionStatus('disconnected');
                                        unsubscribe();
                                        reject(error);
                                    });
                            }
                        });
                    } else {
                        console.error('‚ùå Firebase SDK not loaded');
                        updateConnectionStatus('disconnected');
                        reject(new Error('Firebase SDK not available'));
                    }
                } catch (error) {
                    console.error('‚ùå Firebase initialization failed:', error);
                    updateConnectionStatus('disconnected');
                    reject(error);
                }
            });
        }

        // Wait for Firebase SDK to load
        function waitForFirebase() {
            if (typeof firebase !== 'undefined') {
                initializeFirebase();
            } else {
                setTimeout(waitForFirebase, 100);
            }
        }

        // Start Firebase initialization
        waitForFirebase();

        // Check for room parameter in URL
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam) {
                // Auto-fill join form
                document.getElementById('roomInput').value = roomParam;
                selectMode('multiplayer');
                showRoomJoin();
            }
        });

        function selectMode(mode) {
            gameState.mode = mode;

            // Update UI
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.mode-card').classList.add('selected');

            if (mode === 'multiplayer') {
                if (!isFirebaseReady) {
                    showAlert('Firebase is not ready yet. Please wait a moment and try again.', 'error');
                    return;
                }
                document.getElementById('multiplayerSetup').style.display = 'block';
            } else if (mode === 'ai') {
                // Show AI mode setup
                document.getElementById('aiSetup').style.display = 'block';
            } else {
                // Start single player mode directly
                startSinglePlayerGame();
            }
        }

        function showRoomCreation() {
            document.getElementById('roomCreation').classList.add('active');
            document.getElementById('roomJoin').classList.remove('active');

            // Automatically generate room code and link when showing creation form
            const roomCode = Math.random().toString(36).substr(2, 6).toUpperCase();
            const shareLink = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;

            document.getElementById('roomCode').textContent = roomCode;
            document.getElementById('shareLink').textContent = shareLink;

            // Store for when they actually create the room
            window.tempRoomCode = roomCode;
            window.tempShareLink = shareLink;
        }

        function showRoomJoin() {
            document.getElementById('roomJoin').classList.add('active');
            document.getElementById('roomCreation').classList.remove('active');
        }

        async function createRoom() {
            console.log('üéØ Create room clicked');

            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                showAlert('Please enter a team name', 'error');
                return;
            }

            // Use pre-generated room code and link
            const roomCode = window.tempRoomCode || Math.random().toString(36).substr(2, 6).toUpperCase();
            const shareLink = window.tempShareLink || `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
            console.log('üé≤ Using room code:', roomCode);

            gameState.roomCode = roomCode;
            gameState.currentTeam = teamName;
            gameState.isHost = true;
            gameState.teams = [{ name: teamName, score: 0, completedSeals: [] }];

            try {
                // Ensure Firebase is ready before proceeding
                if (!isFirebaseReady) {
                    updateConnectionStatus('connecting');
                    await initializeFirebase();
                }

                if (database && isFirebaseReady) {
                    console.log('üî• Attempting Firebase save...');

                    const roomData = {
                        code: roomCode,
                        host: teamName,
                        teams: {
                            [teamName]: {
                                name: teamName,
                                isHost: true,
                                joinTime: firebase.database.ServerValue.TIMESTAMP,
                                score: 0,
                                completedSeals: []
                            }
                        },
                        status: 'waiting',
                        gameStarted: false,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    await database.ref(`rooms/${roomCode}`).set(roomData);
                    console.log('‚úÖ Firebase save successful');
                    showAlert('Room created! Share the link to invite players.', 'success');
                } else {
                    console.log('‚ö†Ô∏è Creating room without Firebase');
                    showAlert('Room created locally (limited functionality)', 'success');
                }
            } catch (error) {
                console.error('‚ùå Error creating room:', error);
                showAlert('Room created (with sync issues)', 'success');
            }

            // Always proceed to lobby
            showLobby();
        }

        async function joinRoom() {
            const teamName = document.getElementById('teamName').value.trim();
            let roomInput = document.getElementById('roomInput').value.trim();

            if (!teamName) {
                showAlert('Please enter a team name', 'error');
                return;
            }

            // Extract room code from URL if provided
            let roomCode = roomInput;
            if (roomInput.includes('?room=')) {
                roomCode = roomInput.split('?room=')[1].split('&')[0];
            }

            if (!roomCode) {
                showAlert('Please enter a room code or link', 'error');
                return;
            }

            roomCode = roomCode.toUpperCase();
            
            // DEBUG: Add extensive logging
            console.log('üö™ JOINING ROOM - Room code:', roomCode);
            console.log('üî• Firebase ready?', isFirebaseReady);
            console.log('üì° Database object:', database);

            try {
                // Ensure Firebase is ready before proceeding
                if (!isFirebaseReady) {
                    updateConnectionStatus('connecting');
                    showAlert('Connecting to room...', 'success');
                    await initializeFirebase();
                }

                if (!database || !isFirebaseReady) {
                    showAlert('Unable to connect to multiplayer service', 'error');
                    return;
                }

                console.log('üîç Checking room:', roomCode);

                // Check if room exists
                console.log('üîç Searching for room at path:', `rooms/${roomCode}`);
                const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
                const roomData = snapshot.val();
                
                console.log('üìä Room data found:', roomData);
                console.log('üìä Snapshot exists:', snapshot.exists());
                
                // DEBUG: List all rooms to see what's in the database
                const allRoomsSnapshot = await database.ref('rooms').once('value');
                const allRooms = allRoomsSnapshot.val();
                console.log('üìã All rooms in database:', allRooms);

                if (!roomData) {
                    console.log('‚ùå Room not found for code:', roomCode);
                    showAlert('Room not found. Please check the room code.', 'error');
                    return;
                }
                
                console.log('‚úÖ Room found successfully!');

                if (roomData.status !== 'waiting') {
                    showAlert('This game has already started.', 'error');
                    return;
                }

                // Check if team name already exists
                if (roomData.teams && roomData.teams[teamName]) {
                    showAlert('A team with this name already exists in the room.', 'error');
                    return;
                }

                // Join the room
                gameState.roomCode = roomCode;
                gameState.currentTeam = teamName;
                gameState.isHost = false;

                const teamData = {
                    name: teamName,
                    isHost: false,
                    joinTime: firebase.database.ServerValue.TIMESTAMP,
                    score: 0,
                    completedSeals: []
                };

                console.log('üíæ Saving team data:', teamData);
                await database.ref(`rooms/${roomCode}/teams/${teamName}`).set(teamData);

                // Update URL
                window.history.pushState({}, '', `${window.location.pathname}?room=${roomCode}`);

                showLobby();
                showAlert('Joined room successfully!', 'success');

            } catch (error) {
                console.error('‚ùå Error joining room:', error);
                showAlert('Failed to join room: ' + error.message, 'error');
            }
        }

        function showLobby() {
            document.getElementById('multiplayerSetup').style.display = 'none';
            document.getElementById('lobby').style.display = 'block';
            document.getElementById('lobbyRoomCode').textContent = gameState.roomCode;

            // Listen for room updates
            gameState.roomRef = database.ref(`rooms/${gameState.roomCode}`);
            gameState.roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (roomData) {
                    updateLobby(roomData);

                    // CRITICAL: Update leaderboard with live Firebase data during gameplay
                    if (gameState.isGameActive && roomData.teams) {
                        console.log('üìä ROOM LISTENER: Updating leaderboard with live data');
                        updateLeaderboardFromFirebase(roomData.teams);
                    }

                    // Check if game started
                    if (roomData.gameStarted && !gameState.isGameActive) {
                        startRoomGameplay();
                    }

                    // Check if game has ended with a winner
                    if (roomData.status === 'finished' && roomData.winner && gameState.isGameActive) {
                        console.log('üèÜ ROOM LISTENER: Game ended, winner detected:', roomData.winner);
                        console.log('üèÜ ROOM LISTENER: Current team:', gameState.currentTeam);
                        console.log('üèÜ ROOM LISTENER: Is game active?', gameState.isGameActive);
                        console.log('üèÜ ROOM LISTENER: Final rankings available?', !!roomData.finalRankings);
                        
                        const isWinner = roomData.winner === gameState.currentTeam;
                        console.log('üèÜ ROOM LISTENER: Is current team winner?', isWinner);
                        
                        // Show enhanced modal with rankings if available, otherwise fallback to simple modal
                        if (roomData.finalRankings) {
                            showWinnerModalWithRankings(roomData.winner, roomData.completionTime || 0, roomData.finalRankings, isWinner);
                        } else {
                            showWinnerModal(roomData.winner, roomData.completionTime || 0, isWinner);
                        }
                    } 
                    // Also check for gameActive flag to lock the game immediately
                    else if (roomData.gameActive === false && gameState.isGameActive) {
                        console.log('üîí ROOM LISTENER: Game deactivated, locking UI');
                        lockGameInputs();
                        
                        // If there's winner data but status isn't finished yet, prepare for incoming winner announcement
                        if (roomData.winner) {
                            console.log('üèÜ ROOM LISTENER: Winner exists, showing modal soon');
                            const isWinner = roomData.winner === gameState.currentTeam;
                            if (roomData.finalRankings) {
                                showWinnerModalWithRankings(roomData.winner, roomData.completionTime || 0, roomData.finalRankings, isWinner);
                            } else {
                                showWinnerModal(roomData.winner, roomData.completionTime || 0, isWinner);
                            }
                        }
                    }
                    else {
                        console.log('üîç ROOM LISTENER: Room status:', roomData.status, 'Winner:', roomData.winner, 'Game active:', roomData.gameActive, 'Local game active:', gameState.isGameActive);
                    }
                } else {
                    showAlert('Room no longer exists', 'error');
                    goBack();
                }
            });
        }

        function updateLobby(roomData) {
            // Update teams list
            gameState.teams = Object.values(roomData.teams || {});
            updateTeamsList();

            // Update start button for host
            if (gameState.isHost) {
                const startBtn = document.getElementById('startLobbyBtn');
                const canStart = gameState.teams.length >= 1; // Allow single player start for testing
                startBtn.disabled = !canStart;
                startBtn.textContent = canStart ? 'Start Adventure' : 'Waiting for players...';
            } else {
                const startBtn = document.getElementById('startLobbyBtn');
                startBtn.style.display = 'none';
            }
        }

        function updateTeamsList() {
            const teamsList = document.getElementById('teamsList');
            teamsList.innerHTML = '';

            gameState.teams.forEach(team => {
                const teamItem = document.createElement('div');
                teamItem.className = 'team-item';
                teamItem.innerHTML = `
                    <span class="team-name">${team.name}${team.isHost ? ' üëë' : ''}</span>
                    <span class="team-status">Ready</span>
                `;
                teamsList.appendChild(teamItem);
            });
        }

        function startRoomGameplay() {
            if (gameState.isHost) {
                // Host starts the game for everyone
                database.ref(`rooms/${gameState.roomCode}`).update({
                    gameStarted: true,
                    gameActive: true,
                    status: 'playing',
                    startTime: firebase.database.ServerValue.TIMESTAMP
                });
            }

            // Start local game
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            gameState.isGameActive = true;
            gameState.startTime = Date.now();
            gameState.completedSeals = [];

            renderSeals();
            startTimer();
            updateProgress();
            updateLeaderboard();

            showAlert('Game started!', 'success');
        }

        function startSinglePlayerGame() {
            // Generate fresh questions for each game
            seals = generateRandomSeals();
            
            gameState.currentTeam = 'Player';
            gameState.teams = [{ name: 'Player', score: 0, completedSeals: [] }];

            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            gameState.isGameActive = true;
            gameState.startTime = Date.now();
            gameState.completedSeals = [];

            renderSeals();
            startTimer();
            updateProgress();
            updateLeaderboard();
        }

        // AI team name pool
        const aiTeamNames = [
            'Scripture Scholars', 'Bible Blazers', 'Faith Warriors', 'Gospel Guardians',
            'Verse Virtuosos', 'Holy Hunters', 'Divine Detectives', 'Sacred Seekers',
            'Truth Trackers', 'Word Warriors', 'Righteous Runners', 'Glory Gatherers',
            'Heaven Hounds', 'Salvation Squad', 'Psalm Pioneers', 'Covenant Crusaders',
            'Prophecy Pros', 'Testament Titans', 'Miracle Masters', 'Grace Gladiators'
        ];

        // AI difficulty settings
        const aiDifficultySettings = {
            easy: { minTime: 45000, maxTime: 90000, variance: 0.3 },      // 45-90 seconds
            medium: { minTime: 30000, maxTime: 60000, variance: 0.4 },    // 30-60 seconds  
            hard: { minTime: 15000, maxTime: 45000, variance: 0.5 },      // 15-45 seconds
            expert: { minTime: 10000, maxTime: 30000, variance: 0.6 }     // 10-30 seconds
        };

        function startAIGame() {
            const playerTeamName = document.getElementById('playerTeamName').value.trim() || 'Player';
            const aiTeamCount = parseInt(document.getElementById('aiTeamCount').value);
            const aiDifficulty = document.getElementById('aiDifficulty').value;

            if (!playerTeamName) {
                showAlert('Please enter your team name', 'error');
                return;
            }

            console.log('ü§ñ Starting AI Game:', { playerTeamName, aiTeamCount, aiDifficulty });

            // Generate fresh questions for each game
            seals = generateRandomSeals();
            
            // Setup game state
            gameState.mode = 'ai';
            gameState.currentTeam = playerTeamName;
            gameState.aiDifficulty = aiDifficulty;
            gameState.completedSeals = [];
            gameState.aiTeams = [];
            gameState.aiTimers = [];

            // Create player team
            const playerTeam = { 
                name: playerTeamName, 
                score: 0, 
                completedSeals: [], 
                isAI: false,
                lastSealTime: null
            };

            // Create AI teams
            const selectedAINames = aiTeamNames
                .sort(() => Math.random() - 0.5)  // Shuffle
                .slice(0, aiTeamCount);           // Take required number

            const aiTeams = selectedAINames.map(name => ({
                name: name,
                score: 0,
                completedSeals: [],
                isAI: true,
                lastSealTime: null,
                nextSealTime: null
            }));

            // Combine all teams
            gameState.teams = [playerTeam, ...aiTeams];
            gameState.aiTeams = aiTeams;

            console.log('ü§ñ Teams created:', gameState.teams);

            // Hide setup and show game
            document.getElementById('aiSetup').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            // Start game
            gameState.isGameActive = true;
            gameState.startTime = Date.now();

            renderSeals();
            startTimer();
            updateProgress();
            updateLeaderboard();

            // Start AI progression
            startAIProgression();

            showAlert(`ü§ñ Competition started against ${aiTeamCount} AI team${aiTeamCount > 1 ? 's' : ''}!`, 'success');
        }

        function startAIProgression() {
            console.log('ü§ñ Starting AI progression with difficulty:', gameState.aiDifficulty);
            
            const settings = aiDifficultySettings[gameState.aiDifficulty];
            
            gameState.aiTeams.forEach((aiTeam, index) => {
                // Schedule first seal for each AI team with some initial delay and randomization
                const initialDelay = (index + 1) * 2000 + Math.random() * 5000; // 2-7 seconds staggered start
                
                setTimeout(() => {
                    if (gameState.isGameActive) {
                        scheduleNextAISeal(aiTeam);
                    }
                }, initialDelay);
            });
        }

        function scheduleNextAISeal(aiTeam) {
            // Enhanced check to prevent scheduling after game ends
            if (!gameState.isGameActive) {
                console.log(`üõë Not scheduling next seal for ${aiTeam.name} - game inactive`);
                return;
            }
            
            if (aiTeam.score >= 7) {
                console.log(`üõë Not scheduling next seal for ${aiTeam.name} - already completed`);
                return;
            }

            const settings = aiDifficultySettings[gameState.aiDifficulty];
            
            // Calculate next seal time with variance
            const baseTime = settings.minTime + Math.random() * (settings.maxTime - settings.minTime);
            const variance = (Math.random() - 0.5) * 2 * settings.variance; // -variance to +variance
            const nextSealTime = baseTime * (1 + variance);
            
            console.log(`ü§ñ ${aiTeam.name} next seal in ${Math.round(nextSealTime/1000)}s`);
            
            const timer = setTimeout(() => {
                // Triple check before executing - game state can change
                if (gameState.isGameActive && aiTeam.score < 7) {
                    completeAISeal(aiTeam);
                } else {
                    console.log(`üõë ${aiTeam.name} timer fired but game inactive or team completed`);
                }
            }, nextSealTime);
            
            // Store timer for cleanup only if game is still active
            if (gameState.isGameActive) {
                gameState.aiTimers.push(timer);
                aiTeam.nextSealTime = Date.now() + nextSealTime;
            } else {
                // Clear the timer immediately if game became inactive
                clearTimeout(timer);
            }
        }

        function completeAISeal(aiTeam) {
            // CRITICAL: Double check game is still active - player might have won
            if (!gameState.isGameActive) {
                console.log(`üõë ${aiTeam.name} seal completion cancelled - game already ended`);
                return;
            }
            
            if (aiTeam.score >= 7) {
                console.log(`üõë ${aiTeam.name} already completed all seals`);
                return;
            }

            const sealNumber = aiTeam.score + 1;
            aiTeam.score = sealNumber;
            aiTeam.completedSeals.push(sealNumber);
            aiTeam.lastSealTime = Date.now();

            console.log(`ü§ñ ${aiTeam.name} completed seal ${sealNumber}!`);

            // Update UI only if game is still active
            if (gameState.isGameActive) {
                updateLeaderboard();
            }

            // Check for winner - but only if game is still active
            if (sealNumber === 7 && gameState.isGameActive) {
                console.log(`üèÜ AI team ${aiTeam.name} completed all seals!`);
                const completionTime = Date.now() - gameState.startTime;
                
                // Final check before declaring AI winner - ensure player hasn't already won
                const playerTeam = gameState.teams.find(team => !team.isAI);
                if (playerTeam && playerTeam.score >= 7) {
                    console.log(`üõë Player already won - ignoring AI completion`);
                    return;
                }
                
                handleAIGameEnd(aiTeam, completionTime);
            } else if (gameState.isGameActive) {
                // Schedule next seal only if game is still active
                scheduleNextAISeal(aiTeam);
            }
        }

        function handleAIGameEnd(winningTeam, completionTime) {
            console.log('üèÜ handleAIGameEnd called');
            console.log('üèÜ AI Game ended, winner:', winningTeam ? winningTeam.name : 'Unknown');
            console.log('üèÜ Winning team details:', winningTeam);
            console.log('üèÜ Completion time:', completionTime);
            console.log('üèÜ Current teams state:', gameState.teams);
            
            // Ensure game is marked as inactive
            gameState.isGameActive = false;
            
            // Clear all AI timers to stop further AI progression
            if (gameState.aiTimers && gameState.aiTimers.length > 0) {
                console.log('üõë Clearing', gameState.aiTimers.length, 'AI timers');
                gameState.aiTimers.forEach(timer => clearTimeout(timer));
                gameState.aiTimers = [];
            }
            
            // Calculate final rankings
            console.log('üìä Calculating final rankings...');
            const finalRankings = calculateAIFinalRankings();
            console.log('üìä Final rankings calculated:', finalRankings);
            
            // Show winner modal with rankings
            const isPlayerWinner = !winningTeam.isAI;
            console.log('üéâ Showing winner modal - Is player winner?', isPlayerWinner);
            console.log('üéâ Winner team name:', winningTeam.name);
            console.log('üéâ Final rankings:', finalRankings);
            
            try {
                // Force display of winner modal
                console.log('üöÄ FORCING WINNER MODAL DISPLAY');
                showWinnerModalWithRankings(winningTeam.name, completionTime, finalRankings, isPlayerWinner);
                console.log('‚úÖ Winner modal displayed successfully');
            } catch (error) {
                console.error('‚ùå Error showing winner modal:', error);
                console.error('‚ùå Error details:', error.stack);
                
                // Enhanced fallback - show both alert and try simple modal
                showAlert(`üèÜ GAME OVER! ${winningTeam.name} WINS! Time: ${Math.floor(completionTime/60000)}:${Math.floor((completionTime%60000)/1000).toString().padStart(2,'0')}`, 'success');
                
                // Try showing the simple winner modal as backup
                try {
                    showWinnerModal(winningTeam.name, completionTime, isPlayerWinner);
                } catch (fallbackError) {
                    console.error('‚ùå Fallback modal also failed:', fallbackError);
                }
            }
            
            // Lock game inputs
            console.log('üîí Locking game inputs...');
            lockGameInputs();
            console.log('‚úÖ AI game end handling complete');
        }

        function calculateAIFinalRankings() {
            console.log('üìä Calculating AI game final rankings');
            
            const rankings = gameState.teams.map(team => ({
                teamName: team.name,
                sealsCompleted: team.score,
                completionTime: team.score === 7 ? (Date.now() - gameState.startTime) : null,
                lastSealTime: team.lastSealTime || Date.now(),
                completed: team.score === 7,
                isAI: team.isAI || false
            }));

            // Sort rankings: completed first, then by seals, then by completion/last seal time
            rankings.sort((a, b) => {
                if (a.completed && !b.completed) return -1;
                if (!a.completed && b.completed) return 1;
                
                if (a.sealsCompleted !== b.sealsCompleted) {
                    return b.sealsCompleted - a.sealsCompleted;
                }
                
                if (a.completed && b.completed && a.completionTime && b.completionTime) {
                    return a.completionTime - b.completionTime;
                }
                
                if (a.lastSealTime && b.lastSealTime) {
                    return a.lastSealTime - b.lastSealTime;
                }
                
                return 0;
            });

            rankings.forEach((team, index) => {
                team.rank = index + 1;
            });

            console.log('üèÜ AI Final rankings:', rankings);
            return rankings;
        }

        // Expanded Bible Question Pool for Random Generation
        const bibleQuestionPool = [
            // Original Revelation questions
            { title: "The White Horse", question: "Who rode the white horse in Revelation 6:2?", answer: ["jesus", "christ", "lamb", "conqueror"], hint: "The one who conquers and will conquer", reference: "Revelation 6:2" },
            { title: "The Red Horse", question: "What was the rider of the red horse given power to take from the earth?", answer: ["peace"], hint: "The opposite of war", reference: "Revelation 6:4" },
            { title: "The Black Horse", question: "What did the rider of the black horse hold in his hand?", answer: ["scales", "balance", "balances"], hint: "Used for measuring and weighing", reference: "Revelation 6:5" },
            { title: "The Pale Horse", question: "What was the name of the rider on the pale horse?", answer: ["death"], hint: "The end of life", reference: "Revelation 6:8" },
            { title: "The Souls Under the Altar", question: "What were the souls under the altar given to wear?", answer: ["white robes", "robes", "white robe"], hint: "Garments of purity and righteousness", reference: "Revelation 6:11" },
            { title: "The Great Earthquake", question: "What did the sun become like when the sixth seal was opened?", answer: ["black", "sackcloth", "dark"], hint: "Color of mourning cloth", reference: "Revelation 6:12" },
            { title: "Silence in Heaven", question: "How long was there silence in heaven when the seventh seal was opened?", answer: ["half an hour", "30 minutes", "half hour"], hint: "A brief period of time", reference: "Revelation 8:1" },
            
            // Genesis
            { title: "Creation Day 1", question: "What did God create on the first day?", answer: ["light"], hint: "And God said, 'Let there be...'", reference: "Genesis 1:3" },
            { title: "First Man", question: "Who was the first man created by God?", answer: ["adam"], hint: "Made from the dust of the earth", reference: "Genesis 2:7" },
            { title: "First Woman", question: "What was the name of the first woman?", answer: ["eve"], hint: "Mother of all living", reference: "Genesis 3:20" },
            { title: "The Flood", question: "How many days and nights did it rain during the flood?", answer: ["40", "forty"], hint: "The same number Moses was on the mountain", reference: "Genesis 7:4" },
            { title: "Abraham's Promise", question: "What did God promise Abraham would be as numerous as the stars?", answer: ["descendants", "offspring", "children"], hint: "His future family line", reference: "Genesis 15:5" },
            { title: "Jacob's Dream", question: "What did Jacob see in his dream at Bethel?", answer: ["ladder", "stairway"], hint: "Angels ascending and descending", reference: "Genesis 28:12" },
            { title: "Joseph's Brothers", question: "How many sons did Jacob have?", answer: ["12", "twelve"], hint: "They became the tribes of Israel", reference: "Genesis 35:22" },
            
            // Exodus
            { title: "Moses' Calling", question: "Who led the Israelites out of Egypt?", answer: ["moses"], hint: "He was found in a basket as a baby", reference: "Exodus 2:10" },
            { title: "Ten Plagues", question: "How many plagues did God send on Egypt?", answer: ["10", "ten"], hint: "The last one was the worst", reference: "Exodus 7-12" },
            { title: "Red Sea", question: "What sea did the Israelites cross?", answer: ["red sea"], hint: "The waters parted", reference: "Exodus 14:21" },
            { title: "Mount Sinai", question: "On which mountain did Moses receive the Ten Commandments?", answer: ["sinai", "mount sinai"], hint: "Also called Horeb", reference: "Exodus 19:20" },
            { title: "Golden Calf", question: "What did the Israelites worship while Moses was on the mountain?", answer: ["golden calf"], hint: "An idol made from their jewelry", reference: "Exodus 32:4" },
            { title: "Wilderness Food", question: "What food did God provide in the wilderness?", answer: ["manna"], hint: "Bread from heaven", reference: "Exodus 16:4" },
            
            // New Testament - Gospels
            { title: "Jesus' Birth", question: "In which city was Jesus born?", answer: ["bethlehem"], hint: "City of David", reference: "Matthew 2:1" },
            { title: "Jesus' Baptism", question: "Who baptized Jesus?", answer: ["john", "john the baptist"], hint: "The voice crying in the wilderness", reference: "Matthew 3:13" },
            { title: "The Twelve", question: "How many disciples did Jesus choose?", answer: ["12", "twelve"], hint: "The same number as the tribes of Israel", reference: "Matthew 10:1" },
            { title: "The Betrayal", question: "Who betrayed Jesus?", answer: ["judas", "judas iscariot"], hint: "He did it for 30 pieces of silver", reference: "Matthew 26:14" },
            { title: "The Denial", question: "Who denied Jesus three times?", answer: ["peter", "simon peter"], hint: "The rock upon which the church was built", reference: "Matthew 26:69" },
            { title: "First Miracle", question: "What did Jesus turn water into at the wedding?", answer: ["wine"], hint: "His first miracle", reference: "John 2:11" },
            { title: "Feeding 5000", question: "How many loaves fed the 5000?", answer: ["5", "five"], hint: "Plus two fish", reference: "Matthew 14:17" },
            
            // Acts
            { title: "Pentecost", question: "What happened on the Day of Pentecost?", answer: ["holy spirit came", "tongues of fire"], hint: "The Spirit descended like tongues of fire", reference: "Acts 2:3" },
            { title: "First Martyr", question: "Who was the first Christian martyr?", answer: ["stephen"], hint: "He saw Jesus standing at God's right hand", reference: "Acts 7:56" },
            { title: "Paul's Conversion", question: "What was Paul's name before his conversion?", answer: ["saul"], hint: "Named after Israel's first king", reference: "Acts 9:4" },
            { title: "Damascus Road", question: "On what road did Paul encounter Jesus?", answer: ["damascus"], hint: "He was blinded by the light", reference: "Acts 9:3" },
            
            // Wisdom Literature
            { title: "The Wisest King", question: "Who is traditionally considered the wisest man?", answer: ["solomon"], hint: "He asked God for wisdom", reference: "1 Kings 3:9" },
            { title: "The Good Shepherd", question: "Which psalm begins 'The Lord is my shepherd'?", answer: ["psalm 23", "23"], hint: "The most famous psalm", reference: "Psalm 23:1" },
            { title: "Proverbs Wisdom", question: "Complete: 'The fear of the Lord is the beginning of...'", answer: ["wisdom"], hint: "From Proverbs", reference: "Proverbs 9:10" },
            
            // Paul's Letters
            { title: "All Have Sinned", question: "Complete: 'For all have sinned and fall short of...'", answer: ["glory", "glory of god"], hint: "Romans 3:23", reference: "Romans 3:23" },
            { title: "Greatest Virtue", question: "What is the greatest of faith, hope, and love?", answer: ["love"], hint: "From 1 Corinthians 13", reference: "1 Corinthians 13:13" },
            { title: "Armor of God", question: "In which letter does Paul describe the armor of God?", answer: ["ephesians"], hint: "Stand against the devil's schemes", reference: "Ephesians 6:11" },
            
            // More Revelation
            { title: "Seven Churches", question: "How many churches are addressed in Revelation?", answer: ["7", "seven"], hint: "In Asia Minor", reference: "Revelation 1:4" },
            { title: "Beast's Number", question: "What is the number of the beast?", answer: ["666"], hint: "The mark of the beast", reference: "Revelation 13:18" },
            { title: "John's Exile", question: "On which island did John receive the Revelation?", answer: ["patmos"], hint: "A place of exile", reference: "Revelation 1:9" },
            { title: "New Jerusalem", question: "What comes down from heaven like a bride?", answer: ["new jerusalem"], hint: "The holy city", reference: "Revelation 21:2" }
        ];

        // Random Question Generation
        function generateRandomSeals() {
            const shuffled = [...bibleQuestionPool].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 7);
            
            return selected.map((question, index) => ({
                number: index + 1,
                title: question.title,
                question: question.reference ? `${question.question}\n\nüìñ ${question.reference}` : question.question,
                answer: question.answer,
                hint: question.hint
            }));
        }

        // Generate random seals for each new game
        let seals = generateRandomSeals();

        function renderSeals() {
            const sealsGrid = document.getElementById('sealsGrid');
            sealsGrid.innerHTML = '';

            seals.forEach(seal => {
                const sealElement = document.createElement('div');
                sealElement.className = `seal ${gameState.completedSeals.includes(seal.number) ? 'opened' : ''}`;
                sealElement.onclick = () => openSeal(seal);

                sealElement.innerHTML = `
                    <div class="seal-number">${seal.number}</div>
                    <div class="seal-title">${seal.title}</div>
                `;

                sealsGrid.appendChild(sealElement);
            });
        }

        function openSeal(seal) {
            // Check if game is still active
            if (!gameState.isGameActive) {
                showAlert('Game has ended. No more seals can be opened!', 'error');
                return;
            }
            
            if (gameState.completedSeals.includes(seal.number)) {
                showAlert('This seal is already opened!', 'error');
                return;
            }

            gameState.currentPuzzle = seal;
            document.getElementById('puzzleTitle').textContent = `Seal ${seal.number}: ${seal.title}`;
            document.getElementById('puzzleQuestion').textContent = seal.question;
            document.getElementById('puzzleAnswer').value = '';
            document.getElementById('puzzleModal').style.display = 'flex';
            document.getElementById('puzzleAnswer').focus();
        }

        function submitAnswer() {
            // Check if game is still active
            if (!gameState.isGameActive) {
                showAlert('Game has ended. No more answers can be submitted!', 'error');
                closePuzzle();
                return;
            }
            
            const answer = document.getElementById('puzzleAnswer').value.trim().toLowerCase();
            const correctAnswers = gameState.currentPuzzle.answer;

            if (correctAnswers.some(correct => answer.includes(correct))) {
                // Correct answer
                gameState.completedSeals.push(gameState.currentPuzzle.number);

                // Update team score
                const currentTeam = gameState.teams.find(team => team.name === gameState.currentTeam);
                if (currentTeam) {
                    currentTeam.score = gameState.completedSeals.length;
                    currentTeam.completedSeals = [...gameState.completedSeals];
                    // For AI mode, also update lastSealTime for proper ranking
                    if (gameState.mode === 'ai') {
                        currentTeam.lastSealTime = Date.now();
                    }
                }

                console.log('üéØ SEAL COMPLETED - Mode:', gameState.mode, 'Team:', gameState.currentTeam, 'Score:', gameState.completedSeals.length);
                
                // AGGRESSIVE IMMEDIATE WINNER CHECK - FIRST PRIORITY BEFORE ANYTHING ELSE
                if (gameState.mode === 'ai' && gameState.completedSeals.length === 7) {
                    console.log('üö® IMMEDIATE AI MODE WIN DETECTED - FORCING WINNER MODAL NOW!');
                    
                    // Stop everything immediately
                    gameState.isGameActive = false;
                    
                    // Clear all AI timers
                    if (gameState.aiTimers) {
                        gameState.aiTimers.forEach(timer => clearTimeout(timer));
                        gameState.aiTimers = [];
                    }
                    
                    // Force immediate winner handling
                    const elapsed = Date.now() - gameState.startTime;
                    const playerTeam = gameState.teams.find(team => !team.isAI) || { 
                        name: gameState.currentTeam, 
                        isAI: false, 
                        score: 7,
                        completedSeals: [...gameState.completedSeals],
                        lastSealTime: Date.now()
                    };
                    
                    console.log('üèÜ CALLING DIRECT WINNER MODAL DISPLAY');
                    
                    // Calculate rankings immediately
                    const finalRankings = gameState.teams.map(team => ({
                        teamName: team.name,
                        sealsCompleted: team.name === gameState.currentTeam ? 7 : (team.score || 0),
                        completionTime: team.name === gameState.currentTeam ? elapsed : null,
                        lastSealTime: team.lastSealTime || Date.now(),
                        completed: team.name === gameState.currentTeam,
                        isAI: team.isAI || false,
                        rank: 0
                    })).sort((a, b) => {
                        if (a.completed && !b.completed) return -1;
                        if (!a.completed && b.completed) return 1;
                        if (a.sealsCompleted !== b.sealsCompleted) return b.sealsCompleted - a.sealsCompleted;
                        return (a.completionTime || 999999) - (b.completionTime || 999999);
                    }).map((team, index) => ({ ...team, rank: index + 1 }));
                    
                    // Show winner modal immediately
                    try {
                        showWinnerModalWithRankings(gameState.currentTeam, elapsed, finalRankings, true);
                        lockGameInputs();
                        console.log('‚úÖ Winner modal displayed successfully - GAME WON!');
                    } catch (error) {
                        console.error('Winner modal failed:', error);
                        alert(`üèÜ CONGRATULATIONS! You won in ${Math.floor(elapsed/60000)}:${Math.floor((elapsed%60000)/1000).toString().padStart(2,'0')}!`);
                    }
                    
                    return; // EXIT IMMEDIATELY - NO FURTHER CODE EXECUTION
                }

                // Update Firebase if in multiplayer (check for roomCode instead of mode)
                if (gameState.roomCode && gameState.currentTeam) {
                    console.log('üî• UPDATING FIREBASE - Seal completed:', gameState.currentPuzzle.number);
                    console.log('üî• Total seals completed:', gameState.completedSeals.length);
                    updateTeamProgressInFirebase();
                }

                closePuzzle();
                renderSeals();
                updateProgress();
                updateLeaderboard();

                showAlert(`Seal ${gameState.currentPuzzle ? gameState.currentPuzzle.number : 'Unknown'} opened!`, 'success');

                // Enhanced check for 7-seal completion
                console.log('üîç CHECKING COMPLETION - Seals completed:', gameState.completedSeals.length, 'Total:', gameState.completedSeals);
                
                if (gameState.completedSeals.length === 7) {
                    console.log('üéâ TEAM COMPLETED ALL 7 SEALS!', gameState.currentTeam);
                    console.log('üéÆ Game Mode:', gameState.mode);
                    console.log('üéÆ Room code:', gameState.roomCode);
                    console.log('üî• Is multiplayer?', !!gameState.roomCode);
                    console.log('ü§ñ Is AI mode?', gameState.mode === 'ai');
                    console.log('üèÜ Is game still active?', gameState.isGameActive);
                    
                    // Enhanced AI mode handling with immediate winner declaration
                    if (gameState.mode === 'ai') {
                        console.log('üèÜ AI MODE: Player wins by completing 7 seals first!');
                        
                        // CRITICAL: Immediately stop the game and clear all AI timers to prevent race conditions
                        gameState.isGameActive = false;
                        if (gameState.aiTimers && gameState.aiTimers.length > 0) {
                            console.log('üõë EMERGENCY: Clearing', gameState.aiTimers.length, 'AI timers to prevent race condition');
                            gameState.aiTimers.forEach(timer => clearTimeout(timer));
                            gameState.aiTimers = [];
                        }
                        
                        // Force immediate winner handling for player
                        console.log('üöÄ FORCING IMMEDIATE PLAYER VICTORY HANDLING');
                        const elapsed = Date.now() - gameState.startTime;
                        const playerTeam = gameState.teams.find(team => !team.isAI) || { name: gameState.currentTeam, isAI: false };
                        
                        // Update player team with completion data
                        if (playerTeam) {
                            playerTeam.score = 7;
                            playerTeam.completedSeals = [...gameState.completedSeals];
                            playerTeam.lastSealTime = Date.now();
                            console.log('‚úÖ Final player team state:', playerTeam);
                        }
                        
                        // Immediate winner modal display
                        console.log('üèÜ CALLING handleAIGameEnd IMMEDIATELY');
                        handleAIGameEnd(playerTeam, elapsed);
                        
                    } else {
                        console.log('üìû Calling finishGame() for non-AI mode');
                        finishGame();
                    }
                } else {
                    console.log('üîÑ Not enough seals yet:', gameState.completedSeals.length, '< 7');
                }
            } else {
                showAlert('Incorrect answer. Try again!', 'error');
                document.getElementById('puzzleAnswer').focus();
            }
        }

        async function updateTeamProgressInFirebase() {
            if (!gameState.roomCode || !gameState.currentTeam) return;

            const teamData = {
                score: gameState.completedSeals.length,
                completedSeals: gameState.completedSeals,
                lastUpdate: firebase.database.ServerValue.TIMESTAMP,
                lastSealTime: Date.now() // Track when this seal was completed for tiebreaking
            };

            console.log('üíæ FIREBASE UPDATE: Updating team progress...', teamData);
            console.log('üìç FIREBASE UPDATE: Path:', `rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`);

            try {
                await database.ref(`rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`).update(teamData);
                console.log('‚úÖ FIREBASE UPDATE: Team progress updated successfully');
                
                // CRITICAL: Check for winner after EACH seal completion, not just at the end
                if (gameState.completedSeals.length === 7 && gameState.isGameActive) {
                    console.log('üèÜ FIREBASE UPDATE: Team completed 7 seals - checking for winner!');
                    const elapsed = Date.now() - gameState.startTime;
                    await checkForGameWinner(elapsed);
                }
            } catch (error) {
                console.error('‚ùå FIREBASE UPDATE: Failed to update team progress:', error);
            }
        }

        function closePuzzle() {
            document.getElementById('puzzleModal').style.display = 'none';
            gameState.currentPuzzle = null;
        }

        function updateProgress() {
            const completed = gameState.completedSeals.length;
            const total = seals.length;
            const percentage = (completed / total) * 100;

            document.getElementById('progressText').textContent = `${completed}/${total} Seals`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }

        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';

            // Sort teams by score (descending)
            const sortedTeams = [...gameState.teams].sort((a, b) => b.score - a.score);

            sortedTeams.forEach((team, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                const isCurrentTeam = team.name === gameState.currentTeam;
                const teamLabel = isCurrentTeam ? ' (You)' : (team.isAI ? ' ü§ñ' : '');
                item.innerHTML = `
                    <span class="leaderboard-rank">#${index + 1}</span>
                    <span class="leaderboard-name">${team.name}${teamLabel}</span>
                    <span class="leaderboard-score">${team.score}/7</span>
                `;
                leaderboardList.appendChild(item);
            });
        }

        // CRITICAL: Update leaderboard with LIVE Firebase data for real-time sync
        function updateLeaderboardFromFirebase(firebaseTeams) {
            console.log('üìä FIREBASE LEADERBOARD: Updating with live data', firebaseTeams);
            
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) {
                console.log('üìä FIREBASE LEADERBOARD: Leaderboard element not found');
                return;
            }
            
            leaderboardList.innerHTML = '';

            // Convert Firebase teams object to array and sort by score
            const teamsArray = Object.entries(firebaseTeams).map(([teamId, teamData]) => ({
                id: teamId,
                name: teamData.name || teamId,
                score: teamData.score || (teamData.completedSeals ? teamData.completedSeals.length : 0),
                completedSeals: teamData.completedSeals || [],
                isHost: teamData.isHost || false
            }));

            // Sort by score (descending)
            const sortedTeams = teamsArray.sort((a, b) => b.score - a.score);
            
            console.log('üìä FIREBASE LEADERBOARD: Sorted teams:', sortedTeams);

            sortedTeams.forEach((team, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                const isCurrentTeam = team.name === gameState.currentTeam;
                item.innerHTML = `
                    <span class="leaderboard-rank">#${index + 1}</span>
                    <span class="leaderboard-name">${team.name}${isCurrentTeam ? ' (YOU)' : ''}</span>
                    <span class="leaderboard-score">${team.score}/7</span>
                `;
                leaderboardList.appendChild(item);
            });
            
            console.log('üìä FIREBASE LEADERBOARD: Leaderboard updated successfully');
        }

        function startTimer() {
            const timerElement = document.getElementById('timer');

            setInterval(() => {
                if (gameState.isGameActive && gameState.startTime) {
                    const elapsed = Date.now() - gameState.startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function finishGame() {
            console.log('üèÅ finishGame() called');
            console.log('üéÆ gameState.mode:', gameState.mode);
            console.log('üë• gameState.currentTeam:', gameState.currentTeam);
            console.log('üìä gameState.teams:', gameState.teams);
            console.log('üèÜ gameState.isGameActive:', gameState.isGameActive);
            
            const elapsed = Date.now() - gameState.startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            if (gameState.mode === 'ai') {
                // AI mode - player won!
                console.log('üèÜ AI mode - player completed all seals first!');
                
                // Find and update the player team
                const playerTeam = gameState.teams.find(team => !team.isAI);
                console.log('üéØ Found player team:', playerTeam);
                
                if (playerTeam) {
                    // Ensure player team has correct completion data
                    playerTeam.score = Math.max(playerTeam.score, 7); // Ensure it's 7
                    playerTeam.completedSeals = [...gameState.completedSeals];
                    playerTeam.lastSealTime = Date.now();
                    console.log('‚úÖ Updated player team:', playerTeam);
                }
                
                // End the game and show winner modal
                console.log('üéâ Calling handleAIGameEnd for player victory');
                handleAIGameEnd(playerTeam || { name: gameState.currentTeam, isAI: false }, elapsed);
                
            } else if (gameState.roomCode) {
                // Multiplayer mode - winner detection handled in Firebase update
                console.log('üèÜ Multiplayer mode - winner detection handled in Firebase update');
            } else {
                // Single player mode
                console.log('üéÆ Single player mode - showing completion message');
                showAlert(`üéâ Congratulations! All seals opened in ${minutes}:${seconds.toString().padStart(2, '0')}!`, 'success');
            }
        }

        // Enhanced winner detection and ranking system for multi-team scenarios
        async function checkForGameWinner(completionTime) {
            try {
                console.log('üèÜ checkForGameWinner() called with time:', completionTime);
                console.log('üì° Database available?', !!database);
                console.log('üéÆ Room code:', gameState.roomCode);
                
                if (!database || !gameState.roomCode) {
                    console.log('‚ùå Missing database or room code, returning');
                    return;
                }

                console.log('üèÜ Checking for game winner...');
                
                // Mark this team as completed with timestamp and last seal time
                const teamCompletionData = {
                    completed: true,
                    completionTime: completionTime,
                    completedAt: firebase.database.ServerValue.TIMESTAMP,
                    finalScore: gameState.completedSeals.length,
                    lastSealTime: Date.now() // Track when last seal was clicked for tiebreaking
                };

                console.log('üíæ Updating team data:', teamCompletionData);
                console.log('üìç Path:', `rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`);
                
                await database.ref(`rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`).update(teamCompletionData);
                console.log('‚úÖ Team data updated successfully');

                // Check if this is the first team to complete
                console.log('üîç Checking room data for other completed teams...');
                const roomSnapshot = await database.ref(`rooms/${gameState.roomCode}`).once('value');
                const roomData = roomSnapshot.val();
                
                console.log('üìä Current room data:', roomData);

                if (roomData && roomData.teams) {
                    // Check for teams that completed 7 seals
                    const teams = Object.values(roomData.teams);
                    const teamsWithSevenSeals = teams.filter(team => {
                        const sealsCount = team.completedSeals ? team.completedSeals.length : (team.score || 0);
                        return sealsCount >= 7 || team.completed;
                    });
                    
                    console.log('üë• All teams scores:', teams.map(t => ({ 
                        name: t.name, 
                        seals: t.completedSeals ? t.completedSeals.length : (t.score || 0),
                        completed: t.completed 
                    })));
                    console.log('üèÅ Teams with 7 seals:', teamsWithSevenSeals.length);

                    if (teamsWithSevenSeals.length === 1) {
                        // This is the winner! End the game for everyone
                        console.log('üèÜ First team to complete - declaring winner!');
                        
                        // Calculate final rankings for all teams
                        const finalRankings = await calculateFinalRankings(teams);
                        
                        const gameEndData = {
                            winner: gameState.currentTeam,
                            completionTime: completionTime,
                            endedAt: firebase.database.ServerValue.TIMESTAMP,
                            gameActive: false,
                            status: 'finished',
                            finalRankings: finalRankings
                        };

                        console.log('üíæ Setting game end data:', gameEndData);
                        await database.ref(`rooms/${gameState.roomCode}`).update(gameEndData);
                        console.log('‚úÖ Game end data saved to Firebase');
                        
                        // Show winner modal with rankings to all players
                        console.log('üéâ Showing winner modal with rankings...');
                        showWinnerModalWithRankings(gameState.currentTeam, completionTime, finalRankings, true);
                    } else if (teamsWithSevenSeals.length > 1) {
                        // Someone else already won - show existing rankings if available
                        console.log('ü•à Another team already won');
                        if (roomData.finalRankings) {
                            showWinnerModalWithRankings(roomData.winner, roomData.completionTime, roomData.finalRankings, false);
                        } else {
                            const winner = teamsWithSevenSeals[0];
                            showWinnerModal(winner.name || 'Another team', winner.completionTime || completionTime, false);
                        }
                    } else {
                        console.log('üîÑ No teams with 7 seals yet');
                    }
                } else {
                    console.log('‚ùå No room data or teams found');
                }

            } catch (error) {
                console.error('Error checking for winner:', error);
                const minutes = Math.floor(completionTime / 60000);
                const seconds = Math.floor((completionTime % 60000) / 1000);
                showAlert(`üéâ Congratulations! All seals opened in ${minutes}:${seconds.toString().padStart(2, '0')}!`, 'success');
            }
        }

        // Calculate final rankings for all teams
        async function calculateFinalRankings(teams) {
            console.log('üìä Calculating final rankings for teams:', teams.length);
            
            const rankings = teams.map(team => {
                const sealsCount = team.completedSeals ? team.completedSeals.length : (team.score || 0);
                return {
                    teamName: team.name,
                    sealsCompleted: sealsCount,
                    completionTime: team.completionTime || null,
                    lastSealTime: team.lastSealTime || Date.now(),
                    completed: team.completed || false
                };
            });

            // Sort rankings:
            // 1. By completion status (completed teams first)
            // 2. By number of seals completed (higher is better)
            // 3. By completion time for completed teams (faster is better)
            // 4. By last seal time for incomplete teams (faster last seal is better)
            rankings.sort((a, b) => {
                // Completed teams come first
                if (a.completed && !b.completed) return -1;
                if (!a.completed && b.completed) return 1;
                
                // Both completed or both incomplete - sort by seals
                if (a.sealsCompleted !== b.sealsCompleted) {
                    return b.sealsCompleted - a.sealsCompleted; // Higher seals first
                }
                
                // Same number of seals - use time
                if (a.completed && b.completed && a.completionTime && b.completionTime) {
                    return a.completionTime - b.completionTime; // Faster completion first
                }
                
                // For incomplete teams with same seals, use last seal time
                if (a.lastSealTime && b.lastSealTime) {
                    return a.lastSealTime - b.lastSealTime; // Earlier last seal first
                }
                
                return 0;
            });

            // Add rank positions
            rankings.forEach((team, index) => {
                team.rank = index + 1;
            });

            console.log('üèÜ Final rankings calculated:', rankings);
            return rankings;
        }

        // Enhanced winner modal with final rankings for multi-team scenarios
        function showWinnerModalWithRankings(winnerTeam, completionTime, rankings, isWinner) {
            console.log('üéâ showWinnerModalWithRankings() called');
            console.log('üèÜ Winner team:', winnerTeam);
            console.log('‚è∞ Completion time:', completionTime);
            console.log('üìä Rankings:', rankings);
            console.log('üéØ Is winner?', isWinner);
            
            const minutes = Math.floor(completionTime / 60000);
            const seconds = Math.floor((completionTime % 60000) / 1000);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            const modalTitle = isWinner ? 'üèÜ CONGRATULATIONS!' : 'üéÆ GAME OVER';
            const modalMessage = isWinner ? 
                `YOUR TEAM HAS WON THE GAME!` : 
                `${winnerTeam} HAS WON THE GAME!`;

            // Generate rankings HTML
            let rankingsHTML = '';
            if (rankings && rankings.length > 0) {
                rankingsHTML = `
                    <div style="background: rgba(0, 0, 0, 0.4); border: 1px solid #c9a96e; 
                                border-radius: 8px; padding: 15px; margin: 15px 0; max-height: 250px; overflow-y: auto;">
                        <h3 style="color: #ffd700; margin-bottom: 15px; text-align: center;">üèÖ Final Rankings</h3>
                        <div style="text-align: left;">
                `;
                
                rankings.forEach((team, index) => {
                    const rank = team.rank || (index + 1);
                    const isCurrentTeam = team.teamName === gameState.currentTeam;
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                    const completionDisplay = team.completed ? 
                        `‚úÖ ${Math.floor((team.completionTime || 0) / 60000)}:${Math.floor(((team.completionTime || 0) % 60000) / 1000).toString().padStart(2, '0')}` : 
                        `‚è±Ô∏è ${team.sealsCompleted}/7 seals`;
                    const teamLabel = isCurrentTeam ? ' (YOU)' : (team.isAI ? ' ü§ñ' : '');
                    
                    rankingsHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; 
                                    padding: 8px 12px; margin: 5px 0; background: rgba(0, 0, 0, 0.2); 
                                    border-radius: 5px; ${isCurrentTeam ? 'border: 1px solid #ffd700;' : ''}">
                            <span style="color: #ffd700; font-weight: bold; min-width: 30px;">${medal}</span>
                            <span style="color: ${isCurrentTeam ? '#ffd700' : '#e8dcc0'}; flex: 1; margin: 0 10px; font-weight: ${isCurrentTeam ? 'bold' : 'normal'};">
                                ${team.teamName}${teamLabel}
                            </span>
                            <span style="color: #c9a96e; font-size: 0.9em;">${completionDisplay}</span>
                        </div>
                    `;
                });
                
                rankingsHTML += `
                        </div>
                    </div>
                `;
            }
                
            console.log('üé® Creating enhanced modal with rankings');

            const modalHTML = `
                <div id="winnerModal" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                    align-items: center; z-index: 10000;">
                    <div style="
                        background: linear-gradient(145deg, #2c1810, #3a1f12);
                        border: 3px solid #ffd700; border-radius: 15px; padding: 30px;
                        text-align: center; max-width: 600px; width: 95%; max-height: 90%; overflow-y: auto;
                        box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3);">
                        <h2 style="color: #ffd700; font-size: 2.5em; margin-bottom: 20px; 
                                   text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${modalTitle}</h2>
                        <div style="margin: 20px 0;">
                            <div style="font-size: 1.4em; color: #c9a96e; margin-bottom: 15px; font-weight: bold;">
                                ${modalMessage}
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid #c9a96e; 
                                        border-radius: 8px; padding: 15px; margin: 15px 0;">
                                <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Winning Team:</strong> ${winnerTeam}</p>
                                <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Completion Time:</strong> ${timeString}</p>
                            </div>
                            ${rankingsHTML}
                        </div>
                        <button onclick="closeWinnerModal()" style="
                            background: #d4af37; color: #2c1810; border: none; padding: 12px 24px;
                            border-radius: 5px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                            Return to Lobby
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Lock the game for all players
            lockGameInputs();

            // Auto-close after 45 seconds (more time to view rankings)
            setTimeout(() => {
                closeWinnerModal();
            }, 45000);
        }

        // Show winner modal to all players (legacy function for backward compatibility)
        function showWinnerModal(winnerTeam, completionTime, isWinner) {
            console.log('üéâ showWinnerModal() called');
            console.log('üèÜ Winner team:', winnerTeam);
            console.log('‚è∞ Completion time:', completionTime);
            console.log('üéØ Is winner?', isWinner);
            
            const minutes = Math.floor(completionTime / 60000);
            const seconds = Math.floor((completionTime % 60000) / 1000);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            const modalTitle = isWinner ? 'üèÜ CONGRATULATIONS!' : 'üéÆ GAME OVER';
            const modalMessage = isWinner ? 
                `Your team has won the game!` : 
                `${winnerTeam} has won the game!`;
                
            console.log('üé® Creating modal with title:', modalTitle);

            const modalHTML = `
                <div id="winnerModal" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                    align-items: center; z-index: 10000;">
                    <div style="
                        background: linear-gradient(145deg, #2c1810, #3a1f12);
                        border: 3px solid #ffd700; border-radius: 15px; padding: 30px;
                        text-align: center; max-width: 500px; width: 90%;
                        box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3);">
                        <h2 style="color: #ffd700; font-size: 2.5em; margin-bottom: 20px; 
                                   text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${modalTitle}</h2>
                        <div style="margin: 20px 0;">
                            <div style="font-size: 1.4em; color: #c9a96e; margin-bottom: 15px; font-weight: bold;">
                                ${modalMessage}
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid #c9a96e; 
                                        border-radius: 8px; padding: 15px; margin: 15px 0;">
                                <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Winning Team:</strong> ${winnerTeam}</p>
                                <p style="margin: 8px 0; color: #e8dcc0;"><strong style="color: #ffd700;">Completion Time:</strong> ${timeString}</p>
                            </div>
                        </div>
                        <button onclick="closeWinnerModal()" style="
                            background: #d4af37; color: #2c1810; border: none; padding: 12px 24px;
                            border-radius: 5px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                            Return to Lobby
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Lock the game for all players
            lockGameInputs();

            // Auto-close after 30 seconds
            setTimeout(() => {
                closeWinnerModal();
            }, 30000);
        }

        // Lock game inputs when game ends
        function lockGameInputs() {
            gameState.isGameActive = false;
            
            // Disable all seal buttons
            const sealButtons = document.querySelectorAll('.seal');
            sealButtons.forEach(button => {
                button.onclick = null;
                button.style.pointerEvents = 'none';
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            });

            // Close any open puzzle modals
            const puzzleModal = document.getElementById('puzzleModal');
            if (puzzleModal) {
                puzzleModal.style.display = 'none';
            }

            // Add visual indicator that game has ended
            const gameContainer = document.getElementById('gameContainer');
            if (gameContainer) {
                gameContainer.style.filter = 'grayscale(30%)';
                
                // Add overlay message
                const overlay = document.createElement('div');
                overlay.id = 'gameEndOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.3);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 5000;
                    pointer-events: none;
                `;
                overlay.innerHTML = `
                    <div style="
                        background: rgba(139, 0, 0, 0.9);
                        color: #ffd700;
                        padding: 20px 40px;
                        border-radius: 10px;
                        border: 2px solid #ffd700;
                        font-size: 1.5em;
                        font-weight: bold;
                        text-align: center;
                        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                    ">
                        üîí GAME ENDED
                        <br>
                        <span style="font-size: 0.7em; margin-top: 10px; display: block;">
                            A team has completed all seven seals
                        </span>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            console.log('üîí Game inputs locked - game has ended');
        }

        // Close winner modal
        function closeWinnerModal() {
            const modal = document.getElementById('winnerModal');
            if (modal) {
                modal.remove();
            }
            
            // Clean up game end overlay
            const overlay = document.getElementById('gameEndOverlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Reset game container filter
            const gameContainer = document.getElementById('gameContainer');
            if (gameContainer) {
                gameContainer.style.filter = '';
            }
            
            // Go back to lobby
            showLobby();
        }

        function resetGameState() {
            // Generate new random questions for replayability
            seals = generateRandomSeals();
            
            gameState.completedSeals = [];
            gameState.isGameActive = false;
            gameState.startTime = null;

            // Reset team scores
            gameState.teams.forEach(team => {
                team.score = 0;
                team.completedSeals = [];
            });

            renderSeals();
            updateProgress();
            updateLeaderboard();

            document.getElementById('timer').textContent = '00:00';
            showAlert('New questions generated! Game reset!', 'success');
        }

        function goBack() {
            // Clean up Firebase listeners
            if (gameState.roomRef) {
                gameState.roomRef.off();
                gameState.roomRef = null;
            }

            // Clean up AI timers
            if (gameState.aiTimers) {
                gameState.aiTimers.forEach(timer => clearTimeout(timer));
                gameState.aiTimers = [];
            }

            // Hide all game sections
            document.getElementById('multiplayerSetup').style.display = 'none';
            document.getElementById('aiSetup').style.display = 'none';
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'none';

            // Show mode selection
            document.getElementById('modeSelection').style.display = 'grid';

            // Reset game state
            gameState = {
                mode: '',
                currentTeam: '',
                teams: [],
                completedSeals: [],
                startTime: null,
                currentPuzzle: null,
                isGameActive: false,
                roomCode: '',
                isHost: false,
                roomRef: null,
                // AI Mode specific
                aiTeams: [],
                aiTimers: [],
                aiDifficulty: 'medium'
            };

            // Clear URL parameters
            window.history.pushState({}, '', window.location.pathname);
        }

        function copyRoomLink() {
            const shareLink = document.getElementById('shareLink').textContent;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareLink).then(() => {
                    showAlert('Room link copied to clipboard!', 'success');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('Room link copied to clipboard!', 'success');
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            document.body.appendChild(alert);

            setTimeout(() => alert.classList.add('show'), 100);

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => document.body.removeChild(alert), 300);
            }, 3000);
        }

        // Handle Enter key in inputs
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (e.target.id === 'puzzleAnswer') {
                    submitAnswer();
                }
            }
        });
    </script>
</body>

</html>
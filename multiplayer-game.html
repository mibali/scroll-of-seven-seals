<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Scroll of Seven Seals - Real Multiplayer</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Uncial+Antiqua&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #2c1810, #4a3425, #6b4d37);
            color: #f4f1e8;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #d4af37;
        }
        
        .title {
            font-family: 'Uncial Antiqua', cursive;
            font-size: 2.5em;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
        }
        
        .game-mode {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .mode-card {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #8b7355;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .mode-card:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .mode-card h3 {
            color: #d4af37;
            margin-bottom: 10px;
        }
        
        .team-setup {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #8b7355;
            margin-bottom: 20px;
            display: none;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #d4af37;
            font-weight: 600;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #8b7355;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.3);
            color: #f4f1e8;
            font-family: 'Cinzel', serif;
        }
        
        .btn {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #2c1810;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background: linear-gradient(145deg, #e6c757, #d4af37);
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
        
        .lobby-team {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #8b7355;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        
        .lobby-team.host {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            background: rgba(34, 139, 34, 0.3);
            color: #90ee90;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 1000;
        }
        
        .connected {
            background: rgba(34, 139, 34, 0.8);
            color: white;
        }
        
        .disconnected {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }
        
        .connecting {
            background: rgba(255, 193, 7, 0.8);
            color: black;
        }
        
        .game-info {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .timer {
            font-family: monospace;
            font-size: 1.5em;
            color: #d4af37;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #d4af37;
        }
        
        .progress {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid #8b7355;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #e6c757);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .seals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .seal {
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4));
            border: 2px solid #8b7355;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .seal:hover {
            border-color: #d4af37;
            transform: translateY(-2px);
        }
        
        .seal.completed {
            border-color: #228b22;
            background: linear-gradient(145deg, rgba(34, 139, 34, 0.3), rgba(34, 139, 34, 0.1));
        }
        
        .seal.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .seal-number {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: #d4af37;
            color: #2c1810;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .seal-title {
            font-size: 1.3em;
            color: #d4af37;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .leaderboard {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #8b7355;
            margin-bottom: 20px;
            display: none;
        }
        
        .leaderboard h3 {
            color: #d4af37;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .team-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 3px solid #8b7355;
        }
        
        .team-entry.first { border-left-color: #ffd700; }
        .team-entry.second { border-left-color: #c0c0c0; }
        .team-entry.third { border-left-color: #cd7f32; }
        
        .final-challenge {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
            display: none;
        }
        
        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #ff6b6b;
        }
        
        .success-message {
            background: rgba(34, 139, 34, 0.2);
            border: 1px solid #228b22;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #90ee90;
        }
        
        @media (max-width: 768px) {
            .game-mode {
                grid-template-columns: 1fr;
            }
            
            .game-info {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .title {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status connecting" id="connectionStatus">
        üîÑ Connecting to server...
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">üîÆ The Scroll of Seven Seals</h1>
            <p>Real Multiplayer Bible Mystery Adventure</p>
        </div>

        <!-- Error Display -->
        <div id="errorMessage" class="error-message hidden"></div>
        <div id="successMessage" class="success-message hidden"></div>

        <!-- Game Mode Selection -->
        <div id="modeSelection" class="game-mode">
            <div class="mode-card" onclick="selectMode('single')">
                <h3>üè† Single Group</h3>
                <p>Play as one team and beat your best time</p>
            </div>
            <div class="mode-card" onclick="selectMode('multi')">
                <h3>ü§ñ vs Computer Teams</h3>
                <p>Compete against AI opponents</p>
            </div>
            <div class="mode-card" onclick="selectMode('room')">
                <h3>üåê Real Multiplayer</h3>
                <p>Compete with friends online</p>
            </div>
        </div>

        <!-- Team Setup -->
        <div id="teamSetup" class="team-setup">
            <h3 id="setupTitle">Team Setup</h3>
            <div class="input-group">
                <label for="teamName">Team Name:</label>
                <input type="text" id="teamName" placeholder="Enter your team name">
            </div>
            
            <div id="multiSetup" class="hidden">
                <div class="input-group">
                    <label for="numTeams">Number of Teams:</label>
                    <select id="numTeams">
                        <option value="2">2 teams</option>
                        <option value="3">3 teams</option>
                        <option value="4">4 teams</option>
                        <option value="5">5 teams</option>
                        <option value="6">6 teams</option>
                    </select>
                </div>
            </div>
            
            <div id="roomSetup" class="hidden">
                <div class="input-group">
                    <label>Choose an option:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 10px 0;">
                        <button class="btn" onclick="createRoom()">üèóÔ∏è Create Room</button>
                        <button class="btn" onclick="showJoinRoom()">üö™ Join Room</button>
                    </div>
                </div>
                <div id="joinRoomDiv" class="hidden">
                    <div class="input-group">
                        <label for="roomCode">Room Code:</label>
                        <input type="text" id="roomCode" placeholder="Enter 6-digit code" maxlength="6" style="text-transform: uppercase;">
                    </div>
                    <button class="btn" onclick="joinRoom()">Join Room</button>
                </div>
            </div>
            
            <button class="btn" onclick="startGame()">Start Adventure</button>
            <button class="btn" onclick="goBack()" style="background: #8b7355;">‚Üê Back</button>
        </div>

        <!-- Room Lobby -->
        <div id="roomLobby" class="hidden">
            <div class="header">
                <h2 id="lobbyTitle">Game Room</h2>
                <div id="roomInfo" style="margin-top: 15px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid #d4af37;">
                        <strong>Room Code: <span id="displayRoomCode" style="font-family: monospace; font-size: 1.2em; color: #d4af37;"></span></strong>
                        <button class="btn" onclick="copyRoomCode()" style="margin-left: 10px; padding: 5px 10px;">üìã Copy</button>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; border: 1px solid #8b7355;">
                <h3 style="color: #d4af37; text-align: center; margin-bottom: 20px;">
                    Teams in Lobby (<span id="teamCount">0</span>/6)
                </h3>
                <div id="lobbyTeams"></div>
                
                <div style="text-align: center; padding-top: 15px; border-top: 1px solid #8b7355;">
                    <div id="hostControls" class="hidden">
                        <button class="btn" id="startRoomGame" onclick="startRoomGame()" disabled>üöÄ Start Game</button>
                        <p style="margin: 10px 0; font-size: 0.9em; opacity: 0.8;">Need at least 2 teams to start</p>
                    </div>
                    <button class="btn" onclick="leaveRoom()" style="background: #dc3545;">üö™ Leave Room</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <!-- Game Info Bar -->
            <div class="game-info">
                <div>
                    <strong id="currentTeam">Team Name</strong>
                    <div id="gameMode">Game Mode</div>
                </div>
                <div class="timer" id="timer">00:00</div>
                <button class="btn" onclick="resetGame()" style="background: #dc3545;">Reset Game</button>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboard" class="leaderboard">
                <h3>üèÜ Live Leaderboard</h3>
                <div id="leaderboardContent"></div>
            </div>

            <!-- Progress Bar -->
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div style="text-align: center; margin: 10px 0;">
                <span id="progressText">0/7 Seals Broken</span>
            </div>

            <!-- Seals Grid -->
            <div class="seals-grid" id="sealsGrid"></div>

            <!-- Final Challenge -->
            <div id="finalChallenge" class="final-challenge">
                <h2>üéâ Final Challenge Complete!</h2>
                <div id="victoryMessage"></div>
                <button class="btn" onclick="resetGame()">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (Demo - you'll need to replace with your own)
        const firebaseConfig = {
            apiKey: "AIzaSyDemo_Replace_With_Your_Key",
            authDomain: "scroll-seals-demo.firebaseapp.com",
            databaseURL: "https://scroll-seals-demo-default-rtdb.firebaseio.com",
            projectId: "scroll-seals-demo",
            storageBucket: "scroll-seals-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:demo"
        };

        // Initialize Firebase
        let database = null;
        let isConnected = false;

        // Initialize Firebase with error handling
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    
                    // Test connection
                    database.ref('.info/connected').on('value', (snapshot) => {
                        isConnected = snapshot.val();
                        updateConnectionStatus();
                    });
                    
                    showSuccess('Connected to multiplayer server!');
                } else {
                    throw new Error('Firebase not loaded');
                }
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                showError('Multiplayer server unavailable. Using offline mode.');
                isConnected = false;
                updateConnectionStatus();
            }
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (isConnected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = 'üü¢ Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = 'üî¥ Offline Mode';
            }
        }

        // Game State
        let gameState = {
            mode: '',
            currentTeam: '',
            teams: [],
            completedSeals: [],
            startTime: null,
            currentPuzzle: null,
            isGameActive: false,
            roomCode: '',
            isHost: false,
            roomRef: null
        };

        // Seal Data (simplified for demo)
        const seals = [
            { id: 1, title: "The Garden Cipher", description: "Arrange Genesis creation events in order", unlock: [] },
            { id: 2, title: "The Blood Trail", description: "Answer questions about biblical sacrifices", unlock: [1] },
            { id: 3, title: "The Prophecy Scroll", description: "Match prophecies with fulfillments", unlock: [2] },
            { id: 4, title: "The Parable Labyrinth", description: "Navigate Jesus' teachings", unlock: [3] },
            { id: 5, title: "The Upper Room", description: "Solve the Last Supper mystery", unlock: [4] },
            { id: 6, title: "The Church Underground", description: "Decode apostolic messages", unlock: [5] },
            { id: 7, title: "The Apocalypse Map", description: "Interpret Revelation symbols", unlock: [6] }
        ];

        // Utility Functions
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.classList.remove('hidden');
            setTimeout(() => successEl.classList.add('hidden'), 3000);
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Game Mode Selection
        function selectMode(mode) {
            if (mode === 'room' && !isConnected) {
                showError('Multiplayer requires internet connection. Please check your connection and refresh.');
                return;
            }

            gameState.mode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('teamSetup').style.display = 'block';
            
            // Hide all setup sections first
            document.getElementById('multiSetup').classList.add('hidden');
            document.getElementById('roomSetup').classList.add('hidden');
            
            if (mode === 'single') {
                document.getElementById('setupTitle').textContent = 'Single Group Setup';
            } else if (mode === 'multi') {
                document.getElementById('setupTitle').textContent = 'vs Computer Teams Setup';
                document.getElementById('multiSetup').classList.remove('hidden');
            } else if (mode === 'room') {
                document.getElementById('setupTitle').textContent = 'Real Multiplayer Setup';
                document.getElementById('roomSetup').classList.remove('hidden');
            }
        }

        function goBack() {
            document.getElementById('modeSelection').style.display = 'grid';
            document.getElementById('teamSetup').style.display = 'none';
            document.getElementById('joinRoomDiv').classList.add('hidden');
            resetGameState();
        }

        function resetGameState() {
            if (gameState.roomRef) {
                gameState.roomRef.off();
            }
            gameState = {
                mode: '',
                currentTeam: '',
                teams: [],
                completedSeals: [],
                startTime: null,
                currentPuzzle: null,
                isGameActive: false,
                roomCode: '',
                isHost: false,
                roomRef: null
            };
        }

        // Room Functions
        function createRoom() {
            if (!isConnected) {
                showError('Cannot create room - no internet connection');
                return;
            }

            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                showError('Please enter a team name first');
                return;
            }

            const roomCode = generateRoomCode();
            gameState.roomCode = roomCode;
            gameState.isHost = true;
            gameState.currentTeam = teamName;

            // Create room in Firebase
            const roomData = {
                code: roomCode,
                host: teamName,
                teams: {
                    [teamName]: { 
                        name: teamName, 
                        isHost: true, 
                        joinTime: Date.now(), 
                        seals: 0, 
                        finished: false,
                        time: 0
                    }
                },
                status: 'waiting',
                gameStarted: false,
                createdAt: Date.now()
            };

            database.ref(`rooms/${roomCode}`).set(roomData)
                .then(() => {
                    showSuccess(`Room ${roomCode} created successfully!`);
                    showLobby();
                })
                .catch((error) => {
                    showError('Failed to create room: ' + error.message);
                });
        }

        function showJoinRoom() {
            document.getElementById('joinRoomDiv').classList.remove('hidden');
        }

        function joinRoom() {
            if (!isConnected) {
                showError('Cannot join room - no internet connection');
                return;
            }

            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            const teamName = document.getElementById('teamName').value.trim();
            
            if (!roomCode || !teamName) {
                showError('Please enter both room code and team name');
                return;
            }

            // Check if room exists
            database.ref(`rooms/${roomCode}`).once('value')
                .then((snapshot) => {
                    const roomData = snapshot.val();
                    
                    if (!roomData) {
                        showError('Room not found. Please check the room code.');
                        return;
                    }

                    if (roomData.status !== 'waiting') {
                        showError('This game has already started or finished.');
                        return;
                    }

                    const teamCount = Object.keys(roomData.teams || {}).length;
                    if (teamCount >= 6) {
                        showError('This room is full (maximum 6 teams).');
                        return;
                    }

                    // Check if team name already exists
                    if (roomData.teams && roomData.teams[teamName]) {
                        showError('A team with this name already exists in the room.');
                        return;
                    }

                    // Join the room
                    gameState.roomCode = roomCode;
                    gameState.isHost = false;
                    gameState.currentTeam = teamName;

                    const teamData = { 
                        name: teamName, 
                        isHost: false, 
                        joinTime: Date.now(), 
                        seals: 0, 
                        finished: false,
                        time: 0
                    };

                    database.ref(`rooms/${roomCode}/teams/${teamName}`).set(teamData)
                        .then(() => {
                            showSuccess(`Joined room ${roomCode} successfully!`);
                            showLobby();
                        })
                        .catch((error) => {
                            showError('Failed to join room: ' + error.message);
                        });
                })
                .catch((error) => {
                    showError('Error checking room: ' + error.message);
                });
        }

        function showLobby() {
            document.getElementById('teamSetup').style.display = 'none';
            document.getElementById('roomLobby').classList.remove('hidden');
            document.getElementById('displayRoomCode').textContent = gameState.roomCode;
            
            if (gameState.isHost) {
                document.getElementById('lobbyTitle').textContent = 'Game Room (Host)';
                document.getElementById('hostControls').classList.remove('hidden');
            } else {
                document.getElementById('lobbyTitle').textContent = 'Game Room';
                document.getElementById('hostControls').classList.add('hidden');
            }

            // Listen for room updates
            gameState.roomRef = database.ref(`rooms/${gameState.roomCode}`);
            gameState.roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (roomData) {
                    updateLobby(roomData);
                    
                    // Check if game started
                    if (roomData.gameStarted && !gameState.isGameActive) {
                        startRoomGameplay();
                    }
                } else {
                    showError('Room no longer exists');
                    leaveRoom();
                }
            });
        }

        function updateLobby(roomData) {
            // Update team count
            const teamCount = Object.keys(roomData.teams || {}).length;
            document.getElementById('teamCount').textContent = teamCount;

            // Update teams list
            let teamsHtml = '';
            Object.values(roomData.teams || {}).forEach(team => {
                const hostBadge = team.isHost ? ' üëë' : '';
                teamsHtml += `
                    <div class="lobby-team ${team.isHost ? 'host' : ''}">
                        <div>
                            <strong>${team.name}${hostBadge}</strong>
                            <div style="font-size: 0.9em; opacity: 0.7;">Joined ${new Date(team.joinTime).toLocaleTimeString()}</div>
                        </div>
                        <div class="status">Ready</div>
                    </div>
                `;
            });

            document.getElementById('lobbyTeams').innerHTML = teamsHtml;

            // Update start button for host
            if (gameState.isHost) {
                const startBtn = document.getElementById('startRoomGame');
                const canStart = teamCount >= 2;
                startBtn.disabled = !canStart;
                startBtn.textContent = canStart ? 'üöÄ Start Game' : 'üöÄ Start Game (Need 2+ teams)';
            }
        }

        function startRoomGame() {
            if (!gameState.isHost) return;

            database.ref(`rooms/${gameState.roomCode}`).update({
                gameStarted: true,
                status: 'playing',
                startTime: Date.now()
            }).then(() => {
                showSuccess('Game started!');
            }).catch((error) => {
                showError('Failed to start game: ' + error.message);
            });
        }

        function startRoomGameplay() {
            gameState.startTime = Date.now();
            gameState.isGameActive = true;
            gameState.completedSeals = [];

            // Show game screen
            document.getElementById('roomLobby').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('currentTeam').textContent = gameState.currentTeam;
            document.getElementById('gameMode').textContent = 'Real Multiplayer Competition';
            document.getElementById('leaderboard').style.display = 'block';

            renderSeals();
            startTimer();
            
            // Listen for room updates during game
            if (gameState.roomRef) {
                gameState.roomRef.on('value', (snapshot) => {
                    const roomData = snapshot.val();
                    if (roomData && roomData.teams) {
                        updateRoomLeaderboard(Object.values(roomData.teams));
                    }
                });
            }
        }

        function updateRoomLeaderboard(teams) {
            // Sort teams by progress and time
            const sortedTeams = [...teams].sort((a, b) => {
                if (a.finished && !b.finished) return -1;
                if (!a.finished && b.finished) return 1;
                if (a.finished && b.finished) return a.time - b.time;
                return b.seals - a.seals || a.time - b.time;
            });

            let html = '';
            sortedTeams.forEach((team, index) => {
                const rank = index + 1;
                const timeStr = formatTime(team.time || 0);
                const statusClass = rank === 1 ? 'first' : rank === 2 ? 'second' : rank === 3 ? 'third' : '';
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                const status = team.finished ? '‚úÖ Finished' : `${team.seals}/7 seals`;
                const isCurrentTeam = team.name === gameState.currentTeam;
                
                html += `
                    <div class="team-entry ${statusClass}" style="${isCurrentTeam ? 'border: 2px solid #d4af37;' : ''}">
                        <div>
                            <strong>${medal} ${team.name}${isCurrentTeam ? ' (You)' : ''}</strong>
                            <div style="font-size: 0.9em; opacity: 0.8;">${status}</div>
                        </div>
                        <div style="text-align: right;">
                            <strong>${timeStr}</strong>
                        </div>
                    </div>
                `;
            });

            document.getElementById('leaderboardContent').innerHTML = html;
        }

        function updateTeamProgress() {
            if (gameState.mode === 'room' && isConnected && gameState.roomCode) {
                const teamData = {
                    seals: gameState.completedSeals.length,
                    time: Date.now() - gameState.startTime,
                    finished: gameState.completedSeals.length === 7
                };

                database.ref(`rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`).update(teamData)
                    .catch((error) => {
                        console.error('Failed to update team progress:', error);
                    });
            }
        }

        function leaveRoom() {
            if (gameState.roomRef) {
                gameState.roomRef.off();
            }

            if (isConnected && gameState.roomCode && gameState.currentTeam) {
                // Remove team from room
                database.ref(`rooms/${gameState.roomCode}/teams/${gameState.currentTeam}`).remove()
                    .then(() => {
                        // If host is leaving, delete entire room
                        if (gameState.isHost) {
                            return database.ref(`rooms/${gameState.roomCode}`).remove();
                        }
                    })
                    .catch((error) => {
                        console.error('Error leaving room:', error);
                    });
            }

            // Reset to main menu
            document.getElementById('roomLobby').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('modeSelection').style.display = 'grid';
            document.getElementById('teamName').value = '';
            document.getElementById('roomCode').value = '';
            document.getElementById('joinRoomDiv').classList.add('hidden');
            
            resetGameState();
        }

        function copyRoomCode() {
            const roomCode = gameState.roomCode;
            navigator.clipboard.writeText(roomCode).then(() => {
                showSuccess(`Room code ${roomCode} copied to clipboard!`);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = roomCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess(`Room code ${roomCode} copied to clipboard!`);
            });
        }

        // Game Functions (simplified for demo)
        function startGame() {
            if (gameState.mode === 'room') {
                showError('Please use Create Room or Join Room for multiplayer games');
                return;
            }

            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                showError('Please enter a team name');
                return;
            }

            gameState.currentTeam = teamName;
            gameState.startTime = Date.now();
            gameState.isGameActive = true;
            gameState.completedSeals = [];

            // Show game screen
            document.getElementById('teamSetup').style.display = 'none';
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('currentTeam').textContent = teamName;
            document.getElementById('gameMode').textContent = gameState.mode === 'single' ? 'Single Group Mode' : 'vs Computer Teams';

            renderSeals();
            startTimer();
        }

        function renderSeals() {
            let html = '';
            
            seals.forEach(seal => {
                const completed = gameState.completedSeals.includes(seal.id);
                const canOpen = seal.unlock.every(req => gameState.completedSeals.includes(req));
                const locked = !canOpen && !completed;
                
                let statusClass = '';
                if (completed) statusClass = 'completed';
                else if (locked) statusClass = 'locked';
                
                html += `
                    <div class="seal ${statusClass}" onclick="${locked ? '' : `openSeal(${seal.id})`}">
                        <div class="seal-number">${seal.id}</div>
                        <div class="seal-title">${seal.title}</div>
                        <p>${seal.description}</p>
                        ${completed ? '<div style="color: #228b22; margin-top: 10px;">‚úÖ Completed</div>' : ''}
                        ${locked ? '<div style="color: #dc3545; margin-top: 10px;">üîí Locked</div>' : ''}
                    </div>
                `;
            });
            
            document.getElementById('sealsGrid').innerHTML = html;
            updateProgress();
        }

        function openSeal(sealId) {
            // Simplified - just complete the seal for demo
            if (!gameState.completedSeals.includes(sealId)) {
                gameState.completedSeals.push(sealId);
                showSuccess(`üéâ Seal ${sealId} completed!`);
                
                updateTeamProgress();
                renderSeals();
                
                // Check if all seals completed
                if (gameState.completedSeals.length === 7) {
                    finishGame();
                }
            }
        }

        function finishGame() {
            gameState.isGameActive = false;
            const completionTime = Date.now() - gameState.startTime;
            const timeStr = formatTime(completionTime);
            
            let message = `<h3>üèÜ Congratulations!</h3>`;
            message += `<p><strong>Completion Time: ${timeStr}</strong></p>`;
            
            updateTeamProgress();
            
            document.getElementById('victoryMessage').innerHTML = message;
            document.getElementById('finalChallenge').style.display = 'block';
        }

        function updateProgress() {
            const progress = (gameState.completedSeals.length / 7) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${gameState.completedSeals.length}/7 Seals Broken`;
        }

        function startTimer() {
            const timerElement = document.getElementById('timer');
            
            function updateTimer() {
                if (!gameState.isGameActive) return;
                
                const elapsed = Date.now() - gameState.startTime;
                timerElement.textContent = formatTime(elapsed);
                
                setTimeout(updateTimer, 1000);
            }
            
            updateTimer();
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset the game?')) {
                if (gameState.mode === 'room') {
                    leaveRoom();
                } else {
                    document.getElementById('gameScreen').classList.add('hidden');
                    document.getElementById('finalChallenge').style.display = 'none';
                    document.getElementById('modeSelection').style.display = 'grid';
                    document.getElementById('teamName').value = '';
                    resetGameState();
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });
    </script>
</body>
</html>
